<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[TaurusHome]]></title>
  <link href="http://agenge.github.io/atom.xml" rel="self"/>
  <link href="http://agenge.github.io/"/>
  <updated>2013-10-12T14:37:48+08:00</updated>
  <id>http://agenge.github.io/</id>
  <author>
    <name><![CDATA[agenge]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[LVS+Keepalived做Red5高可用和负载均衡]]></title>
    <link href="http://agenge.github.io/blog/2013/10/12/the-lvs-keepalived-do-red5-ha-lb/"/>
    <updated>2013-10-12T14:33:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/10/12/the-lvs-keepalived-do-red5-ha-lb</id>
    <content type="html"><![CDATA[<h2>前言</h2>

<p>此篇文章纯实践篇，只有部分关键配置会作解决，理论知识偶会专门写一篇来介绍。</p>

<ol>
<li>准备环境</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.30.136     lvs-dr_01 # LVS Director Master
</span><span class='line'>192.168.30.167     lvs-dr_02  # LVS Director Backup
</span><span class='line'>192.168.30.172     lvs-vip        # VIP  虚拟IP
</span><span class='line'>192.168.30.171     realserver-01  # 后端Red5 服务器
</span><span class='line'>192.168.30.150     realserver-02  # 后端Red5 服务器</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>安装依赖包</p></li>
<li><p>检查是否支持IPVS</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>modprobe -l | grep ipvs </span></code></pre></td></tr></table></div></figure>


<p>如果支持的话，会就输出以下类似信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kernel/net/netfilter/ipvs/ip_vs.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_rr.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_wrr.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_lc.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_wlc.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_lblc.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_lblcr.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_dh.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_sh.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_sed.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_nq.ko
</span><span class='line'>kernel/net/netfilter/ipvs/ip_vs_ftp.ko</span></code></pre></td></tr></table></div></figure>


<ol>
<li>安装ipvsadm
SSH到主节点 lvs-dr_01 和 lvs-dr_02</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum -y install ipvsadm</span></code></pre></td></tr></table></div></figure>


<ol>
<li>安装 Keepalived
以下分别是安装依赖包、下载keepalived-1.2.8、以配置文件：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install -y gcc kernel-devel openssl-devel popt-devel  make # 安装依赖包
</span><span class='line'>wget http://www.keepalived.org/software/keepalived-1.2.8.tar.gz
</span><span class='line'>tar zxvf keepalived-1.2.8.tar.gz 
</span><span class='line'>cd keepalived-1.2.8
</span><span class='line'>./configure --with-kernel-dir=/usr/src/kernels/2.6.32-358.18.1.el6.x86_64/
</span><span class='line'>make
</span><span class='line'>make install DIR=/usr/local/
</span><span class='line'>cp /usr/local/etc/rc.d/init.d/keepalived /etc/rc.d/init.d/
</span><span class='line'>cp /usr/local/etc/sysconfig/keepalived /etc/sysconfig/
</span><span class='line'>mkdir -p /etc/keepalived
</span><span class='line'>cp /usr/local/sbin/keepalived /usr/sbin/</span></code></pre></td></tr></table></div></figure>


<p>在 /usr/local/etc/keepalived/keepalived.conf 中加入以下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>! Configuration File for keepalived
</span><span class='line'>
</span><span class='line'>global_defs {
</span><span class='line'>   notification_email {
</span><span class='line'>     acassen@firewall.loc
</span><span class='line'>     failover@firewall.loc
</span><span class='line'>     sysadmin@firewall.loc   # 全局联系人
</span><span class='line'>   }
</span><span class='line'>   notification_email_from Alexandre.Cassen@firewall.loc
</span><span class='line'>   smtp_server 127.0.0.1
</span><span class='line'>   smtp_connect_timeout 30
</span><span class='line'>   router_id LVS_DEVEL
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>vrrp_instance VI_1 {
</span><span class='line'>    state MASTER      # keepalived MASTER，另外一台 lvs-dr_02 修改为：BACKUP
</span><span class='line'>    interface eth0        # 使用哪个网络接口来通信
</span><span class='line'>    virtual_router_id 52  # 默认为51，两个DR都修改成非51，这里修改成 52
</span><span class='line'>    priority 100      # 优先级，数字越大表示 优先级越高，MASTER一定要比BACKUP高
</span><span class='line'>    advert_int 1
</span><span class='line'>    authentication {
</span><span class='line'>        auth_type PASS        # 密码验证类型
</span><span class='line'>        auth_pass 1111        # MASTER与BACKUP之间的验证密码，两端必须保持一致。
</span><span class='line'>    }
</span><span class='line'>    virtual_ipaddress {
</span><span class='line'>        192.168.30.172   # 虚拟IP，即 VIP
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'># 虚拟服务器  需要填写自己 IP 和 端口
</span><span class='line'>virtual_server 192.168.30.172 1935 {
</span><span class='line'>    delay_loop 6          # 每隔 6 秒去检查 RealServer 的健康状态
</span><span class='line'>    lb_algo rr                #  LVS 的 rr(轮循)算法，LVS共 10种算法，如果需要修改就在此处。
</span><span class='line'>    lb_kind DR                # LVS DR模式(直接路由)，LVS共三种工作模式：VS/NAT、VS/TUN、VS/DR
</span><span class='line'>    persistence_timeout 50        # 同一IP的连接在60秒内分配到同一台 RealServer
</span><span class='line'>    protocol TCP          # 使用TCP协议来检查后台服务器(realserver)状态
</span><span class='line'>
</span><span class='line'>    real_server 192.168.30.171 1935 {     # 后端red5 IP地址与端口
</span><span class='line'>        weight 1                      # 权重
</span><span class='line'>        TCP_CHECK {
</span><span class='line'>            connect_timeout 3         # 3秒内无响应超时
</span><span class='line'>            nb_get_retry 3
</span><span class='line'>            delay_before_retry 3
</span><span class='line'>            connect_port 1935
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    real_server 192.168.30.150 1935 {     # 后端red5 IP地址与端口
</span><span class='line'>        weight 1
</span><span class='line'>        TCP_CHECK {
</span><span class='line'>            connect_timeout 3
</span><span class='line'>            nb_get_retry 3
</span><span class='line'>            delay_before_retry 3
</span><span class='line'>            connect_port 1935
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>同样，在两台 Director 都需要安装与配置，注意的是两台keepalived.conf的配置所有不同。</p>

<ol>
<li>设置Real Server
以下操作如果没有特别说明，将针对 <strong>所有Real Server</strong>
将以下内容添加到 /root/realserver.sh</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>SNS_VIP=192.168.30.172
</span><span class='line'>/etc/rc.d/init.d/functions
</span><span class='line'>case "$1" in
</span><span class='line'>start)
</span><span class='line'>       /sbin/ifconfig lo:0 $SNS_VIP netmask 255.255.255.255 broadcast $SNS_VIP
</span><span class='line'>       /sbin/route add -host $SNS_VIP dev lo:0
</span><span class='line'>       echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore
</span><span class='line'>       echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce
</span><span class='line'>       echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore
</span><span class='line'>       echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce
</span><span class='line'>       sysctl -p &gt;/dev/null 2&gt;&1
</span><span class='line'>       echo "RealServer Start OK"
</span><span class='line'>       ;;
</span><span class='line'>stop)
</span><span class='line'>       /sbin/ifconfig lo:0 down
</span><span class='line'>       /sbin/route del $SNS_VIP &gt;/dev/null 2&gt;&1
</span><span class='line'>       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore
</span><span class='line'>       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce
</span><span class='line'>       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore
</span><span class='line'>       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_announce
</span><span class='line'>       echo "RealServer Stoped"
</span><span class='line'>       ;;
</span><span class='line'>*)
</span><span class='line'>       echo "Usage: $0 {start|stop}"
</span><span class='line'>       exit 1
</span><span class='line'>esac
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>添加执行权限
chmod +x /root/realserver.sh</p>

<p>启动及添加到开机自启动</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/root/realserver.sh start
</span><span class='line'>echo "/root/realserver.sh start" &gt;&gt; /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<ol>
<li>测试
首先依次启动 lvs-dr_01 和 lvs-dr_02 的keepalived服务：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/init.d/keepalived restart</span></code></pre></td></tr></table></div></figure>


<p>检查LVS路由和连接</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ipvsadm -Ln
</span><span class='line'>
</span><span class='line'>IP Virtual Server version 1.2.1 (size=4096)
</span><span class='line'>Prot LocalAddress:Port Scheduler Flags
</span><span class='line'>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span><span class='line'>TCP  192.168.30.172:1935 rr persistent 50
</span><span class='line'>  -&gt; 192.168.30.150:1935          Route   1      2          0         
</span><span class='line'>  -&gt; 192.168.30.171:1935          Route   1      0          0         </span></code></pre></td></tr></table></div></figure>


<p>可以看到 realserver-01:1935 和 realserver-02:1935 已经加入到LVS。</p>

<p>通过RTMP客户端不断访问，可以看到2台 RealServer 都有活动的链接：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IP Virtual Server version 1.2.1 (size=4096)
</span><span class='line'>Prot LocalAddress:Port Scheduler Flags
</span><span class='line'>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span><span class='line'>TCP  192.168.30.172:1935 rr persistent 50
</span><span class='line'>  -&gt; 192.168.30.150:1935          Route   1      1          0         
</span><span class='line'>  -&gt; 192.168.30.171:1935          Route   1      1          0         </span></code></pre></td></tr></table></div></figure>


<ol>
<li>常见错误
ip address associated with VRID not present in received packet
这个错误主要原因是 在同一网段内virtual_router_id 值不能相同，如果相同会在messages中收到VRRP错误包，所以需要更改 virual_router_id，但如果只改一个，就等于是2个相对独立的集群，所以virual_router_id改成非51的相同值即可，例如都改成 52.</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[octopress个性化定制]]></title>
    <link href="http://agenge.github.io/blog/2013/10/10/octopress-personalization-customization/"/>
    <updated>2013-10-10T13:39:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/10/10/octopress-personalization-customization</id>
    <content type="html"><![CDATA[<h2>设置导航栏</h2>

<p>编辑octopress\source_includes\custom\navigation.html, 并加入以下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;ul class="main-navigation"&gt;
</span><span class='line'>  &lt;li&gt;&lt;a href="http://agenge.github.io/"&gt;首页&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>  &lt;li&gt;&lt;a href="http://agenge.github.io/blog/archives"&gt;归档&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>    &lt;li&gt;&lt;a href="http://agenge.github.io/about"&gt;关于我&lt;/a&gt;&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;</span></code></pre></td></tr></table></div></figure>


<h2>添加 &ldquo;关于我&#8221;导航页</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake new_page['about']
</span><span class='line'>mkdir -p source/about
</span><span class='line'>Creating new page: source/about/index.markdown</span></code></pre></td></tr></table></div></figure>


<h2>侧边栏文章分类</h2>

<p>创建文件：octopress\plugins\category_list_tab.rb，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module Jekyll 
</span><span class='line'>  class CategoryListTag &lt; Liquid::Tag 
</span><span class='line'>    def render(context) 
</span><span class='line'>      html = "" 
</span><span class='line'>      categories = context.registers[:site].categories.keys 
</span><span class='line'>      categories.sort.each do |category| 
</span><span class='line'>        posts_in_category = context.registers[:site].categories[category].size 
</span><span class='line'>        category_dir = context.registers[:site].config['category_dir'] 
</span><span class='line'>        category_url = File.join(category_dir, category.gsub(/_|\P{Word}/, '-').gsub(/-{2,}/, '-').downcase) 
</span><span class='line'>        html &lt;&lt; "&lt;li class='category'&gt;&lt;a href='http://agenge.github.io/#{category_url}/'&gt;#{category} (#{posts_in_category})&lt;/a&gt;&lt;/li&gt;\n" 
</span><span class='line'>      end 
</span><span class='line'>      html 
</span><span class='line'>    end 
</span><span class='line'>  end 
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>Liquid::Template.register_tag('category_list', Jekyll::CategoryListTag)</span></code></pre></td></tr></table></div></figure>


<p>新建文件 octopress\source_includes\custom\category_list.html,并添加以下内容(由于偶本地生成一直报错，请注意在使用的时候去掉反斜扛)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;section&gt; 
</span><span class='line'>  &lt;h1&gt;文章分类&lt;/h1&gt; 
</span><span class='line'>  &lt;ul id="categories"&gt; 
</span><span class='line'>    {\% category_list \%} 
</span><span class='line'>  &lt;/ul&gt; 
</span><span class='line'>&lt;/section&gt;</span></code></pre></td></tr></table></div></figure>


<p>修改 _config.yml文件 ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>default_asides: [asides/recent_posts.html, asides/category_list.html, asides/github.html, asides/delicious.html, asides/pinboard.html, asides/googleplus.html]</span></code></pre></td></tr></table></div></figure>


<p>修改octopress\source_includes\asides\recent_posts.html</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;h1&gt;Recent Posts&lt;/h1&gt;</span></code></pre></td></tr></table></div></figure>


<p>修改为</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;h1&gt;最新文章&lt;/h1&gt;</span></code></pre></td></tr></table></div></figure>


<h2>显示 文章以摘要形式展示</h2>

<p>在markdown文件需要显示的地址添加 <!-- more -->，在发布文章后就会显示 Read On链接。
如果想将Read On显示为：阅读全文，请修改_config.yml,将</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>excerpt_link: "Read on &rarr;" </span></code></pre></td></tr></table></div></figure>


<p>修改为</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>excerpt_link: "阅读全文 &rarr;" </span></code></pre></td></tr></table></div></figure>


<h2>添加版权声明</h2>

<p>在 source_includes\post 目录下创建一个文件：license.html，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;DIV style="font-size:12px;BORDER-BOTTOM: #bbbbbb 1px solid; BORDER-LEFT: #bbbbbb 1px solid; BACKGROUND: #f6f6f6; HEIGHT: 120px; BORDER-TOP: #bbbbbb 1px solid; BORDER-RIGHT: #bbbbbb 1px solid" class=oec2003right&gt;
</span><span class='line'>&lt;DIV style="MARGIN-TOP: 10px; FLOAT: left; MARGIN-LEFT: 5px; MARGIN-RIGHT: 10px"&gt;&lt;/DIV&gt;
</span><span class='line'>&lt;DIV style="LINE-HEIGHT: 200%; MARGIN-TOP: 10px; COLOR: #000000"&gt;
</span><span class='line'>作者： &lt;A href="http://agenge.com"&gt;agenge&lt;/A&gt; &lt;BR&gt;
</span><span class='line'>出处： &lt;A href="http://agenge.com"&gt;http://agenge.com&lt;/A&gt; 
</span><span class='line'>&lt;BR&gt;本博客所有的原创文章，作者皆保留版权。转载必须包含本声明，保持本文完整，并以超链接形式注明作者
</span><span class='line'>&lt;a href=mailto:huanggeng.8552@gmail.com&gt; agenge &lt;/a&gt;。 &lt;/DIV&gt;&lt;/DIV&gt;
</span><span class='line'>
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<p>在sass\custom_styles.scss  添加样式，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.oec2003right
</span><span class='line'>{
</span><span class='line'>    background: #C3D9FF;
</span><span class='line'>    height:120px;
</span><span class='line'>    border:1px solid #BBBBBB;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>.oec2003right a:link 
</span><span class='line'>{
</span><span class='line'>    color: #0057b6;
</span><span class='line'>    text-decoration: none;
</span><span class='line'>}
</span><span class='line'>.oec2003right a:visited 
</span><span class='line'>{
</span><span class='line'>    color: #0057b6;
</span><span class='line'>    text-decoration: none;
</span><span class='line'>}
</span><span class='line'>.oec2003right a:active,a:hover
</span><span class='line'>{
</span><span class='line'>    color: #0057b6;
</span><span class='line'>    text-decoration: underline;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>修改 source_layouts\post.html, 在第14行(由于偶本地生成一直报错，请注意在使用的时候去掉反斜扛)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Include file 'post\/categories.html' contains invalid characters or sequences</span></code></pre></td></tr></table></div></figure>


<p>这行之后, 添加(由于偶本地生成一直报错，请注意在使用的时候去掉反斜扛)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Include file 'post\/license.html' contains invalid characters or sequences</span></code></pre></td></tr></table></div></figure>


<p>在_config.yml最后一行添加以下内容，意思为控制是否显示页面的版权信息,True为显示</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>post_license: true</span></code></pre></td></tr></table></div></figure>


<p>效果如下：</p>

<DIV style="font-size:12px;BORDER-BOTTOM: #bbbbbb 1px solid; BORDER-LEFT: #bbbbbb 1px solid; BACKGROUND: #f6f6f6; HEIGHT: 120px; BORDER-TOP: #bbbbbb 1px solid; BORDER-RIGHT: #bbbbbb 1px solid" class=oec2003right>
<DIV style="MARGIN-TOP: 10px; FLOAT: left; MARGIN-LEFT: 5px; MARGIN-RIGHT: 10px"></DIV>
<DIV style="LINE-HEIGHT: 200%; MARGIN-TOP: 10px; COLOR: #000000">
作者： <A href="http://agenge.com">agenge</A> <BR>
出处： <A href="http://agenge.com">http://agenge.com</A> 
<BR>本博客所有的原创文章，作者皆保留版权。转载必须包含本声明，保持本文完整，并以超链接形式注明作者
<a href=mailto:huanggeng.8552@gmail.com> agenge </a></DIV></DIV>


<h2>域名设置</h2>

<p>域名服务商设置</p>

<p>主机名    记录类型   地址
空     A记录     207.97.227.245
www     CNAME       agenge.github.com</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "agenge.com" &gt;&gt; source/CNAME</span></code></pre></td></tr></table></div></figure>


<hr />

<p>以上主要是 agenge.com 这个Blog的常见设置，如果你觉得设置很麻烦，请直接git源代码吧: github.com/agenge.github.com</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[redis安装与配置]]></title>
    <link href="http://agenge.github.io/blog/2013/10/08/redis-install-and-config/"/>
    <updated>2013-10-08T20:05:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/10/08/redis-install-and-config</id>
    <content type="html"><![CDATA[<h2>安装环境</h2>

<ul>
<li>操作系统：CentOS 6.3 64位</li>
<li>Redis：最新版本 2.6.14</li>
</ul>


<h2>Redis安装</h2>

<ol>
<li>下载Redis</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum -y install make gcc
</span><span class='line'>wget http://download.redis.io/redis-stable.tar.gz
</span><span class='line'>tar zxvf redis-stable.tar.gz
</span><span class='line'>cd redis-stable
</span><span class='line'>make
</span><span class='line'>make install</span></code></pre></td></tr></table></div></figure>


<p> 这样即完成redis的安装,整个安装是否超级简单,至少偶认为不复杂。</p>

<ol>
<li><p>启动和停止Redis
在Linux系统中，启动与停止服务也是非常简单，Redis主要提供以下几个可执行程序：</p></li>
<li><p>redis-server     看名称就明白：Redis服务器</p></li>
<li>redis-cli        Redis命令行客户端</li>
<li>redis-benchmark  Redis性能测试工具</li>
<li>redis-check-aof  AOF文件修复工具</li>
<li>redis-check-dump RDB文件检查工具</li>
</ol>


<p> <strong> 启动Redis </strong></p>

<p> 启动redis,直接在命令行输入：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redis-server</span></code></pre></td></tr></table></div></figure>


<p> 如果启动正常，就会输出以下类似信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2935] 08 Oct 20:29:05.156 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
</span><span class='line'>[2935] 08 Oct 20:29:05.158 * Max number of open files set to 10032
</span><span class='line'>             _._                                                  
</span><span class='line'>        _.-``__ ''-._                                             
</span><span class='line'>   _.-``    `.  `_.  ''-._           Redis 2.6.14 (00000000/0) 64 bit
</span><span class='line'>  .-`` .-```.  ```\/    _.,_ ''-._                                   
</span><span class='line'> (    '      ,       .-`  | `,    )     Running in stand alone mode
</span><span class='line'> |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379
</span><span class='line'> |    `-._   `._    /     _.-'    |     PID: 2935
</span><span class='line'>  `-._    `-._  `-./  _.-'    _.-'                                   
</span><span class='line'> |`-._`-._    `-.__.-'    _.-'_.-'|                                  
</span><span class='line'> |    `-._`-._        _.-'_.-'    |           http://redis.io        
</span><span class='line'>  `-._    `-._`-.__.-'_.-'    _.-'                                   
</span><span class='line'> |`-._`-._    `-.__.-'    _.-'_.-'|                                  
</span><span class='line'> |    `-._`-._        _.-'_.-'    |                                  
</span><span class='line'>  `-._    `-._`-.__.-'_.-'    _.-'                                   
</span><span class='line'>   `-._    `-.__.-'    _.-'                                       
</span><span class='line'>       `-._        _.-'                                           
</span><span class='line'>           `-.__.-'                                               
</span><span class='line'>[2935] 08 Oct 20:29:05.159 # Server started, Redis version 2.6.14
</span><span class='line'>[2935] 08 Oct 20:29:05.159 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
</span><span class='line'>[2935] 08 Oct 20:29:05.159 * The server is now ready to accept connections on port 6379</span></code></pre></td></tr></table></div></figure>


<p> 从输出信息可以看出redis已经启动成功，默认监听的6379端口。不过我们还有更好的办法来启动redis-server，Redis默认已经为我们提供一个系统启动脚本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp utils/redis_init_script /etc/init.d/redis_server_6379
</span><span class='line'>chmod +x /etc/init.d/redis_server_6379
</span><span class='line'>mkdir /etc/redis
</span><span class='line'>cp redis.conf /etc/redis/6379.conf
</span><span class='line'>echo "vm.overcommit_memory = 1" &gt;&gt; /etc/sysctl.conf
</span><span class='line'>/etc/init.d/redis_server_6379 start</span></code></pre></td></tr></table></div></figure>


<p> <strong> 关闭Redis </strong>
 相对启动来讲，关闭redis就更为简单，只需要输入：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redis-cli SHUTDOWN</span></code></pre></td></tr></table></div></figure>


<p> 此命令输入完成后，首先会断开所有客户端的连接，然后根本配置进行持久化，如果关闭正常，就会输出以下类似信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2989] 08 Oct 20:46:08.156 # User requested shutdown...
</span><span class='line'>[2989] 08 Oct 20:46:08.156 * Saving the final RDB snapshot before exiting.
</span><span class='line'>[2989] 08 Oct 20:46:08.175 * DB saved on disk
</span><span class='line'>[2989] 08 Oct 20:46:08.175 # Redis is now ready to exit, bye bye...</span></code></pre></td></tr></table></div></figure>


<hr />

<h2>Redis 命令行客户端</h2>

<p>前面已经介绍过redis-cli这个工具，通过redis-cli向 Redis服务端发送命令有两种方式：</p>

<ul>
<li>将要发送的命令作为 redis-cli 的参数，例如之前介绍过的  redis-cli SHUTDOWN, 此处的SHUTDOWN即是发送命令，也是一个参数。</li>
<li>直接进入 redis-cli 交互式命令行执行命令，例如：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redis-cli
</span><span class='line'>redis 127.0.0.1:6379&gt; ping
</span><span class='line'>PONG</span></code></pre></td></tr></table></div></figure>


<p> 其中“redis 127.0.0.1:6379>” 是redis-cli的命令提示符，类似Mysql中的“mysql> ” ，ping是Redis内置的命令，用来测试是否与服务器连接正常。</p>

<h2>Redis多数据库</h2>

<p>和Mysql一样，Redis也是支持在同一台服务器启动多个redis server，之前已经有过介绍，在启动redis时，用到/etc/redis/6379.conf 这个配置文件，下面就来介绍如何在一台服务器启动多个redis数据库</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /etc/redis/
</span><span class='line'>cp 6379.conf 6380.conf </span></code></pre></td></tr></table></div></figure>


<p>修改6380.conf 以下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pidfile /var/run/redis_6380.pid
</span><span class='line'>port 6380</span></code></pre></td></tr></table></div></figure>


<p>保存退出，修改启动服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp /etc/init.d/redis_server_6379 /etc/init.d/redis_server_6380</span></code></pre></td></tr></table></div></figure>


<p>将 REDISPORT=6379  修改为 REDISPORT=6380</p>

<p>启动redis server</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/init.d/redis_server_6379 start
</span><span class='line'>/etc/init.d/redis_server_6380 start</span></code></pre></td></tr></table></div></figure>


<p>上面代表将启动两个redis 数据库，分别监听6379和6380端口。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[利用GitHub搭建免费的个人blog]]></title>
    <link href="http://agenge.github.io/blog/2013/09/12/write-blog-octopress-with-github/"/>
    <updated>2013-09-12T22:18:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/09/12/write-blog-octopress-with-github</id>
    <content type="html"><![CDATA[<h1>前言</h1>

<h2>为啥写篇文章</h2>

<ol>
<li><p>熟悉WordPress的或许都明白，为了写作，你要学习很多东西，例如Linux、Apache/Nginx、Mysql以及各种中间件；</p></li>
<li><p>你要花钱买VPS/虚拟主机，你要自己优化Web Server和Mysql，你要定期备份Mysql；</p></li>
<li><p>WordPress官方已经被墙（对于合格的IT屌丝，这点不是问题）；</p></li>
</ol>


<p>你可能已经在心理产生疑问：“你说这么多费话，无非就是想让我放弃WP，难道你有解决上述问题的完美方案？”
虽不敢说完美解决，但至少有这么一个blog平台：</p>

<ul>
<li>无须数据库</li>
<li>无须Web Server</li>
<li>无须备份且数据永不丢失（相对自己备份而言）</li>
<li>所有操作均有版本记录</li>
</ul>


<p>看了之后是不是很“鸡动”？没错，这个平台就是Github，结合jekyll/Octopress就完全可以专心写作，
不过相对WP，功能确实要少些，图片和视频功能实在太弱。</p>

<h2>Jekyll/Octopress是啥</h2>

<p>Jekyll即是一个轻量级Blog系统，而且还是一个强大的静态网站生成系统，具体的介绍请参考以下链接：</p>

<p>1、<a href="http://calefy.org/2012/03/03/my-process-of-building-jekyll-blog.html">Jekyll建站之旅</a></p>

<p>2、<a href="http://www.cnblogs.com/purediy/archive/2013/03/07/2948892.html">通过GitHub Pages建立个人站点（详细步骤）</a></p>

<p>3、<a href="http://ztpala.com/2011/09/12/jekyll-and-github-pages/">Jekyll介绍</a></p>

<p>Octopress其实就是一个基于Jekyll实现的静态网站系统，具体介绍如下（引用）：</p>

<ul>
<li><p>使用 Markdown 标记语言书写源文件， 通过 Markdown 解析器转换为 HTML 文件</p></li>
<li><p>通过 Octopress 提供的站点模板提供所需的 Web 资产文件 （Javascript、CSS、image 等）</p></li>
<li><p>只包含静态网页，无需数据库支持，对系统要求低且迁移方便</p></li>
<li><p>以编写程序的方式编制网站，便于实现版本控制</p></li>
<li><p>Octopress / Jekyll 使用简洁的Ruby框架实现。</p>

<ul>
<li><p>Octopress 以 rake 任务的形式实现静态站点页面生成, 操作十分简单</p></li>
<li><p>Octopress 以 rake 任务的形式实现到普通网站和 Github 的发布</p></li>
<li><p>Octopress 与 Github 完美结合，你无需学习过多的 git 命令语法，使非专业人士的使用成为可能</p></li>
</ul>
</li>
</ul>


<!-- more -->


<h1>准备工具</h1>

<p>说一堆费话，现在说说要准备些什么工具</p>

<ol>
<li><p>Git for Windows(如果你是Linux/Mac就更方便，不过这篇文章主要是为了Windows下的用户)</p>

<p> 猛撮 <a href="https://code.google.com/p/msysgit/downloads/list">下载Git</a> 下最新版本。
偶是下载的 Git-1.8.3-preview20130601.exe</p></li>
<li><p>安装Ruby环境</p>

<p> 猛撮 <a href="https://rubyforge.org/frs/?group_id=167">下载RubyInstaller</a></p>

<ul>
<li>如果你是Octopress，请下载 rubyinstaller-1.9.2-p290</li>
<li>如果你是Jekyll，请下载 rubyinstaller-1.9.1-p430</li>
</ul>
</li>
</ol>


<p> 安装之后确保C:\Ruby193\bin 在系统的环境变量中。</p>

<ol>
<li>安装DevKit</li>
</ol>


<p>  ruby 的模块工具 gem 在生成本地模块时可能需要用到编译环境，通常有2种选择：</p>

<p> <a href="http://www.mingw.org/">MinGW and MSYS</a> 或 <a href="https://github.com/oneclick/rubyinstaller/wiki/development-kit">RubyInstaller DevKit</a></p>

<p> 偶是使用的 DevKit-tdm-32-4.5.2-20111229-1559-sfx.exe
 , 在”Start Command Prompt with Ruby”命令行中进入DevKit解压缩的目录：</p>

<pre><code>    ruby dk.rb init 

    ruby dk.rb install
    gem install rdiscount --platform=ruby
</code></pre>

<p> 如果没问题，会提示如下信息：</p>

<pre><code>    Fetching: rdiscount-2.1.6.gem (100%)
    Temporarily enhancing PATH to include DevKit...
    Building native extensions.  This could take a while...
    Successfully installed rdiscount-2.1.6
    1 gem installed
    Installing ri documentation for rdiscount-2.1.6...
    Installing RDoc documentation for rdiscount-2.1.6...
</code></pre>

<ol>
<li>安装Python for Windows</li>
</ol>


<p> 最后还要安装Python，相对Ruby环境，安装Python就简单许多，下载python-2.7.5.amd64.msi即可。</p>

<ol>
<li>配置环境变量
环境变量需要在两个地址设置： Windows系统与Git Bash</li>
<li><p>在你的Windows系统创建两个新的环境变量</p>

<ul>
<li>LANG 环境变量，值设置为：zh_CN.UTF-8</li>
<li>LC_ALL 环境变量，值设置为: zh_CN.UTF-8</li>
</ul>
</li>
<li><p>打开Git Bash</p>

<ul>
<li><code>$ echo "export LANG LC_ALL" &gt; ~/.bash_profile</code></li>
<li><code>$ echo "alias ll='ls -l --color=tty'" &gt;&gt; ~/.bash_profile</code></li>
<li><code>$ echo "alias ls='ls --color=tty'" &gt;&gt; ~/.bash_profile</code></li>
</ul>
</li>
<li><p>准备一个文本编辑器，只要能保存UTF-8无BOM格式的即可，例如UltraEdit.</p></li>
<li><p>设置无密码登录github</p>

<pre><code> ssh-keygen -C "username@email.com" -t rsa
</code></pre></li>
</ol>


<p> username@email.com换成你的github注册时的邮箱。</p>

<ul>
<li>创建成功后，在你的C:\Users\%username%.ssh 目录会生成一个 id_rsa.pub公钥文件。</li>
<li>登录github.com（如果没有就注册一个），在“Account Settings”->“SSH Keys”，点击右侧的“Add SSH Key”。</li>
<li><p>将id_rsa.pub文件中的内容复制到“Key”中并保存。</p></li>
<li><p>测试：</p>

<pre><code> ssh -T git@github.com
</code></pre></li>
</ul>


<p> 如果没有任何问题，提示如下：</p>

<pre><code>    Hi agenge! You've successfully authenticated, but GitHub does not provide shell access.
</code></pre>

<h1>初始化Ruby环境</h1>

<h2>gem源的问题</h2>

<p>作为天朝的屌丝，有时候你总得多墙外的人多做些工作，gem的更新源也要墙？还好还好，国内有良心的企业还是有的（虽然不多），对于gem源，直接使用淘宝的吧。</p>

<pre><code>gem sources --remove https://rubygems.org/
gem sources -a http://ruby.taobao.org
</code></pre>

<p>如果你觉得不放心，还可以确认是否设置正确：</p>

<pre><code>gem sources -l
</code></pre>

<h2>安装bundler(必须) 和 rdoc(非必须)</h2>

<pre><code>gem install bundler rdoc
bundle install
</code></pre>

<h1>安装Octopress</h1>

<pre><code>git clone git://github.com/imathis/octopress.git octopress
cd octopress
rake install
</code></pre>

<h1>配置Octopress</h1>

<h2>修改_config.yml</h2>

<p>你可以根据这个文件你的以下信息：</p>

<ul>
<li>title: 网站名称</li>
<li>subtitle: 网站子名称</li>
<li>author: 作者名称</li>
</ul>


<p>除了这3个以外，把Twitter相关全部注释，更多的选项你可以看下注释或Google搜索。</p>

<h2>发表文章</h2>

<p>激动人心的时刻即将到来，终于到了发表文章的这一天，octopress居然把写作与发表文件变得如此简单。</p>

<pre><code>rake new_post[“tile”]  # 创建一个新文章
</code></pre>

<p>执行这条命令之后，会在octopress\source_posts目录下生成一个&#8221;YYYY-MM-DD-title.markdown&#8221;的文件</p>

<p>在生成静态页面之前，我们需要解决Windows下中文编码的问题，有两个地方需要注意：</p>

<ol>
<li>.markdown文件有中文的话必须保存：UTF-8无BOM</li>
<li><p>编辑C:\Ruby193\lib\ruby\gems\1.9.1\gems\jekyll-0.12.0\lib\jekyll\convertible.rb第28行，修改为：</p>

<p> self.content = File.read(File.join(base, name), :encoding => &lsquo;utf-8&rsquo;)</p></li>
</ol>


<p>生成静态页面</p>

<pre><code>rake generate           # 生成新的静态页面
</code></pre>

<p>在本地预览文章效果：</p>

<pre><code>rake preview
</code></pre>

<p> 如果成功的话，访问: <a href="http://localhost:4000">http://localhost:4000</a> 就能看到效果。</p>

<h1>设置本地仓库与远程仓库关联</h1>

<ul>
<li><p>创建git账号与仓库</p>

<ul>
<li>用户名：username</li>
<li>仓库名：username.github.com</li>
</ul>
</li>
<li><p>关联github仓库</p>

<ul>
<li>rake setup_github_pages</li>
</ul>
</li>
</ul>


<p>提示输入远程仓库地址，请输入：</p>

<pre><code>git@github.com:username/username.github.com.git
</code></pre>

<p>表示将blog与 username.github.com仓库关联.</p>

<h2>部署Blog到Github</h2>

<pre><code>rake deploy
</code></pre>

<p>这条命令表示发布文件到github。</p>

<h2>将Octopress源文件推送到 Github的 source 分支</h2>

<pre><code>git add .
git commit -m “comment”
git push origin source
</code></pre>

<h2>访问Blog</h2>

<p>打开浏览器输入：username.github.com</p>

<p>如果一切正常，就能看到你的文章。</p>

<h1>rake常用命令</h1>

<pre><code>$ rake -T
rake clean                     # Clean out caches: .pygments-cache, .gist-c...
rake copydot[source,dest]      # copy dot files for deployment
rake deploy                    # Default deploy task
rake gen_deploy                # Generate website and deploy
rake generate                  # Generate jekyll site
rake install[theme]            # Initial setup for Octopress: copies the de...
rake integrate                 # Move all stashed posts back into the posts...
rake isolate[filename]         # Move all other posts than the one currentl...
rake list                      # list tasks
rake new_page[filename]        # Create a new page in source/(filename)/ind...
rake new_post[title]           # Begin a new post in source/_posts
rake preview                   # preview the site in a web browser
rake push                      # deploy public directory to github pages
rake rsync                     # Deploy website via rsync
rake set_root_dir[dir]         # Update configurations to support publishin...
rake setup_github_pages[repo]  # Set up _deploy folder and deploy branch fo...
rake update_source[theme]      # Move source to source.old, install source ...
rake update_style[theme]       # Move sass to sass.old, install sass theme ...
rake watch                     # Watch the site and regenerate when it changes
</code></pre>

<p>Edit By <a href="http://agenge.github.com">agenge</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DRBD+Heartbeat+Mysql高可用配置]]></title>
    <link href="http://agenge.github.io/blog/2013/08/09/drbd_heartbeat_mysql_ha/"/>
    <updated>2013-08-09T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/08/09/drbd_heartbeat_mysql_ha</id>
    <content type="html"><![CDATA[<h2>介绍</h2>

<p>DRBD全称Distributed Replicated Block （分布式的复制块设备），属于Device公司，但是完全开源。它是一款基于块设备的文件复制解决方案，速度比文件级别的软件如NFS，samba快很多，是很多中小企业的共享存储首选解决方案。</p>

<p>DRBD工作需要在两个节点上同时准备一块一模一样的分区组成镜像，这就是为什么它叫做分布式复制块设备，它主要通过复制数据来实现文件同步（备份），主要用于集群文件共享， 我们通过它的工作原理来了解块复制和文件复制的不同。</p>

<p>首先，您需要知道，DRBD是工作在系统内核空间，而不是用户空间，它直接复制的是二进制数据，这是它速度快的根本原因。其次，DRBD至少需要两个节点来工作，一主一次。</p>

<p>DRBD的文件同步过程和普通复制过程的不同：</p>

<p>DRBD在数据进入Buffer Cache时，先经过DRBD这一层，复制一份数据经过TCP/IP协议封装，发送到另一个节点上，另一个节点通过TCP/IP协议来接受复制过来的数据，同步到次节点的DRBD设备上。</p>

<h2>准备工作</h2>

<p>1  准备至少2台服务器，且每台服务器有一块磁盘或一个单独未使用的分区，偶的环境如下：</p>

<table class="table table-bordered table-striped table-condensed">
    <tr>
        <td valign="top" width="180"></td>
        <td valign="top" width="182">主节点(Primary Node)</td>
        <td valign="top" width="183">次节点(Secondary Node)</td>
    </tr>
    <tr>
        <td valign="top" width="180">主机名</td>
        <td valign="top" width="182">drbd-01.i.12582.com</td>
        <td valign="top" width="183">drbd-02.i.12582.com</td>
    </tr>
    <tr>
        <td valign="top" width="180">操作系统</td>
        <td valign="top" width="182">CentOS 6.3 x86_64位</td>
        <td valign="top" width="183">CentOS 6.3 x86_64位</td>
    </tr>
    <tr>
        <td valign="top" width="180">硬盘分区</td>
        <td valign="top" width="182">/dev/sdb  8G</td>
        <td valign="top" width="183">/dev/sdb  8G</td>
    </tr>
    <tr>
        <td valign="top" width="180">IP地址</td>
        <td valign="top" width="182">192.168.30.234</td>
        <td valign="top" width="183">192.168.30.235</td>
    </tr>
</table>


<p>注意：如果有服务器有2块或以上网卡的同学，建议将其中一块网卡专门用来做网络心跳线，甚至接入另外一台单独的交换机，本次环境只有单网卡。</p>

<!--more-->


<h2>初始化设置</h2>

<p>1  所有节点关闭iptables和SELinux</p>

<p>2  在所有节点/etc/hosts加入以下内容：</p>

<pre><code>192.168.30.234  drbd-01.i.12582.com drbd-01
192.168.30.235  drbd-02.i.12582.com drbd-02
</code></pre>

<p>3  所有节点创建独立分区：</p>

<pre><code>fdisk /dev/sdbDevice contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabelBuilding a new DOS disklabel with disk identifier 0x46b64833.Changes will remain in memory only, until you decide to write them.
After that, of course, the previous content won't be recoverable.
Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)
WARNING: DOS-compatible mode is deprecated. It's strongly recommended to
switch off the mode (command 'c') and change display units to
sectors (command 'u').

Command (m for help): p
Disk /dev/sdb: 8589 MB, 8589934592 bytes
255 heads, 63 sectors/track, 1044 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x46b64833

Device Boot    Start        End        Blocks    Id    System

Command (m for help): n
Command action
e   extended
p   primary partition (1-4)
p
Partition number (1-4): 1
First cylinder (1-1044, default 1):
Using default value 1
Last cylinder, +cylinders or +size{K,M,G} (1-1044, default 1044):
Using default value 1044

Command (m for help): w
The partition table has been altered!
Calling ioctl() to re-read partition table.
Syncing disks.
</code></pre>

<h2>安装Hearbeat</h2>

<pre><code>wget ftp://mirror.switch.ch/pool/1/mirror/scientificlinux/6rolling/i386/os/Packages/epel-release-6-5.noarch.rpm
rpm -ivUh epel-release-6-5.noarch.rpm
yum --enablerepo=epel install heartbeat -y
</code></pre>

<h2>安装DRBD</h2>

<p>1  安装依赖包</p>

<pre><code>yum -y install gcc kernel-devel kernel-headers flex
</code></pre>

<p>2  安装DRBD</p>

<pre><code>wget http://oss.linbit.com/drbd/8.4/drbd-8.4.3.tar.gz
tar zxvf drbd-8.4.3.tar.gz
cd drbd-8.4.3
./configure --prefix=/usr/local/drbd --with-km --with-heartbeat
make KDIR=/usr/src/kernels/2.6.32-279.el6.x86_64/
make install
cp -R /usr/local/drbd/etc/ha.d/resource.d/drbd* /etc/ha.d/resource.d/
</code></pre>

<p>3  其他设置</p>

<pre><code>mkdir -p /usr/local/drbd/var/run/drbd
cp /usr/local/drbd/etc/rc.d/init.d/drbd /etc/rc.d/init.d/
chkconfig --add drbdchkconfig drbd on
</code></pre>

<h2>安装DRBD模块</h2>

<pre><code>cd drbdmake 
clean
make KDIR=/usr/src/kernels/2.6.32-279.el6.x86_64/
cp drbd.ko /lib/modules/`uname -r`/kernel/lib/
depmod
</code></pre>

<p>以上操作请在所有节点操作一次。</p>

<hr />

<h2>设置DRBD</h2>

<p><strong>配置drbd.conf</strong></p>

<pre><code>cat /usr/local/drbd/etc/drbd.d/global_common.conf
global {
    minor-count 64;
    usage-count yes;
    # minor-count dialog-refresh disable-ip-verification
}


common {
    syncer { rate 1000M; }
    handlers {
        # These are EXAMPLE handlers only.
        # They may have severe implications,
        # like hard resetting the node under certain circumstances.
        # Be careful when chosing your poison.

        pri-on-incon-degr "/usr/lib/drbd/notify-pri-on-incon-degr.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &amp;gt; /proc/sysrq-trigger ; reboot -f";
        pri-lost-after-sb "/usr/lib/drbd/notify-pri-lost-after-sb.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &amp;gt; /proc/sysrq-trigger ; reboot -f";
        local-io-error "/usr/lib/drbd/notify-io-error.sh; /usr/lib/drbd/notify-emergency-shutdown.sh; echo o &amp;gt; /proc/sysrq-trigger ; halt -f";
        fence-peer "/usr/lib/drbd/crm-fence-peer.sh";
        pri-lost "/usr/local/drbd/lib/drbd/notify-pri-lost.sh; /usr/local/drbd/lib/drbd/notify-emergency-reboot.sh; echo b &amp;gt;/proc/sysrq-trigger ; reboot -f";
        split-brain "/usr/lib/drbd/notify-split-brain.sh root";
        out-of-sync "/usr/lib/drbd/notify-out-of-sync.sh root";
        # before-resync-target "/usr/lib/drbd/snapshot-resync-target-lvm.sh -p 15 -- -c 16k";
        # after-resync-target /usr/lib/drbd/unsnapshot-resync-target-lvm.sh;
    }

    startup {

        # wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb
        wfc-timeout 60;
        degr-wfc-timeout 120;
        outdated-wfc-timeout 2;
    }

    options {
        # cpu-mask on-no-data-accessible
        }

    disk {
        # size max-bio-bvecs on-io-error fencing disk-barrier disk-flushes
        # disk-drain md-flushes resync-rate resync-after al-extents
        # c-plan-ahead c-delay-target c-fill-target c-max-rate
        # c-min-rate disk-timeout
        on-io-error detach;
        fencing resource-only;
    }

    net {
        # protocol timeout max-epoch-size max-buffers unplug-watermark
        # connect-int ping-int sndbuf-size rcvbuf-size ko-count
        # allow-two-primaries cram-hmac-alg shared-secret after-sb-0pri
        # after-sb-1pri after-sb-2pri always-asbp rr-conflict
        # ping-timeout data-integrity-alg tcp-cork on-congestion
        # congestion-fill congestion-extents csums-alg verify-alg
        # use-rle
        protocol C;
    }
}
</code></pre>

<p>设置资源文件</p>

<pre><code>cat /usr/local/drbd/etc/drbd.d/r0.res
resource r0 {
    on drbd-01.i.12582.com {
        device          /dev/drbd0;
        disk            /dev/sdb1;
        address         192.168.30.234:7788;
        meta-disk       internal;
    }

    on drbd-02.i.12582.com {
        device          /dev/drbd0;
        disk            /dev/sdb1;
        address         192.168.30.235:7788;
        meta-disk       internal;
    }
}
</code></pre>

<hr />

<h3>设置权限</h3>

<pre><code>chgrp haclient /sbin/drbdsetup
chmod o-x /sbin/drbdsetup
chmod u+s /sbin/drbdsetup
chgrp haclient /sbin/drbdmeta
chmod o-x /sbin/drbdmeta
chmod u+s /sbin/drbdmeta
</code></pre>

<p>加载DRBD模块与建立resource</p>

<pre><code>modprobe drbd
lsmod | grep drbd
drbd                  328626  0
libcrc32c               1246  1 drbd
</code></pre>

<p>写入一些数据到/dev/sdb1</p>

<pre><code>dd if=/dev/zero of=/dev/sdb1 bs=1M count=100
</code></pre>

<p>建立Resource</p>

<pre><code>drbdadm create-md r0
Writing meta data...
initializing activity log
NOT initializing bitmap
New drbd meta data block successfully created.
success
</code></pre>

<h3>启动DRBD</h3>

<pre><code>/etc/init.d/drbd start
Starting DRBD resources: [
      create res: r0
    prepare disk: r0
     adjust disk: r0
     adjust net: r0
]
degr-wfc-timeout has to be shorter than wfc-timeout
degr-wfc-timeout implicitly set to wfc-timeout (60s)
..........
***************************************************************
DRBD's startup script waits for the peer node(s) to appear.
- In case this node was already a degraded cluster before the
reboot the timeout is 120 seconds. [degr-wfc-timeout]
- If the peer was available before the reboot the timeout will
expire after 60 seconds. [wfc-timeout]
(These values are for resource 'r0'; 0 sec -&amp;gt; wait forever)
To abort waiting enter 'yes' [  49]:yes

.
</code></pre>

<p>节点2按以上操作执行一次。</p>

<h3>DRBD状态查看</h3>

<ol>
<li><p>Secondary/Unknown：若drbd-01服务启动而drbd-02尚未启动,则ro会出现Secondary/Unknown</p>

<pre><code> /init.d/drbd status
 drbd driver loaded OK; device status:
 version: 8.4.3 (api:1/proto:86-101)
 GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
 root@drbd-01.i.12582.com, 2013-08-08 14:00:35
 m:res  cs        ro                 ds                 p   mounted
 fstype
 0:r0   WFConnection  Secondary/Unknown  Inconsistent/DUnknown  C
</code></pre>

<p>查看drbd</p>

<pre><code>  cat /proc/drbd
  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  0: cs:WFConnection ro:Secondary/Unknown ds:Inconsistent/DUnknown C r----s
  ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:8385604
</code></pre></li>
<li><p>Inconsistent/Inconsistent：ds出現Inconsistent表示兩台node資料尚未同步。</p>

<pre><code> drbd driver loaded OK; device status:
 version: 8.4.3 (api:1/proto:86-101)
 GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
 root@drbd-01.i.12582.com, 2013-08-08 14:00:35
 m:res  cs         ro                   ds                         p  mounted  
 fstype
 0:r0   Connected  Secondary/Secondary  Inconsistent/Inconsistent  C
</code></pre>

<p>查看内核</p>

<pre><code>  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----
  ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:8385604
</code></pre>

<p>3  SyncSource：cs出現SyncTarget表示正在同步中，可看到目前同步時的進度．</p>

<pre><code>  drbd driver loaded OK; device status:
  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  m:res  cs          ro                 ds                     p  mounted  
  fstype
  ...    sync'ed:    26.1%              (6056/8188)M
  0:r0   SyncSource  Primary/Secondary  UpToDate/Inconsistent  C
</code></pre>

<p>4  Secondary/Secondary：表示尚未設定Primary Node。</p>

<pre><code>  drbd driver loaded OK; device status:
  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  m:res  cs         ro                   ds                         p  mounted  
  fstype
  0:r0   Connected  Secondary/Secondary  Inconsistent/Inconsistent  C
</code></pre></li>
</ol>


<h3>设置主节点(Primary Node)</h3>

<p>在drbd-01进行以下操作:</p>

<pre><code>drbdadm -- --overwrite-data-of-peer primary r0
</code></pre>

<p>再查看下状态:</p>

<pre><code>/etc/init.d/drbd status
drbd driver loaded OK; device status:
version: 8.4.3 (api:1/proto:86-101)
GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
root@drbd-01.i.12582.com, 2013-08-08 14:00:35
m:res  cs          ro                 ds                     p  mounted  fstype
...    sync'ed:    13.1%              (7124/8188)M
0:r0   SyncSource  Primary/Secondary  UpToDate/Inconsistent  C
</code></pre>

<p>在drbd-02查看下状态：</p>

<pre><code>driver loaded OK; device status:
version: 8.4.3 (api:1/proto:86-101)
GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
root@drbd-02.i.12582.com, 2013-08-08 14:16:07
m:res  cs         ro                 ds                 p  mounted  fstype
0:r0   Connected  Secondary/Primary  UpToDate/UpToDate  C
</code></pre>

<p>格式化（drbd-01）</p>

<pre><code>mkfs.ext4 /dev/drbd0
</code></pre>

<p>挂载到文件系统：</p>

<pre><code>mkdir /datamount /dev/drbd0 /data
</code></pre>

<h2>测试DRBD</h2>

<h3>测试同步</h3>

<ol>
<li><p>在主节点（Primary Node）复制一些数据到/data</p>

<pre><code> cp -r drbd-8.4.3 /data/
</code></pre></li>
<li><p>在次节点（Secondary Node）执行以下步骤：</p>

<pre><code> drbdadm down r0
</code></pre>

<p>注：次节点在DRBD启动状态下是无法mount /data的，所以必须先手动停止才能mount。</p>

<pre><code>  mkdir /datamount -t ext4 /dev/sdb1 /datals -l
</code></pre>

<p>就可以看到数据已经全部同步过来。</p></li>
</ol>


<h2>Heartbeat配置</h2>

<p>主节点操作：</p>

<pre><code>vim /etc/ha.d/ha.cf
debugfile /var/log/ha-debug   # 打开错误日志报告

keepalive 2    # 2秒检测一次心跳线连接
deadtime 10    # 10秒测试不到 主节点心跳线就认为有问题

warntime 6    # 警告时间（建议在2－10之间）

initdead 120   # 初始化启动时 120秒无连接视为正常，或指定heartbeat 在启动时，

# 需要等待120秒才去启动任何资源

udpport 694     # 用udp的694端口连接，netstat -antulp | grep 694

ucast eth0 192.168.30.235      # 单播方式连接（主、从都是写对方的IP连接）

node  drbd-01.i.12582.com  # 声明主节点（uname -n）

node  drbd-02.i.12582.com  # 声明次节点（uname -n）

auto_failback on                    # 自动切换（主节点恢复后会自动切换回来）

respawn hacluster /usr/lib64/heartbeat/ipfail  #监控ipfail进程是否挂掉，否则重启它
</code></pre>

<p>&nbsp;</p>

<p>vim /etc/ha.d/authkeysauth 11 sha1 MySecret&nbsp;</p>

<p>&nbsp;</p>

<p>chmod 600 /etc/ha.d/authkeys</p>

<p>&nbsp;</p>

<p>vim /etc/ha.d/haresourcesdrbd-01.i.12582.com IPaddr::192.168.30.229/24/eth0 drbddisk::r0 Filesystem::/dev/drbd0::/data::ext4</p>

<p>&nbsp;</p>

<p>drbd-01.i.12582.com   主节点的主机名</p>

<p>IPaddr::192.168.30.229/24/eth0    设置虚拟IP</p>

<p>drbddisk::r0                  管理资源r0</p>

<p>Filesystem::/dev/drbd0::/data::ext4   执行umount和mount操作</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>次节点操作：</p>

<p>将ha.cf中的192.168.30.235改成192.168.30.234</p>

<p>&nbsp;</p>

<h3>DRBD主从自动切换测试</h3>

<p>1）    首先在 drbd-01启动heartbeat：</p>

<p>/etc/init.d/heartbeat  start</p>

<p>2）    接着在 drbd-02 启动heartbear:</p>

<p>/etc/init.d/heartbeat  start</p>

<p>&nbsp;</p>

<p>在drbd-01输入：</p>

<p>ip a</p>

<p>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN</p>

<p>link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</p>

<p>inet 127.0.0.1/8 scope host lo</p>

<p>inet6 ::1/128 scope host</p>

<p>valid_lft forever preferred_lft forever</p>

<p>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</p>

<p>link/ether 08:00:27:98:a2:6c brd ff:ff:ff:ff:ff:ff</p>

<p>inet 192.168.30.234/24 brd 192.168.30.255 scope global eth0</p>

<p>inet <b>192.168.30.229</b>/24 brd 192.168.30.255 scope global secondary eth0:0</p>

<p>inet6 fe80::a00:27ff:fe98:a26c/64 scope link</p>

<p>valid_lft forever preferred_lft forever</p>

<p>从结果可以看出，VIP已经出现。</p>

<p>&nbsp;</p>

<p>3）    停止drbd-01的heartbeat服务或将网线断掉，同时监控drbd-02的DRBD状态，</p>

<p>drbd-02操作：</p>

<p>watch -n 1 /etc/init.d/drbd status</p>

<p>如果一切正常，可以看到状态在不断变化。</p>

<p>4）    恢复drbd-01的heartbeat服务或将网线接上，同时监控drbd-02的DRBD状态，如果正常drbd-01又变为主节点（auto_failback on 决定）了。</p>

<p>&nbsp;</p>

<h2>Mysql+DRBD+Heartbeat配置</h2>

<h3>Mysql安装</h3>

<p><b>安装Mysql</b><b>依赖包</b></p>

<p>yum -y install gcc gcc-c++ ncurses-devel libtool zlib-devel bison</p>

<p>&nbsp;</p>

<p><b>创建用户与组</b></p>

<p>groupadd mysqluseradd -g mysql mysql</p>

<p><b>设置内核参数</b></p>

<p>vi /etc/security/limits.confmysql              soft    nproc   2047mysql              hard    nproc   16384mysql              soft    nofile  1024</p>

<p>mysql              hard    nofile  65536</p>

<p>&nbsp;</p>

<p><b>安装Mysql</b></p>

<p>由于源码安装Mysql5.6需要依赖cmake，必须先安装cmake：</p>

<p>mkdir ~/software; cd ~/softwarewget <a href="ftp://192.168.30.211/pub/Tools/mysql/cmake-2.8.4.tar.gztar">ftp://192.168.30.211/pub/Tools/mysql/cmake-2.8.4.tar.gztar</a> zxvf cmake-2.8.4.tar.gzcd cmake-2.8.4</p>

<p>./configure</p>

<p>gmake &amp;&amp; make install</p>

<p>&nbsp;</p>

<p>开始安装Mysql</p>

<p>cd ~/softwarewget <a href="ftp://192.168.30.211/pub/Tools/mysql/mysql-5.6.5-m8.tar.gztar">ftp://192.168.30.211/pub/Tools/mysql/mysql-5.6.5-m8.tar.gztar</a> zxvf mysql-5.6.5-m8.tar.gzcd mysql-5.6.5-m8</p>

<p>cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</p>

<p>-DDEFAULT_CHARSET=utf8 \</p>

<p>-DDEFAULT_COLLATION=utf8_general_ci \</p>

<p>-DENABLED_LOCAL_INFILE=ON \</p>

<p>-DWITH_INNOBASE_STORAGE_ENGINE=1 \</p>

<p>-DWITH_FEDERATED_STORAGE_ENGINE=1 \</p>

<p>-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</p>

<p>-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</p>

<p>-DWITH_PARTITION_STORAGE_ENGINE=1 \</p>

<p>-DWITH_PERFSCHEMA_STORAGE_ENGINE=1 \</p>

<p>-DCOMPILATION_COMMENT=&lsquo;agenge for mysql&rsquo; \</p>

<p>-DWITH_READLINE=ON \</p>

<p>-DMYSQL_UNIX_ADDR=/data/mysqldata/3306/mysql.sock \</p>

<p>-DSYSCONFDIR=/data/mysqldata/3306</p>

<p>make &amp;&amp; make install</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<h3>Mysql设置</h3>

<p>设置权限</p>

<p>chown -R mysql:mysql /usr/local/mysql</p>

<p>设置环境变量</p>

<p>vi /etc/profileexport PATH=/usr/local/mysql/bin:$PATH</p>

<p>使环境变量马上生效</p>

<p>source /etc/profile</p>

<p>设置相关存储路径</p>

<p>cd /datamkdir -p mysqldata/3306/{data,binlog,tmp,innodb_ts,innodb_log}cd /data/mysqldata/mkdir script backup</p>

<p>chown -R mysql:mysql /data/mysqldata/</p>

<p>&nbsp;</p>

<p>创建my.cnf</p>

<p>vi /data/mysqldata/3306/my.cnf[client]port = 3306socket = /data/mysqldata/3306/mysql.sock</p>

<p>&nbsp;</p>

<h1>Here follows entries for some specific programs</h1>

<p>&nbsp;</p>

<h1>The MySQL server</h1>

<p>[mysqld]</p>

<p>port     = 3306</p>

<p>user     = mysql</p>

<p>socket   = /data/mysqldata/3306/mysql.sock</p>

<p>pid-file = /tmp/mysql.pid</p>

<p>basedir  = /usr/local/mysql</p>

<p>datadir  = /data/mysqldata/3306/data</p>

<p>tmpdir   = /data/mysqldata/3306/tmp</p>

<p>open_files_limit    = 10240</p>

<p>server-id = 333306</p>

<p>lower_case_table_names = 1</p>

<p>character-set-server = utf8</p>

<p>skip-name-resolve</p>

<p>&nbsp;</p>

<p>max_connections = 1000</p>

<p>max_connect_errors = 100000</p>

<p>max_allowed_packet = 512M</p>

<p>max_heap_table_size = 1024M</p>

<p>max_length_for_sort_data = 4096</p>

<p>back_log=100</p>

<p>interactive_timeout = 28800</p>

<p>wait_timeout = 28800</p>

<p>&nbsp;</p>

<p>default-storage-engine = InnoDB</p>

<p>&nbsp;</p>

<p>net_buffer_length = 8K</p>

<p>sort_buffer_size = 2M</p>

<p>join_buffer_size = 4M</p>

<p>read_buffer_size = 2M</p>

<p>read_rnd_buffer_size = 16M</p>

<p>&nbsp;</p>

<p>query_cache_size = 128M</p>

<p>query_cache_limit = 2M</p>

<p>query_cache_min_res_unit = 2k</p>

<p>&nbsp;</p>

<p>thread_cache_size = 300</p>

<p>table_open_cache = 1024</p>

<p>tmp_table_size = 256M</p>

<p>&nbsp;</p>

<h1><strong><strong><strong><strong><strong><em>  Logs related settings </em></strong></strong></strong></strong></strong></h1>

<p>log-bin  = ../binlog/mysql-bin</p>

<p>relay-log = ../binlog/mysql-relay-bin</p>

<p>binlog_format=mixed</p>

<p>binlog_cache_size=32m</p>

<p>max_binlog_cache_size=512m</p>

<p>max_binlog_size=512m</p>

<p>long_query_time = 1</p>

<p>log_output = FILE</p>

<p>log-error =  ../mysql-error.log</p>

<p>slow_query_log = 1</p>

<p>slow_query_log_file = ../slow_statement.log</p>

<h1>log_queries_not_using_indexes</h1>

<p>general_log = 0</p>

<p>general_log_file = ../general_statement.log</p>

<p>expire-logs-days = 14</p>

<p>&nbsp;</p>

<h1><strong><strong><strong><strong><strong><em> MyISAM Specific options </em></strong></strong></strong></strong></strong></h1>

<p>key_buffer_size = 32M</p>

<p>bulk_insert_buffer_size = 64M</p>

<p>myisam_sort_buffer_size = 128M</p>

<p>myisam_max_sort_file_size = 10G</p>

<p>myisam_repair_threads = 1</p>

<p>myisam_recover</p>

<p>&nbsp;</p>

<h1><strong><strong><strong><strong><strong><em> INNODB Specific options </em></strong></strong></strong></strong></strong></h1>

<p>innodb_file_per_table = 1</p>

<p>transaction-isolation = READ-COMMITTED</p>

<p>&nbsp;</p>

<p>innodb_additional_mem_pool_size = 16M</p>

<p>innodb_buffer_pool_size = 1192M</p>

<p>innodb_data_home_dir = ../innodb_ts</p>

<p>innodb_data_file_path = ibdata1:2048M:autoextend</p>

<p>&nbsp;</p>

<p>innodb_file_io_threads = 4</p>

<p>innodb_thread_concurrency = 8</p>

<p>innodb_log_buffer_size = 128M</p>

<p>innodb_log_file_size = 256M</p>

<p>innodb_log_files_in_group = 3</p>

<p>&nbsp;</p>

<p>innodb_log_group_home_dir = ../innodb_log</p>

<p>innodb_flush_log_at_trx_commit = 2</p>

<p>innodb_max_dirty_pages_pct = 80</p>

<p>innodb_lock_wait_timeout = 120</p>

<p>innodb_flush_method=O_DIRECT</p>

<p>performance_schema</p>

<p>&nbsp;</p>

<p>[mysqldump]</p>

<p>quick</p>

<p>max_allowed_packet = 512M</p>

<p>&nbsp;</p>

<p>[mysql]</p>

<p>no-auto-rehash</p>

<h1>Remove the next comment character if you are not familiar with SQL</h1>

<h1>safe-updates</h1>

<p>&nbsp;</p>

<p>[myisamchk]</p>

<p>key_buffer_size = 32M</p>

<p>sort_buffer_size = 20M</p>

<p>read_buffer_size = 2M</p>

<p>write_buffer_size = 2M</p>

<p>&nbsp;</p>

<p>[mysqlhotcopy]</p>

<p>interactive-timeout</p>

<p>&nbsp;</p>

<p>[mysqld_safe]</p>

<p>open-files-limit = 8192</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>安装mysql database，并启动Myql：</p>

<p>/usr/local/mysql/scripts/mysql_install_db \</p>

<p>&mdash;datadir=/data/mysqldata/3306/data \</p>

<p>&mdash;defaults-file=/data/mysqldata/3306/my.cnf \</p>

<p>&mdash;basedir=/usr/local/mysql &mdash;user=mysql</p>

<p>mysqld_safe &mdash;defaults-file=/data/mysqldata/3306/my.cnf &amp;</p>

<p>mysqladmin -uroot password &lsquo;new_password&rsquo; -S /data/mysqldata/3306/mysql.sock</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>mysql -uroot -p123456</p>

<p>mysql&gt; select user,host from mysql.user;</p>

<p>mysql&gt; delete from mysql.user where (user,host) not in (select &lsquo;root&rsquo;,&lsquo;localhost&rsquo;);</p>

<p>mysql&gt; delete from mysql.proxies_priv where host=&lsquo;localhost.localdomain&rsquo;;</p>

<p>mysql&gt; delete from mysql.db;</p>

<p>mysql&gt; flush privileges;</p>

<p>mysql&gt; quit</p>

<p>mysqladmin -uroot -p123456 shutdownrm -f /data/mysqldata/3306/mysql-error.logmysqld_safe &mdash;defaults-file=/data/mysqldata/3306/my.cnf &amp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>启动Mysql脚本</p>

<p>cp support-files/mysql.server  /etc/init.d/mysqldchmod +x /etc/init.d/mysqld</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>修改ha.cf</p>

<p>由于现在是管理Mysql，故要将mysqld由heartbeat管理（2个节点都执行）</p>

<p>cat /etc/ha.d/haresourcesdrbd-01.i.12582.com IPaddr::192.168.30.229/24/eth0:0  drbddisk::r0 Filesystem::/dev/drbd0::/data::ext4 mysqld</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>测试</p>

<p>1）  准备Mysql数据（节点1操作）</p>

<p>mysql -uroot -pEnter password:Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 2</p>

<p>Server version: 5.6.5-m8-log agenge for mysql</p>

<p>&nbsp;</p>

<p>Copyright &copy; 2000, 2012, Oracle and/or its affiliates. All rights reserved.</p>

<p>&nbsp;</p>

<p>Oracle is a registered trademark of Oracle Corporation and/or its</p>

<p>affiliates. Other names may be trademarks of their respective</p>

<p>owners.</p>

<p>&nbsp;</p>

<p>Type &lsquo;help;&rsquo; or &lsquo;\h&rsquo; for help. Type &lsquo;\c&rsquo; to clear the current input statement.</p>

<p>&nbsp;</p>

<p>mysql&gt; create database mydb;</p>

<p>Query OK, 1 row affected (0.02 sec)</p>

<p>&nbsp;</p>

<p>mysql&gt; use mydb;</p>

<p>Database changed</p>

<p>mysql&gt; create table t_1( id  int not null, name varchar(10));</p>

<p>Query OK, 0 rows affected (0.14 sec)</p>

<p>mysql&gt; insert into t_1 values(1,&lsquo;aaa&rsquo;);</p>

<p>Query OK, 1 row affected (0.00 sec)</p>

<p>&nbsp;</p>

<p>mysql&gt; commit;</p>

<p>Query OK, 0 rows affected (0.00 sec)</p>

<p>mysql&gt; quit;</p>

<p>Bye</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>2）  切换主、次节点，同时监控drbd-02服务器的日志</p>

<p>watch -n 1 /etc/init.d/drbd status</p>

<p>如果一切正常，可以看到ro的状态从“Secondary/Primary”变成“Primary/Secondary”。</p>

<p>例如偶切换成的状态如下：</p>

<p>drbd driver loaded OK; device status:</p>

<p>version: 8.4.3 (api:1/proto:86-101)</p>

<p>GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by root@<b>drbd-02.i.12582.com</b>, 2013-08-08 16:46:23</p>

<p>m:res  cs         ro                 ds                 p  mounted  fstype</p>

<p>0:r0   Connected  <b>Primary/Secondary</b>  UpToDate/UpToDate  C  /data    ext4</p>

<p>3）  查询数据是否丢失（drbd-02操作）</p>

<p>mysql -uroot -p</p>

<p>Enter password:</p>

<p>Welcome to the MySQL monitor.  Commands end with ; or \g.</p>

<p>Your MySQL connection id is 2</p>

<p>Server version: 5.6.5-m8-log agenge for mysql</p>

<p>&nbsp;</p>

<p>Copyright &copy; 2000, 2012, Oracle and/or its affiliates. All rights reserved.</p>

<p>&nbsp;</p>

<p>Oracle is a registered trademark of Oracle Corporation and/or its</p>

<p>affiliates. Other names may be trademarks of their respective</p>

<p>owners.</p>

<p>&nbsp;</p>

<p>Type &lsquo;help;&rsquo; or &lsquo;\h&rsquo; for help. Type &lsquo;\c&rsquo; to clear the current input statement.</p>

<p>&nbsp;</p>

<p>mysql&gt; use mydb;</p>

<p>Database changed</p>

<p>mysql&gt; select * from t_1;</p>

<p>+&mdash;&mdash;+&mdash;&mdash;&mdash;+</p>

<p>| id | name |</p>

<p>+&mdash;&mdash;+&mdash;&mdash;&mdash;+</p>

<p>|  1 | aaa  |</p>

<p>+&mdash;&mdash;+&mdash;&mdash;&mdash;+</p>

<p>1 row in set (0.00 sec)</p>

<h2>从结果可以看到在drbd-02上数据已经有了。</h2>

<p>layout: post
title: DRBD+Heartbeat+Mysql高可用配置
categories:
&ndash; 运维
tags:
&ndash; drbd
&ndash; heartbeat
&ndash; mysql
&ndash; 集群
&ndash; 高可用
published: true</p>

<h2>comments: true</h2>

<h2>介绍</h2>

<p>DRBD全称Distributed Replicated Block （分布式的复制块设备），属于Device公司，但是完全开源。它是一款基于块设备的文件复制解决方案，速度比文件级别的软件如NFS，samba快很多，是很多中小企业的共享存储首选解决方案。</p>

<p>DRBD工作需要在两个节点上同时准备一块一模一样的分区组成镜像，这就是为什么它叫做分布式复制块设备，它主要通过复制数据来实现文件同步（备份），主要用于集群文件共享， 我们通过它的工作原理来了解块复制和文件复制的不同。</p>

<p>首先，您需要知道，DRBD是工作在系统内核空间，而不是用户空间，它直接复制的是二进制数据，这是它速度快的根本原因。其次，DRBD至少需要两个节点来工作，一主一次。</p>

<p>DRBD的文件同步过程和普通复制过程的不同：</p>

<p>DRBD在数据进入Buffer Cache时，先经过DRBD这一层，复制一份数据经过TCP/IP协议封装，发送到另一个节点上，另一个节点通过TCP/IP协议来接受复制过来的数据，同步到次节点的DRBD设备上。</p>

<!--more-->


<h2>准备工作</h2>

<p>1  准备至少2台服务器，且每台服务器有一块磁盘或一个单独未使用的分区，偶的环境如下：</p>

<p>主节点(Primary Node)
次节点(Secondary Node)
主机名
drbd-01.i.12582.com
drbd-02.i.12582.com
操作系统
CentOS 6.3 x86_64位
CentOS 6.3 x86_64位
硬盘分区
/dev/sdb  8G
/dev/sdb  8G
IP地址
192.168.30.234
192.168.30.235</p>

<p>注意：如果有服务器有2块或以上网卡的同学，建议将其中一块网卡专门用来做网络心跳线，甚至接入另外一台单独的交换机，本次环境只有单网卡。</p>

<h2>初始化设置</h2>

<p>1  所有节点关闭iptables和SELinux</p>

<p>2  在所有节点/etc/hosts加入以下内容：</p>

<pre><code>192.168.30.234  drbd-01.i.12582.com drbd-01
192.168.30.235  drbd-02.i.12582.com drbd-02
</code></pre>

<p>3  所有节点创建独立分区：</p>

<pre><code>fdisk /dev/sdbDevice contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabelBuilding a new DOS disklabel with disk identifier 0x46b64833.Changes will remain in memory only, until you decide to write them.
After that, of course, the previous content won't be recoverable.
Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)
WARNING: DOS-compatible mode is deprecated. It's strongly recommended to
switch off the mode (command 'c') and change display units to
sectors (command 'u').

Command (m for help): p
Disk /dev/sdb: 8589 MB, 8589934592 bytes
255 heads, 63 sectors/track, 1044 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x46b64833

Device Boot    Start        End        Blocks    Id    System

Command (m for help): n
Command action
e   extended
p   primary partition (1-4)
p
Partition number (1-4): 1
First cylinder (1-1044, default 1):
Using default value 1
Last cylinder, +cylinders or +size{K,M,G} (1-1044, default 1044):
Using default value 1044

Command (m for help): w
The partition table has been altered!
Calling ioctl() to re-read partition table.
Syncing disks.
</code></pre>

<h2>安装Hearbeat</h2>

<pre><code>wget ftp://mirror.switch.ch/pool/1/mirror/scientificlinux/6rolling/i386/os/Packages/epel-release-6-5.noarch.rpm
rpm -ivUh epel-release-6-5.noarch.rpm
yum --enablerepo=epel install heartbeat -y
</code></pre>

<h2>安装DRBD</h2>

<p>1  安装依赖包</p>

<pre><code>yum -y install gcc kernel-devel kernel-headers flex
</code></pre>

<p>2  安装DRBD</p>

<pre><code>wget http://oss.linbit.com/drbd/8.4/drbd-8.4.3.tar.gz
tar zxvf drbd-8.4.3.tar.gz
cd drbd-8.4.3
./configure --prefix=/usr/local/drbd --with-km --with-heartbeat
make KDIR=/usr/src/kernels/2.6.32-279.el6.x86_64/
make install
cp -R /usr/local/drbd/etc/ha.d/resource.d/drbd* /etc/ha.d/resource.d/
</code></pre>

<p>3  其他设置</p>

<pre><code>mkdir -p /usr/local/drbd/var/run/drbd
cp /usr/local/drbd/etc/rc.d/init.d/drbd /etc/rc.d/init.d/
chkconfig --add drbdchkconfig drbd on
</code></pre>

<h2>安装DRBD模块</h2>

<pre><code>cd drbdmake 
clean
make KDIR=/usr/src/kernels/2.6.32-279.el6.x86_64/
cp drbd.ko /lib/modules/`uname -r`/kernel/lib/
depmod
</code></pre>

<p>以上操作请在所有节点操作一次。</p>

<hr />

<h2>设置DRBD</h2>

<p><strong>配置drbd.conf</strong></p>

<pre><code>cat /usr/local/drbd/etc/drbd.d/global_common.conf
global {
    minor-count 64;
    usage-count yes;
    # minor-count dialog-refresh disable-ip-verification
}


common {
    syncer { rate 1000M; }
    handlers {
        # These are EXAMPLE handlers only.
        # They may have severe implications,
        # like hard resetting the node under certain circumstances.
        # Be careful when chosing your poison.

        pri-on-incon-degr "/usr/lib/drbd/notify-pri-on-incon-degr.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &amp;gt; /proc/sysrq-trigger ; reboot -f";
        pri-lost-after-sb "/usr/lib/drbd/notify-pri-lost-after-sb.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &amp;gt; /proc/sysrq-trigger ; reboot -f";
        local-io-error "/usr/lib/drbd/notify-io-error.sh; /usr/lib/drbd/notify-emergency-shutdown.sh; echo o &amp;gt; /proc/sysrq-trigger ; halt -f";
        fence-peer "/usr/lib/drbd/crm-fence-peer.sh";
        pri-lost "/usr/local/drbd/lib/drbd/notify-pri-lost.sh; /usr/local/drbd/lib/drbd/notify-emergency-reboot.sh; echo b &amp;gt;/proc/sysrq-trigger ; reboot -f";
        split-brain "/usr/lib/drbd/notify-split-brain.sh root";
        out-of-sync "/usr/lib/drbd/notify-out-of-sync.sh root";
        # before-resync-target "/usr/lib/drbd/snapshot-resync-target-lvm.sh -p 15 -- -c 16k";
        # after-resync-target /usr/lib/drbd/unsnapshot-resync-target-lvm.sh;
    }

    startup {

        # wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb
        wfc-timeout 60;
        degr-wfc-timeout 120;
        outdated-wfc-timeout 2;
    }

    options {
        # cpu-mask on-no-data-accessible
        }

    disk {
        # size max-bio-bvecs on-io-error fencing disk-barrier disk-flushes
        # disk-drain md-flushes resync-rate resync-after al-extents
        # c-plan-ahead c-delay-target c-fill-target c-max-rate
        # c-min-rate disk-timeout
        on-io-error detach;
        fencing resource-only;
    }

    net {
        # protocol timeout max-epoch-size max-buffers unplug-watermark
        # connect-int ping-int sndbuf-size rcvbuf-size ko-count
        # allow-two-primaries cram-hmac-alg shared-secret after-sb-0pri
        # after-sb-1pri after-sb-2pri always-asbp rr-conflict
        # ping-timeout data-integrity-alg tcp-cork on-congestion
        # congestion-fill congestion-extents csums-alg verify-alg
        # use-rle
        protocol C;
    }
}
</code></pre>

<p>设置资源文件</p>

<pre><code>cat /usr/local/drbd/etc/drbd.d/r0.res
resource r0 {
    on drbd-01.i.12582.com {
        device          /dev/drbd0;
        disk            /dev/sdb1;
        address         192.168.30.234:7788;
        meta-disk       internal;
    }

    on drbd-02.i.12582.com {
        device          /dev/drbd0;
        disk            /dev/sdb1;
        address         192.168.30.235:7788;
        meta-disk       internal;
    }
}
</code></pre>

<hr />

<h3>设置权限</h3>

<pre><code>chgrp haclient /sbin/drbdsetup
chmod o-x /sbin/drbdsetup
chmod u+s /sbin/drbdsetup
chgrp haclient /sbin/drbdmeta
chmod o-x /sbin/drbdmeta
chmod u+s /sbin/drbdmeta
</code></pre>

<p>加载DRBD模块与建立resource</p>

<pre><code>modprobe drbd
lsmod | grep drbd
drbd                  328626  0
libcrc32c               1246  1 drbd
</code></pre>

<p>写入一些数据到/dev/sdb1</p>

<pre><code>dd if=/dev/zero of=/dev/sdb1 bs=1M count=100
</code></pre>

<p>建立Resource</p>

<pre><code>drbdadm create-md r0
Writing meta data...
initializing activity log
NOT initializing bitmap
New drbd meta data block successfully created.
success
</code></pre>

<h3>启动DRBD</h3>

<pre><code>/etc/init.d/drbd start
Starting DRBD resources: [
      create res: r0
    prepare disk: r0
     adjust disk: r0
     adjust net: r0
]
degr-wfc-timeout has to be shorter than wfc-timeout
degr-wfc-timeout implicitly set to wfc-timeout (60s)
..........
***************************************************************
DRBD's startup script waits for the peer node(s) to appear.
- In case this node was already a degraded cluster before the
reboot the timeout is 120 seconds. [degr-wfc-timeout]
- If the peer was available before the reboot the timeout will
expire after 60 seconds. [wfc-timeout]
(These values are for resource 'r0'; 0 sec -&amp;gt; wait forever)
To abort waiting enter 'yes' [  49]:yes

.
</code></pre>

<p>节点2按以上操作执行一次。</p>

<h3>DRBD状态查看</h3>

<ol>
<li><p>Secondary/Unknown：若drbd-01服务启动而drbd-02尚未启动,则ro会出现Secondary/Unknown</p>

<pre><code> /init.d/drbd status
 drbd driver loaded OK; device status:
 version: 8.4.3 (api:1/proto:86-101)
 GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
 root@drbd-01.i.12582.com, 2013-08-08 14:00:35
 m:res  cs        ro                 ds                 p   mounted
 fstype
 0:r0   WFConnection  Secondary/Unknown  Inconsistent/DUnknown  C
</code></pre>

<p>查看drbd</p>

<pre><code>  cat /proc/drbd
  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  0: cs:WFConnection ro:Secondary/Unknown ds:Inconsistent/DUnknown C r----s
  ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:8385604
</code></pre></li>
<li><p>Inconsistent/Inconsistent：ds出現Inconsistent表示兩台node資料尚未同步。</p>

<pre><code> drbd driver loaded OK; device status:
 version: 8.4.3 (api:1/proto:86-101)
 GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
 root@drbd-01.i.12582.com, 2013-08-08 14:00:35
 m:res  cs         ro                   ds                         p  mounted  
 fstype
 0:r0   Connected  Secondary/Secondary  Inconsistent/Inconsistent  C
</code></pre>

<p>查看内核</p>

<pre><code>  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----
  ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:8385604
</code></pre>

<p>3  SyncSource：cs出現SyncTarget表示正在同步中，可看到目前同步時的進度．</p>

<pre><code>  drbd driver loaded OK; device status:
  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  m:res  cs          ro                 ds                     p  mounted  
  fstype
  ...    sync'ed:    26.1%              (6056/8188)M
  0:r0   SyncSource  Primary/Secondary  UpToDate/Inconsistent  C
</code></pre>

<p>4  Secondary/Secondary：表示尚未設定Primary Node。</p>

<pre><code>  drbd driver loaded OK; device status:
  version: 8.4.3 (api:1/proto:86-101)
  GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
  root@drbd-01.i.12582.com, 2013-08-08 14:00:35
  m:res  cs         ro                   ds                         p  mounted  
  fstype
  0:r0   Connected  Secondary/Secondary  Inconsistent/Inconsistent  C
</code></pre></li>
</ol>


<h3>设置主节点(Primary Node)</h3>

<p>在drbd-01进行以下操作:</p>

<pre><code>drbdadm -- --overwrite-data-of-peer primary r0
</code></pre>

<p>再查看下状态:</p>

<pre><code>/etc/init.d/drbd status
drbd driver loaded OK; device status:
version: 8.4.3 (api:1/proto:86-101)
GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
root@drbd-01.i.12582.com, 2013-08-08 14:00:35
m:res  cs          ro                 ds                     p  mounted  fstype
...    sync'ed:    13.1%              (7124/8188)M
0:r0   SyncSource  Primary/Secondary  UpToDate/Inconsistent  C
</code></pre>

<p>在drbd-02查看下状态：</p>

<pre><code>driver loaded OK; device status:
version: 8.4.3 (api:1/proto:86-101)
GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by 
root@drbd-02.i.12582.com, 2013-08-08 14:16:07
m:res  cs         ro                 ds                 p  mounted  fstype
0:r0   Connected  Secondary/Primary  UpToDate/UpToDate  C
</code></pre>

<p>格式化（drbd-01）</p>

<pre><code>mkfs.ext4 /dev/drbd0
</code></pre>

<p>挂载到文件系统：</p>

<pre><code>mkdir /datamount /dev/drbd0 /data
</code></pre>

<h2>测试DRBD</h2>

<h3>测试同步</h3>

<ol>
<li><p>在主节点（Primary Node）复制一些数据到/data</p>

<pre><code> cp -r drbd-8.4.3 /data/
</code></pre></li>
<li><p>在次节点（Secondary Node）执行以下步骤：</p>

<pre><code> drbdadm down r0
</code></pre>

<p>注：次节点在DRBD启动状态下是无法mount /data的，所以必须先手动停止才能mount。</p>

<pre><code>  mkdir /datamount -t ext4 /dev/sdb1 /datals -l
</code></pre>

<p>就可以看到数据已经全部同步过来。</p></li>
</ol>


<h2>Heartbeat配置</h2>

<ol>
<li><p>主节点操作：</p>

<pre><code> vim /etc/ha.d/ha.cf
 debugfile /var/log/ha-debug   # 打开错误日志报告

 keepalive 2    # 2秒检测一次心跳线连接
 deadtime 10    # 10秒测试不到 主节点心跳线就认为有问题
 warntime 6    # 警告时间（建议在2－10之间）
 initdead 120   # 初始化启动时 120秒无连接视为正常，或指定heartbeat 在启动时，
 # 需要等待120秒才去启动任何资源

 udpport 694     # 用udp的694端口连接，netstat -antulp | grep 694
 ucast eth0 192.168.30.235      # 单播方式连接（主、从都是写对方的IP连接）
 node  drbd-01.i.12582.com  # 声明主节点（uname -n）
 node  drbd-02.i.12582.com  # 声明次节点（uname -n）
 auto_failback on                    # 自动切换（主节点恢复后会自动切换回来）
 respawn hacluster /usr/lib64/heartbeat/ipfail  #监控ipfail进程是否挂掉，否则重启它
</code></pre></li>
<li><p>编辑认证文件</p>

<pre><code> vim /etc/ha.d/authkeys
 auth 1
 1 sha1 MySecret&amp;nbsp;
</code></pre></li>
<li><p>权限</p>

<pre><code> chmod 600 /etc/ha.d/authkeys
</code></pre></li>
<li><p>编辑资源文件</p>

<pre><code> vim /etc/ha.d/haresources
 drbd-01.i.12582.com IPaddr::192.168.30.229/24/eth0 drbddisk::r0 
 Filesystem::/dev/drbd0::/data::ext4
</code></pre>

<p> drbd-01.i.12582.com   主节点的主机名</p>

<p> IPaddr::192.168.30.229/24/eth0    设置虚拟IP</p>

<p> drbddisk::r0                  管理资源r0</p>

<p> Filesystem::/dev/drbd0::/data::ext4   执行umount和mount操作</p></li>
<li><p>次节点操作：</p>

<p> 将ha.cf中的192.168.30.235改成192.168.30.234</p></li>
</ol>


<h3>DRBD主从自动切换测试</h3>

<ol>
<li><p>首先在 drbd-01启动heartbeat：</p>

<pre><code> /etc/init.d/heartbeat  start
</code></pre></li>
<li><p>接着在 drbd-02 启动heartbear:</p>

<pre><code> /etc/init.d/heartbeat  start
</code></pre></li>
<li><p>在drbd-01输入：</p>

<pre><code> ip a

 1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 16436 qdisc noqueue state UNKNOWN
     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
     inet 127.0.0.1/8 scope host lo
     inet6 ::1/128 scope host
         valid_lft forever preferred_lft forever
 2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
     link/ether 08:00:27:98:a2:6c brd ff:ff:ff:ff:ff:ff
     inet 192.168.30.234/24 brd 192.168.30.255 scope global eth0
     inet &lt;b&gt;192.168.30.229&lt;/b&gt;/24 brd 192.168.30.255 scope global secondary eth0:0
     inet6 fe80::a00:27ff:fe98:a26c/64 scope link
         valid_lft forever preferred_lft forever
</code></pre>

<p>从结果可以看出，VIP已经出现。</p></li>
<li><p>停止drbd-01的heartbeat服务或将网线断掉，同时监控drbd-02的DRBD状态.</p></li>
<li><p>drbd-02操作：</p>

<pre><code> watch -n 1 /etc/init.d/drbd status
</code></pre>

<p>如果一切正常，可以看到状态在不断变化。</p></li>
<li><p>恢复drbd-01的heartbeat服务或将网线接上，同时监控drbd-02的DRBD状态，如果正常drbd-01又变为主节点（auto_failback on 决定）了。</p></li>
</ol>


<h2>Mysql+DRBD+Heartbeat配置</h2>

<h3>Mysql安装</h3>

<p><strong>安装Mysql依赖包</strong></p>

<pre><code>yum -y install gcc gcc-c++ ncurses-devel libtool zlib-devel bison
</code></pre>

<p><b>创建用户与组</b></p>

<pre><code>groupadd mysqluseradd -g mysql mysql
</code></pre>

<p><b>设置内核参数</b></p>

<pre><code>vi /etc/security/limits.conf
mysql              soft    nproc   2047
mysql              hard    nproc   16384
mysql              soft    nofile  1024
mysql              hard    nofile  65536
</code></pre>

<p><b>安装Mysql</b></p>

<p>由于源码安装Mysql5.6需要依赖cmake，必须先安装cmake：</p>

<pre><code>mkdir ~/software; cd ~/software
wget ftp://192.168.30.211/pub/Tools/mysql/cmake-2.8.4.tar.gz
tar zxvf cmake-2.8.4.tar.gz
cd cmake-2.8.4
./configure
gmake &amp;&amp;  make install
</code></pre>

<p>开始安装Mysql</p>

<pre><code>cd ~/software
wget ftp://192.168.30.211/pub/Tools/mysql/mysql-5.6.5-m8.tar.gz
tar zxvf mysql-5.6.5-m8.tar.gz
cd mysql-5.6.5-m8

cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \
  -DDEFAULT_CHARSET=utf8 \
  -DDEFAULT_COLLATION=utf8_general_ci \
  -DENABLED_LOCAL_INFILE=ON \
  -DWITH_INNOBASE_STORAGE_ENGINE=1 \
  -DWITH_FEDERATED_STORAGE_ENGINE=1 \
  -DWITH_BLACKHOLE_STORAGE_ENGINE=1 \
  -DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \
  -DWITH_PARTITION_STORAGE_ENGINE=1 \
  -DWITH_PERFSCHEMA_STORAGE_ENGINE=1 \
  -DCOMPILATION_COMMENT='agenge for mysql' \
  -DWITH_READLINE=ON \
  -DMYSQL_UNIX_ADDR=/data/mysqldata/3306/mysql.sock \
  -DSYSCONFDIR=/data/mysqldata/3306
  make &amp;&amp; make install
</code></pre>

<h3>Mysql设置</h3>

<ul>
<li><p>设置权限</p>

<pre><code>  chown -R mysql:mysql /usr/local/mysql
</code></pre></li>
<li><p>设置环境变量</p>

<pre><code>  vi /etc/profileexport PATH=/usr/local/mysql/bin:$PATH
</code></pre></li>
<li><p>使环境变量马上生效</p>

<pre><code>  source /etc/profile
</code></pre></li>
<li><p>设置相关存储路径</p>

<pre><code>  cd /data
  mkdir -p mysqldata/3306/{data,binlog,tmp,innodb_ts,innodb_log}
  cd /data/mysqldata/mkdir script backup
  chown -R mysql:mysql /data/mysqldata/
</code></pre></li>
<li><p>创建my.cnf</p>

<pre><code>  vi /data/mysqldata/3306/my.cnf
  [client]
  port = 3306
  socket = /data/mysqldata/3306/mysql.sock

  # Here follows entries for some specific programs

  # The MySQL server
  [mysqld]
  port     = 3306
  user     = mysql
  socket   = /data/mysqldata/3306/mysql.sock
  pid-file = /tmp/mysql.pid
  basedir  = /usr/local/mysql
  datadir  = /data/mysqldata/3306/data
  tmpdir   = /data/mysqldata/3306/tmp
  open_files_limit    = 10240
  server-id = 333306
  lower_case_table_names = 1
  character-set-server = utf8
  skip-name-resolve
  max_connections = 1000
  max_connect_errors = 100000
  max_allowed_packet = 512M
  max_heap_table_size = 1024M
  max_length_for_sort_data = 4096
  back_log=100
  interactive_timeout = 28800
  wait_timeout = 28800

  default-storage-engine = InnoDB

  net_buffer_length = 8K
  sort_buffer_size = 2M
  join_buffer_size = 4M
  read_buffer_size = 2M
  read_rnd_buffer_size = 16M

  query_cache_size = 128M
  query_cache_limit = 2M
  query_cache_min_res_unit = 2k

  thread_cache_size = 300
  table_open_cache = 1024
  tmp_table_size = 256M

  #***********  Logs related settings ***********
  log-bin  = ../binlog/mysql-bin
  relay-log = ../binlog/mysql-relay-bin
  binlog_format=mixed
  binlog_cache_size=32m
  max_binlog_cache_size=512m
  max_binlog_size=512m
  long_query_time = 1
  log_output = FILE
  log-error =  ../mysql-error.log
  slow_query_log = 1
  slow_query_log_file = ../slow_statement.log
  #log_queries_not_using_indexes
  general_log = 0
  general_log_file = ../general_statement.log
  expire-logs-days = 14

  #*********** MyISAM Specific options ***********
  key_buffer_size = 32M
  bulk_insert_buffer_size = 64M
  myisam_sort_buffer_size = 128M
  myisam_max_sort_file_size = 10G
  myisam_repair_threads = 1
  myisam_recover

  #*********** INNODB Specific options ***********
  innodb_file_per_table = 1
  transaction-isolation = READ-COMMITTED

  innodb_additional_mem_pool_size = 16M
  innodb_buffer_pool_size = 1192M
  innodb_data_home_dir = ../innodb_ts
  innodb_data_file_path = ibdata1:2048M:autoextend

  innodb_file_io_threads = 4
  innodb_thread_concurrency = 8
  innodb_log_buffer_size = 128M
  innodb_log_file_size = 256M
  innodb_log_files_in_group = 3

  innodb_log_group_home_dir = ../innodb_log
  innodb_flush_log_at_trx_commit = 2
  innodb_max_dirty_pages_pct = 80
  innodb_lock_wait_timeout = 120
  innodb_flush_method=O_DIRECT
  performance_schema

  [mysqldump]
  quick
  max_allowed_packet = 512M

  [mysql]
  no-auto-rehash
  # Remove the next comment character if you are not familiar with SQL
  #safe-updates

  [myisamchk]
  key_buffer_size = 32M
  sort_buffer_size = 20M
  read_buffer_size = 2M
  write_buffer_size = 2M

  [mysqlhotcopy]
  interactive-timeout

  [mysqld_safe]
  open-files-limit = 8192
</code></pre></li>
<li><p>安装mysql database，并启动Myql：</p>

<pre><code>  /usr/local/mysql/scripts/mysql_install_db \
    --datadir=/data/mysqldata/3306/data \
    --defaults-file=/data/mysqldata/3306/my.cnf \
    --basedir=/usr/local/mysql --user=mysql
  mysqld_safe --defaults-file=/data/mysqldata/3306/my.cnf &amp;amp;
  mysqladmin -uroot password 'new_password' -S /data/mysqldata/3306/mysql.sock

  mysql -uroot -p123456
  mysql&gt; select user,host from mysql.user;
  mysql&gt; delete from mysql.user where (user,host) not in (select 'root','localhost');
  mysql&gt; delete from mysql.proxies_priv where host='localhost.localdomain';
  mysql&gt; delete from mysql.db;
  mysql&gt; flush privileges;
  mysql&gt; quit
  mysqladmin -uroot -p123456 shutdownrm -f /data/mysqldata/3306/mysql-error.logmysqld_safe --defaults-file=/data/mysqldata/3306/my.cnf &amp;amp;
</code></pre></li>
<li><p>启动Mysql脚本</p>

<pre><code>  cp support-files/mysql.server  /etc/init.d/mysqld
  chmod +x /etc/init.d/mysqld
</code></pre></li>
<li><p>修改ha.cf</p></li>
</ul>


<p> 由于现在是管理Mysql，故要将mysqld由heartbeat管理（2个节点都执行）</p>

<pre><code>    cat /etc/ha.d/haresources
    drbd-01.i.12582.com IPaddr::192.168.30.229/24/eth0:0  drbddisk::r0 
    Filesystem::/dev/drbd0::/data::ext4 mysqld
</code></pre>

<ul>
<li><p>测试</p>

<ol>
<li><p> 准备Mysql数据（节点1操作）</p>

<pre><code>  mysql -uroot -p
  Enter password:
  Welcome to the MySQL monitor.  Commands end with ; or \g.
  Your MySQL connection id is 2
  Server version: 5.6.5-m8-log agenge for mysql

  Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.

  Oracle is a registered trademark of Oracle Corporation and/or its
  affiliates. Other names may be trademarks of their respective
  owners.

  Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

  mysql&gt; create database mydb;
  Query OK, 1 row affected (0.02 sec)

  mysql&gt; use mydb;
  Database changed
  mysql&gt; create table t_1( id  int not null, name varchar(10));
  Query OK, 0 rows affected (0.14 sec)
  mysql&gt; insert into t_1 values(1,'aaa');
  Query OK, 1 row affected (0.00 sec)

  mysql&gt; commit;
  Query OK, 0 rows affected (0.00 sec)
  mysql&gt; quit;
  Bye
</code></pre></li>
<li><p> 切换主、次节点，同时监控drbd-02服务器的日志</p>

<pre><code>  watch -n 1 /etc/init.d/drbd status
</code></pre></li>
</ol>


<p>  如果一切正常，可以看到ro的状态从“Secondary/Primary”变成“Primary/Secondary”。</p>

<p>  例如偶切换成的状态如下：</p>

<pre><code>      drbd driver loaded OK; device status:
      version: 8.4.3 (api:1/proto:86-101)
      GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by root@&lt;b&gt;drbd-02.i.12582.com&lt;/b&gt;, 2013-08-08 16:46:23
      m:res  cs         ro                 ds                 p  mounted  fstype
      0:r0   Connected  &lt;b&gt;Primary/Secondary&lt;/b&gt;  UpToDate/UpToDate  C  /data    ext4
</code></pre>

<ol>
<li><p> 查询数据是否丢失（drbd-02操作）</p>

<pre><code>  mysql -uroot -p
  Enter password:
  Welcome to the MySQL monitor.  Commands end with ; or \g.
  Your MySQL connection id is 2
  Server version: 5.6.5-m8-log agenge for mysql

  Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.

  Oracle is a registered trademark of Oracle Corporation and/or its
  affiliates. Other names may be trademarks of their respective
  owners.

  Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

  mysql&gt; use mydb;
  Database changed
  mysql&gt; select * from t_1;
  +----+------+
  | id | name |
  +----+------+
  |  1 | aaa  |
  +----+------+
  1 row in set (0.00 sec)
</code></pre></li>
</ol>


<p>  以看到在drbd-02上数据已经有了。</p></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[视频编解码术语概念介绍]]></title>
    <link href="http://agenge.github.io/blog/2013/07/28/video-decoder-intro/"/>
    <updated>2013-07-28T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/07/28/video-decoder-intro</id>
    <content type="html"><![CDATA[<h2>前言</h2>

<p>最近有幸接触到流媒体领域，这可是偶之前一直灰常弱的一方面，可以说完全没有任何概念，经过Google的N次方搜索之后，头脑中总算有个概念，以下文章均来自互联网，偶就不一一帖出原链接，如果有语句或解释，很可能是偶借鉴您的文章，希望不要介意。当然，有些是偶自己写的，您就凑合着看，对于新手来讲，我相信收获肯定不少。</p>

<h3>阅读对象</h3>

<ol>
<li>流媒体新手或渴望了解流媒体</li>
<li>这篇文章合适有耐心的人，如果您觉得没那么多时间看这些”费话“，请直接关闭当前标签页
会更好。</li>
<li>永远追求上进的学习爱好者。</li>
<li><strong>不适合</strong>流媒体的牛逼人物。</li>
</ol>


<hr />

<h2>视频扫盲</h2>

<h3>什么是编解码？什么是codec？</h3>

<p>所谓编解码，就是codec。 <strong>CODEC</strong>= <strong>CO</strong>de（编码）+<strong>DEC</strong>ode（解码）.假设显示器的设置是：每秒刷新60次，也就是刷新率为60Hz，1024 * 768的分辨率，那么此时显卡每秒要处理的数据量是 60 * 1024 * 768 个像素点，可想而知，视频文件的大小是很恐怖的。如果不用任何方法压缩，就单纯的存储视频文件，那么1GB的文件，也只能存储37秒左右的视频内容。所以，咱们需要一个方式来压缩（code,编码）它，再存储起来，要播放的时候，再解压缩（decode,解码）。这样牺牲一些时间，来换取很大一部分空间，这是值得的，并且咱们的硬件设备也有这个能力做到。</p>

<h3>屏幕比例与分辨率的联系</h3>

<p>4:3、16:9、16:10，还有5:4，1920x1024、1280x720、1024x768、640x480等，已经被这些比例和分辨率搞得头昏脑涨？目前市场上针对比例和分辨率还比较混乱，下面的扫盲<strong>仅限于</strong>常见的几种。其实我们最常见的屏幕比例无非上面提到的4:3、16:9、16:10这三种，而5:4只是一个特殊比例，每种比例都算是一个家庭，其中4:3是最最常见的，也是历史最久的比例，它所对应的最高分辨率为：640x480，更小的分辨率此处不再一一列出。16:9 主要用于HD电视领域，也就是我们经常听到的720p、1080p，两个比例对应的分辨率：</p>

<ul>
<li>720p   1280x720</li>
<li>1080p 1920x1080</li>
</ul>


<!-- more -->


<h3>延升阅读</h3>

<p>16:9是指显示器长宽比例，根据<strong>人体工程学</strong>的研究，发现人的两只眼睛的视野范围是一个长宽比例为16：9的长方形，所以电视、显示器行业根据这个的黄金比例尺寸设计产品。</p>

<h4>Container（容器），Stream（流），Frame（帧），Codec（编解码器），mux/demux(复用/解复用)。</h4>

<ul>
<li><strong>Container</strong>：           一个container就是一个文件，一种container就是一种文件格式，举例：xxx.flv 和 yyy.mkv是两个文件，我们可以说他们是两个容器，并且是两种不同的容器。</li>
<li><strong>Stream</strong>：    一个容器中包括音频流(audio stream)、视频流(video stream)、字幕流(subtitlestream )等。

<ul>
<li>例1：xxx.flv文件，假设里面包含两种stream，一种是音频流(audio stream)，另一种是视频流(video stream)，并且以flv规定的格式把这两个流封装在.flv容器里面。</li>
<li>例2：yyy.mkv文件，假设里面包含三种stream，一种是音频流(audio stream)，另一种是视频流(video stream)，还有一种流是字幕流(subtitle stream)，并且以mkv规定的格式把这三种流封装在.mkv的容器里面。</li>
</ul>
</li>
</ul>


<p> 上面讲了容器和流的关系，那把不同的流按照某种容器的规则从那种容器（文件）中解析（或者说抽出来）出来，这种行为叫做解复用（demux），使用解复用器（demuxer），那反过来，把不同的流按照某种容器的规则放入那种容器（最后肯定生成了某种格式的文件），这种行为叫做<strong>复用</strong>（mux），使用复用器（muxer）。</p>

<ul>
<li><strong>Frame</strong>：     包含在Stream里面，当从容器中得到一个流以后，或者说不管你怎么弄的，反正你得到了一个流，那这个流就认为是被某种编码器 编码过后生成的，你需要把这个流里面的帧去解码。</li>
</ul>


<p><strong>那什么又是影片捏？</strong></p>

<p>影片其实就是一组（很多张）图片，时间间隔很小的连续展示出来，人们就觉得画面中的人物在动，这就是影片。那电影的实质就是N多张图片的集合。那每张图片和帧又有什么关系呢？事实上，如果一部影片里面的图片，我们原封不动的全部存起来，空间会很大很大很大，但是如果通过一定的算法（这里不讲相关算法），把每一张图片压缩（编码_encode）一下，变成帧(Frame)。再把帧连起来变成流，再把不同的流放到某个容器里面，这就是我们平常看见的电影文件了，比如这个文件 《碟中谍4.H264.ACC.mkv》，他为什么要这样命名呢？mkv表达了它的容器是.mkv的，且包含至少两个流，h264的视频流，ACC的音频流。这是一种典型的牺牲时间来换取空间的做法。当得到一个流之后，就得设法找出里面的帧，然后使用解码器/decoder 把帧还原，然后再去播放，也可以再去使用另一个编码器/encoder编码压缩成另一种格式的帧（这就是所谓的转格式软件要完成的一个步骤）。</p>

<hr />

<h2>视频编码简介</h2>

<h3>MPEG视频编码</h3>

<h4>MPEG-2简介</h4>

<ol>
<li><p>MPEG-2编码的DVD
MPEG-2制定于1994年，设计目标是高级工业标准的图象质量以及更高的传输率。MPEG-2所能提供的传输率在3-10Mbits/sec间，其在 NTSC制式下的分辨率可达720X486，MPEG-2也可提供并能够提供广播级的视像和CD级的音质。MPEG-2的音频编码可提供左右中及两个环绕 声道,以及一个加重低音声道，和多达7个伴音声道(这就是DVD可有8种语言配音的原因)。由于MPEG-2的出色性能表现，已能适用于高清视频，使得原打算为高清视频设计的MPEG-3，还没出世就被抛弃了。MPEG-3要求传输速率在20Mbits/sev-40Mbits/sec间，但这将使画面有轻度扭曲。</p></li>
<li><p>MPEG-2 TS编码的高清视频
MPEG-2高清视频采用的编码是MPEG-2 TS格式，其英文全称是(MPEG-2 Transport Stream)，这是一种视频流格式，主要用于实时传送节目，目前已经成为数字电视领域中普遍应用的系统层编码标准。</p></li>
</ol>


<p> MPEG-2 TS格式的高清视频文件一般采用mpg、tp、ts为后缀。采用MPEG-2 TS格式压缩后的高清视频文件通常都相当大，以一部90分钟的电影为例，文件大小通常都在8GB以上，有的甚至超过15GB。在播放以tp和ts为后缀的高清视频文件时也比较麻烦，因为文件中分别包含有AC’3音频信息和MPEG-2视频信息，需要使用专门的软件来进行播放。</p>

<h4>MPEG-4简介</h4>

<p>MPEG-4制定于1998年，MPEG-4是为了播放流式媒体的高质量视频而专门设计的，它可利用很窄的带度，通过帧重建技术，压缩和传输数据，以求使用最少的数据获得最佳的图像质量。这种编码方式多用于HDTV-Rip上，它把原有的高清视频文件按照比例缩小到一定的尺寸，以减少文件的大小，同时画面效果不差于DVD效果，以此来寻求一个画面效果和文件尺寸的平衡。相对于高清视频来说，MPEG-4格式 还显得有点不够用，因此它也不是主流的高清视频信号来源。这种视频格式的文件扩展名包括.asf、.mov和DivX 、AVI等。</p>

<h3>H.264视频编码</h3>

<p>H.264是一种高性能的视频编解码技术。目前国际上制定视频编解码技术的组织有两个: 一个是“国际电联（ITU-T）”，它制定的标准有H.261、H.263、H.263+等，另一个是“国际标准化组织（ISO）”它制定的标准有MPEG-1、MPEG-2、MPEG-4等。而H.264则是由两个组织联合组建的联合视频组（JVT）共同制定的新数字视频编码标准，所以它既是ITU-T的H.264，又是ISO/IEC的MPEG-4高级视频编码（Advanced Video Coding，AVC），而且它将成为MPEG-4标准的第10部分。因此，不论是MPEG-4 AVC、MPEG-4 Part 10，还是ISO/IEC 14496-10，都是指H.264。</p>

<p>H.264最具价值的部分是更高的数据压缩比，在同等的图像质量，H.264的数据压缩比能比DVD系统中使用的 MPEG-2高2～3倍，比MPEG-4高1.5～2倍。举个例子，原始文件的大小如果为100GB，采用MPEG-2压缩标准压缩后变成4GB，压缩比25∶1，而采用H.264压缩标准压缩后变为1GB，从100GB到1GB，H.264的压缩比达到惊人的100∶1。尤其值得一提的是，H.264在具有高压缩比的同时还拥有高质量流畅的图像。正因为如此，经过H.264压缩的视频数据，在网络传输过程中所需要的带宽更少，也更加经济。
在MPEG-2需要6Mbps的传输速率匹配时，H.264只需要1Mbps～2Mbps的传输速率。
H.264格式的文件一般采用mkv后缀，mkv是一种新兴的多媒体封装格式，可以将各类视频编
码、16条或以上不同格式的音频和语言不同的字幕封装在一个文件内，它具有开放源代码、音视
频编码丰富等优势，已经得到众多视频压制组和玩家的支持，正逐渐成为高清视频的主流格式。</p>

<h3>WMV-HD/VC-1视频编码</h3>

<p>WMV-HD是由软件业的巨头微软公司所创立的一种视频压缩格式。其压缩率远高于MPEG-2标准，同样是2小时的HDTV节目，如果使用MPEG-2最多只能压缩至30GB，而使用WMV-HD这样的高压缩率编码器，在画质丝毫不降的前提下都可压缩到15GB以下。虽然WMV-HD是微软的独有标准，在开放性和兼容性上没有其他几种格式好，但由于目前大家都在使用微软的操作系统，因此推出之后仍然迅速普及。</p>

<p>除了WMV-HD以外，微软WMV第九版(WMV9)编码技术叫做VC-1，2003年正式提出，于2006年正式成为国际标准，是微软开发的视频压缩技术系列中的最新版本。VC-1结合几种编码格式的优点于一身，在压缩比率上介于H.264与MPEG-2之间，画质表现方面与H.264接近，且在编码算法的复杂度上只为H.264的一半，处于一个中间的平衡点位置，对硬件要求较低、高压缩率、高画质、低耗时等特点使得VC-1成为一种比较理想的编码方式，发展前景较为可观。</p>

<p>WMV-HD及VC-1编码的视频文件一般采用wmv为后缀，wmv文件通常包括了WMV格式编码的视频和WMA编码的音频。</p>

<h3>RMVB视频编码</h3>

<p>当前在网络上见的最多的，肯定是RMVB视频，RMVB之所以这么流行，主要是RMVB在图像质量与文件大小之间取得了最好的平衡。一部720P的电影如果采用H.264编码，一般会有4G的大小，但如果改成RMVB格式，1G大小就可以了。目前国内的家庭宽带一般只有2M～4M，假如4M带宽，下载1G文件大概需要1个小时，下载4G文件最少在4个小时以上，因此很多人都会选择下载RMVB
文件。虽然RMVB文件的清晰度比不上H.264，但是基本上可以满足大部分人的要求了。RMVB之所以可以图像质量与文件大小之间取得最好的平衡，主要是使用了可变比特率的编码。RMVB中的VB指VBR，Variable Bit Rate(可改变之比特率)，RMVB打破了原先RM格式那种平均压缩采样的方式，在保证平均压缩比的基础上，采用浮动比特率编码的方式，将较高的比特率用于复杂的动态画面（如歌舞、飞车、战争等），而在静态画面中则灵活地转为较低的采样率，从而合理地利用了比特率资源，使RMVB最大限度地压缩了影片的大小，最终拥有了近乎完美的接近于H.264品质的视听效果。</p>

<p>虽然RMVB表现出色，可以达到720P以上的分别率，但在大屏幕的电视上观看，会有比较明显的
色块，始终算不上是高清视频。但它最大的优点是文件体积较小，在国内的互联网带宽没有大幅度提升之前，估计还会流行很长的一度时间。</p>

<h3>视频编码总结</h3>

<p>总的来说，MPEG2由于压缩比例较小，视频所占空间太大，目前已经基本处于了被淘汰的边缘。目前比较流行的高清编码是H.264与微软的VC-1。但就压缩的比率来看 H.264 > VC-1 > MPEG-2；对于低分辨率的视频文件，MPEG-2的画质表现还是不错的，但基于720P以上则明显略低于H.264和VC-1的效果；而VC-1与H.264相比，由于无明显编码优势，而且限于Windows平台使用、标准推出较晚，因此给微软VC-1编码的应用前景带来了较大的不确定性，能否跟H.264一较高下，尚需实践检验。另外不得不提的是RMVB视频，由于目前国内家庭宽带的速度不高，很多人都不愿意下载大容量H.264的视频，从而给了RMVB很大的发展空间，目前国内互联网上的视频仍然是RMVB占的比例最高。</p>

<hr />

<h2>H.264和MPEG-4区别</h2>

<p>H.264是一种高性能的视频编解码技术。目前国际上制定视频编解码技术的组织有两个，一个是“<strong>国际电联（ITU-T）</strong>”，它制定的标准有H.261、H.263、H.263+等，另一个是“<strong>国际标准化组织（ISO）</strong>”，它制定的标准有MPEG-1、MPEG-2、MPEG-4等。而H.264则是由两个组织联合组建的联合视频组（JVT）共同制定的新数字视频编码标准，所以它既是ITU-T的H.264，又是ISO/IEC的MPEG-4高级视频编码（Advanced Video Coding，AVC），而且它将成为MPEG-4标准的第10部分。因此，不论是MPEG-4 AVC、MPEG-4 Part 10，还是ISO/IEC 14496-10，都是指H.264。</p>

<hr />

<h2>H.264与X264区别</h2>

<h3>X264简介</h3>

<p>X264是基于H.264标准的免费开源视频编码器，开头的字母“X”表示“software”的意思，压缩能力强大，画质效果优秀，早已获得广泛应用。特征是编码速度相当快，但解码很慢且相当耗费CPU处理能力，X264不支援硬件加速,是和RMVB一样的强解码类型(同一机型GeForce7300和GeForce9600播放H264时CPU会有巨大的差异但播放RMVB和X264二者无异),X264不支持de-block(区域马赛克弱化换算) 技术。</p>

<p>简单来讲就是：</p>

<ul>
<li>h264是一种视频编码方式，x264是基于h264的开源编码解码器。</li>
<li>h.264是一种视频编码标准，x264是一种采用这种标准的具体实现。</li>
</ul>


<p>x264是一个采用GPL授权的视频编码自由软件。x264的主要功能在于进行H.264/MPEG-4 AVC的.</p>

<p><strong>视频编码</strong>，而不是作为解码器（decoder）之用。</p>

<hr />

<h2>H264与AVC1区别</h2>

<ol>
<li>AVC1属于H.264的一种，是苹果开发的符合H.264/AVC的编码。</li>
<li>AVC1 描述: H.264 bitstream without start codes.一般通过ffmpeg转码生成的视频，是不带起始码0×00000001的。</li>
<li>H264 描述: H.264 bitstream with start codes.一般对于一下HDVD等电影的压制格式，是带有起始码0×00000001的。</li>
</ol>


<p> 即：H264=AVC， H264 != AVC1</p>

<hr />

<h2>DivX、XviD、AVC、AAC与MPEG-4联系</h2>

<p>MPEG-4是一种标准，共分成21个部分，其中这21个部分就包括了DivX、XviD、AVC、AAC等，
可参考：<a href="http://zh.wikipedia.org/zh-cn/MPEG-4">http://zh.wikipedia.org/zh-cn/MPEG-4</a></p>

<p>例如：</p>

<p><strong>第二部分 ISO/IEC 14496-2: </strong></p>

<ul>
<li>视频：定义了一个对各种视觉信息（包括自然视频、静止纹理、计算机合成图形等等）的编解码器。（例如<strong>XviD</strong>编码就属于MPEG-4 Part 2）。</li>
</ul>


<p><strong>第三部分 ISO/IEC 14496-3: </strong></p>

<ul>
<li>音频：定义了一个对各种音频信号进行编码的编解码器的集合。包括高级音频编码（Advanced Audio Coding，缩写为<strong>AAC</strong>）的若干变形和其他一些音频/语音编码工具。</li>
</ul>


<p><strong>第十部分 ISO/IEC 14496-10: </strong></p>

<ul>
<li>高级视频编码或称高级视频编码（Advanced Video Coding，缩写为<strong>AVC</strong>）：定义了一个视频编解码器（codec）。AVC和XviD都属于MPEG-4编码，但由于AVC
属于MPEG-4 Part 10，在技术特性上比属于MPEG-4 Part2的XviD要先进。另外，它和ITU-T H.264标准是一致的，故又称为H.264。</li>
</ul>


<p><strong>第十五部分 ISO/IEC 14496-15: </strong></p>

<ul>
<li>AVC 文件格式：定义了基于第十二部分的用于存储第十部分的视频内容的文件格式。</li>
</ul>


<h3>什么是DivX、XviD？</h3>

<ol>
<li><p><strong>DivX</strong>，是DivX公司（前身是DivX Networks公司）的著名品牌，是一种MPEG-4技术视频编解码器（codec），2007年秋以2200万美元收购德国Main Concept。2010年10月，DivX公司被Sonic Solutions收购。并于2011年2月，因Sonic Solutions被Rovi公司收购而成为旗下企业。</p></li>
<li><p><strong>Xvid</strong>（旧称为<strong>XviD</strong>）是一个开放源代码的MPEG-4视频编解码器，它是基于OpenDivX而编写的。Xvid是由一群原OpenDivX义务开发者在OpenDivX于2001年7月停止开发后自行开发的。Xvid是在<strong>GNU GPL v2</strong>下发布的，但因为某些国家如美国，日本有软件专利法，使得其在该地区可能出现法律纠纷。因此，Xvid官方网站只提供源代码下载，至于安装文件可能需要大家去搜索。</p></li>
</ol>


<p>  Xvid的主要竞争对手是DivX。但Xvid是开放源代码的，而DivX则只有<strong>免费</strong>（不是<strong>自由</strong>）的版本和商用版本。所以，具体用哪个，相信您肯定能一眼看出。</p>

<hr />

<h2>PAL、NTSC、SECAM区别</h2>

<ol>
<li>PAL<strong>逐行倒相</strong>，Phase Alternating Line的缩写，PAL制式是电视广播中色彩调频的一种方法，主要应用于中国、香港、中东地区和欧洲等地区；</li>
<li>NTSC<strong>美国全国电视标准委员会</strong>，是指National Television System Committee的缩写，主要应用于美国、日本、加拿大、墨西哥、韩国、菲律宾等地区；</li>
</ol>


<p> 另外，NTSC属于同时制，<strong>隔行扫描</strong>，画面比例为4：3.
3. SECAM （顺序传送与存储彩色电视系统，法国采用的一种电视制式，（SEquential CouleurAvec Memoire）PAL和NTSC都属于便于两大主要的电视广播制式，但是由于系统投射颜色影响的频率有所不同。两种制式相互之前不兼容。</p>

<p>PAL和NTSC的分辨率不所不同，PAL制式使用720x576，约40万像素，故PAL制式的数码摄像机的CCD大小为40万的倍数或半倍数；NTSC使用的是760x480，约37万像素，故NTSC制式的数据摄像机的CCD一般为34万的倍数或半倍数。</p>

<ul>
<li><strong>NTSC 制式优缺点</strong></li>
</ul>


<p> 属于同时制，帧频为<strong>每秒29.97</strong>，扫描线为525，隔行扫描，画面比例为4：3，分辨率为640x480，这种制式的色度信号调制包括了<strong>平衡调制</strong>和<strong>正交调制</strong>两种，解决了彩色与黑白电视广播兼容性问题，但存在相位容易失真、色彩不太稳定的缺点。</p>

<ul>
<li><strong>PAL制式优缺点</strong></li>
</ul>


<p> 帧频为每秒25.
  * 对相位失真不敏感，因此，对传输设备和接收机设备的技术指标要求，PAL制式比NTSC制式要低。
  * 比NTSC制抗多径接收性能好。
  * PAL制相对NTSC制而言，色度信号的正交失真不敏感，并且对色度信号部分抑制边带而引起的失真也不敏感。
  * PAL接收机中采用梳状滤波器，可使亮度串色的幅度下降3dB，并且可以提高彩色信噪比。</p>

<ul>
<li><strong>PAL制有下列缺点：</strong></li>
<li>由于PAL制色信号逐行倒相，传输及解码中产生的误差(例如微分相位等)，将在图象上产生爬行及半帧频闪烁现象。</li>
<li>PAL信号不利于信号处理(包括数字信号处理，亮度信号的彻底分离等)，这是因为它的色度信号逐行倒相，色副载波相位8场一循环引起的。</li>
<li>与NTSC制一样，彩色接收机图象的水平清晰度比黑白电视机的低。</li>
<li>垂直彩色清晰度PAL制比NTSC制低。</li>
<li>由于要有高精度和高稳定度的延时线及附属电路，PAL制接收机比NTSC制接收机复杂，成本稍高，对于录像机也是如此。</li>
</ul>


<h3>各制式分布图</h3>

<p><a href="http://agenge.com/wp-content/uploads/2013/07/pte.png"><img class="alignnone size-full wp-image-727" alt="pte" src="http://agenge.com/wp-content/uploads/2013/07/pte.png" width="685" height="344" /></a></p>

<hr />

<h2>视频编码工具</h2>

<h3>FFmpeg</h3>

<ul>
<li>官方网站：<a href="www.ffmpeg.org">http://www.ffmpeg.org</a></li>
</ul>


<p> FFmpeg是一个自由软件，可以运行音频和视频多种格式的录影、转档、流功能[1]，包含了libavcodec ─这是一个用于多个专案中音频和视频的解码器库，以及 libavformat ——一个音频与视频格式转换库。</p>

<p> 另外，&#8221;FFmpeg&#8221;这个单词中的 &ldquo;FF&rdquo; 指的是 &ldquo;<strong>Fast Forward</strong>&#8220;，相信很多同学是不知道滴。</p>

<h3>Libav</h3>

<ul>
<li>官方网站：<a href="http://libav.org">http://libav.org/</a></li>
</ul>


<p> 基于FFmpeg开发的一个开源分支，后来又从FFmpeg中独立出来。它是一个完整的、跨平台的用于音频和视频录制、转换的解决方案，包含 libavcodec 编码器。</p>

<hr />

<p>每个领导发言之后，总得来个总结，偶也装下逼，不过此处省略3000字，看最后几句话：</p>

<h1>如果以上有涉嫌抄袭您的文章，请第一时间通知，偶定会明确标识.</h1>

<p>以上所有扫盲知识，偶只是汇总下而已。。。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[制作OpenStack Windows Server 2008 镜像]]></title>
    <link href="http://agenge.github.io/blog/2013/07/24/make_openstack-windows2008-image/"/>
    <updated>2013-07-24T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/07/24/make_openstack-windows2008-image</id>
    <content type="html"><![CDATA[<h1>前言</h1>

<p>对于OpenStack中，制作一个Windows 的镜像让很多新手极为烦恼，偶有幸成功制作，
不敢私藏，故与大家分享小小心得。上次与大家介绍过 <a href="http://agenge.com/cloud-computing/make_openstack-centos-image.html">制作OpenStack CentOS 6.3 镜像</a></p>

<p>本次主要是记录如何制作一个Windows Server 2008的镜像，请看操作：</p>

<ol>
<li>下载Virtio总线驱动</li>
</ol>


<p> 由于OpenStack只支持Virtio总线的磁盘，所以我们需要在安装之前下载virtio驱动：</p>

<pre><code>    wget http://alt.fedoraproject.org/pub/alt/virtio-win/latest/images/virtio-win-0.1-59.iso
</code></pre>

<ol>
<li>准备一个Windows Server 2008的ISO文件。</li>
</ol>


<p> 除了Virtio总线驱动，您还需要准备一个Windows Server 2008的ISO，为安装操作系统做准备。
3. 创建虚拟磁盘文件：</p>

<pre><code>    qemu-img create -f qcow2 winserver2008.img 20G
</code></pre>

<p> 对于虚拟磁盘文件的各种磁盘格式区别与对比，可以参考 <a href="http://blog.prajnagarden.com/?p=248">qcow2、raw、vmdk等镜像格式</a></p>

<ol>
<li><p>创建虚拟机，使用kvm或virt-install均可，本次安装使用的virt-install</p>

<pre><code> virt-install --connect qemu:///system -n winserver2008 --vcpus=1 -r 2048 \
   --disk path=/path/to/winserver2008.img,size=60,format=qcow2,bus=virtio,cache=none \
   -c /path/iso/windows_server_2008.iso \
   --vnc --vncport=5909 --vnclisten=0.0.0.0  \
   --os-type windows --os-variant=win2k8 --accelerate \
   --network=bridge:br0,model=virtio  \
   --disk path=/path/to/win_driver/virtio-win-0.1-59.iso,device=cdrom,perms=ro&lt;br /&gt;
</code></pre></li>
</ol>


<p> 以上参数有点多，不过这里不一一解释，后期偶会专门写一篇介绍KVM相关知识点，这里只是描述几个重要的参数：</p>

<pre><code>- -n  虚拟机的名称
- --disk  虚拟磁盘存放的路径，即第一步qemu-img创建的虚拟磁盘。&lt;/span&gt;&lt;/li&gt;
- -c  ISO的路径 &lt;/span&gt;&lt;/li&gt;
- --vncport  VNC连接端口，后面会用到，这里是5909，且必须是未使用的端口。&lt;/span&gt;&lt;/li&gt;
- --network   这个地方偶使用的是一个叫 br0 的网桥，所以你的系统必须保证有br0这个网桥。&lt;/span&gt;&lt;/li&gt;
</code></pre>

<!-- more -->


<p></p>

<p> 使用VNC 客户端连接，例如192.168.30.211:9 
 <img src="http://agenge.github.io/images/2013/07/01.png"></p>

<p> 连接成功之后，和常规安装操作系统没有任何区别，但在分区时会提示找到磁盘文件，如图：</p>

<p> <img src="http://agenge.github.io/images/2013/07/02.png"></p>

<p> 点击“<b>加载驱动程序</b>”，并按下图选择对应的驱动：</p>

<p> <img src="http://agenge.github.io/images/2013/07/03.png"></p>

<p> 点击“确定”，如果WIN8驱动找不到磁盘，重新选择WIN7即可。然后再点击“下一步”：</p>

<p> <img src="http://agenge.github.io/images/2013/07/04.png"></p>

<p> 安装之后并关机，进入下一步操作。</p>

<ol>
<li>上传镜像</li>
</ol>


<p> 最后一步就是要将刚才的虚拟磁盘文件上传到云平台中心:</p>

<pre><code>    glance image-create --name Win-2008-x86_64-cloud --is-public true --container-format ovf --disk-format qcow2 &lt; /home/agen/winserver2008.img
</code></pre>

<p> 通过以上的步骤，希望新手能够成功制作一份完美的镜像文件，如果在制作过程中有任何疑问，请留言，最好是邮件，偶在有时间的情况下肯定会第一时间解答。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[制作OpenStack CentOS 6.3 镜像]]></title>
    <link href="http://agenge.github.io/blog/2013/07/20/make_openstack-centos-image/"/>
    <updated>2013-07-20T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/07/20/make_openstack-centos-image</id>
    <content type="html"><![CDATA[<h1>前言</h1>

<p>距离上次写文章已经N天，即对不住各位，更对不住自己，今天将教大家如何制作
OpenStack CentOS 6.3 镜像，费话不多说，咱就开始干活吧。</p>

<ol>
<li><p>准备一个镜像文件，即ISO文件，本示例所使用的为：</p>

<pre><code> CentOS-6.3-i386-minimal.iso
</code></pre></li>
</ol>


<p> <em>注：无论您是内部测试环境还是生产环境，偶都强烈推荐使用64位操作系统。</em></p>

<ol>
<li><p>引导并安装系统</p>

<pre><code> virt-install -n CentOS63 -r 2048 --cpu host \
   -c /data/iso/CentOS-6.3-i386-minimal.iso \
   --disk path=/data/kvm_data/centos6.3-openstack.img,device=disk,bus=virtio,size=10,format=qcow2 \
   --vnc --vncport=5908 --vnclisten=0.0.0.0 -v \
   --network bridge=br0
</code></pre></li>
</ol>


<p> 这些参数的就请您先自行查找手册，后期有时间偶会补上关于KVM的相关实践手册。</p>

<ol>
<li>镜像相关设置（此处根据你的需求进行个性化定制，尽量保持简洁）：</li>
<li><p>分区全部给根分区，防火墙和SELinux禁止.</p>

<pre><code>     chkconfig iptables off
</code></pre></li>
</ol>


<p> 将/etc/selinux/config 中的 SELINUX=enforcing修改成 SELINUX=disabled
 * 修改分区表：</p>

<pre><code>        vi /etc/fstab
        # 将UUID=这一行注释，加入：
        LABEL=cec-rootfs                           / ext4 defaults&lt;b&gt; 0 0&lt;/b&gt;
</code></pre>

<ul>
<li><p>修改网络配置：</p>

<pre><code>     vi /etc/sysconfig/network-scripts/ifcfg-eth0
     #将HWADDR=这行删除或注释即可，并且设置成BOOTPROTO=dhcp
</code></pre></li>
<li><p>删除网络规则，因为Centos6之后70-persistent-net.rules这个文件会自动添加除eth0之外的其他网络接口，</p>

<pre><code>     rm -rf /etc/udev/rules.d/70-persistent-net.rules
</code></pre></li>
<li>还要把另外一个文件删除，不然上面这个文件还会自动创建滴：
         mv /lib/udev/write_net_rules{,.bak}</li>
<li><p>上传镜像</p>

<pre><code> glance image-create --name centos63Image --is-public true --container-format ovf --disk-format qcow2 &amp;lt; /home/agen/centos63.img
</code></pre></li>
</ul>


<p> 至此，所有操作已经完成，如果一切正常，你所创建的实例访问正常。如网络还存在问题，可能
和您的OpenStack网络设置有关，不过这已经超出本文的范畴。假如您对OpenStack的环境搭建不是很熟悉的话，建议您再多看看这篇文章：<a title="Openstack安装与部署(Folsom)" href="http://agenge.com/cloud-computing/openstack_install_with_deploy_for_folsom.html">Openstack安装与部署(Folsom)</a>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Openstack安装与部署(Folsom)]]></title>
    <link href="http://agenge.github.io/blog/2013/06/12/openstack_install_with_deploy_for_folsom/"/>
    <updated>2013-06-12T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/06/12/openstack_install_with_deploy_for_folsom</id>
    <content type="html"><![CDATA[<h1>前言</h1>

<p>近2、3年来，云计算是一个比较热门的话题，无论是国外还是国内，众多计算机厂商开始涉足云计算，未来IaaS、SaaS及PaaS都可能将IT行业又推上到一个新的台阶。云计算谈得最多的IaaS要数 OpenStack，本文主要记录偶试
验的安装步骤，当然，参考了N多网友的博文，具有代表性的可能就是 <a href="http://www.stacklab.org/">stacklab</a> 的安装教程，以下就是具体安装步骤：</p>

<h2>环境准备</h2>

<p> ### 资源列表</p>

<table width="582" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td nowrap="nowrap" width="117">
<p align="center">IP
</td>
<td nowrap="nowrap" width="88">
<p align="center">主机名
</td>
<td nowrap="nowrap" width="87">
<p align="center">OS
</td>
<td nowrap="nowrap" width="70">
<p align="center">CPU
</td>
<td nowrap="nowrap" width="52">
<p align="center">内存
</td>
<td nowrap="nowrap" width="168">
<p align="center">备注
</td>
</tr>
<tr>
<td nowrap="nowrap" width="117">
<p align="center">192.168.30.73
</td>
<td nowrap="nowrap" width="88">
<p align="center">control-01
</td>
<td nowrap="nowrap" width="87">
<p align="center">Ubuntu 12.10
</td>
<td nowrap="nowrap" width="70">
<p align="center">i5
</td>
<td nowrap="nowrap" width="52">
<p align="center">16G
</td>
<td nowrap="nowrap" width="168">
<p align="center">keystone、glance、cinder、nova-api、nova-scheduler
</td>
</tr>
<tr>
<td nowrap="nowrap" width="117">
<p align="center">192.168.30.74
</td>
<td nowrap="nowrap" width="88">
<p align="center">compute-01
</td>
<td nowrap="nowrap" width="87">
<p align="center">Ubuntu 12.10
</td>
<td nowrap="nowrap" width="70">
<p align="center">i5
</td>
<td nowrap="nowrap" width="52">
<p align="center">16G
</td>
<td rowspan="3" nowrap="nowrap" width="168">
<p align="center">nova-compute、nova-network、nova-api-metadata
</td>
</tr>
<tr>
<td nowrap="nowrap" width="117">
<p align="center">192.168.30.75
</td>
<td nowrap="nowrap" width="88">
<p align="center">compute-02
</td>
<td nowrap="nowrap" width="87">
<p align="center">Ubuntu 12.10
</td>
<td nowrap="nowrap" width="70">
<p align="center">i5
</td>
<td nowrap="nowrap" width="52">
<p align="center">16G
</td>
</tr>
<tr>
<td nowrap="nowrap" width="117"></td>
<td nowrap="nowrap" width="88"></td>
<td nowrap="nowrap" width="87"></td>
<td nowrap="nowrap" width="70"></td>
<td nowrap="nowrap" width="52"></td>
</tr>
</tbody>
</table>


<h3>网络配置</h3>

<ol>
<li><p>在配置之前需要注意，如果你的网卡名称有叫非ethX，例如p1p1，就得按以下步骤修改：</p>

<pre><code> cd /etc/udev/rules.d/
 cp 70-persistent-net.rules 70-persistent-net.rules.bak
 ip a
</code></pre>

<p>可看到p1p1的MAC地址，如<strong>d4:3d:7e:57:a4:d4</strong>，将文件70-persistent-net.rules的：
     ATTR{address}==&ldquo;ec:88:8f:ea:c4:eb&rdquo;
修改为：
     ATTR{address}==&ldquo;d4:3d:7e:57:a4:d4&rdquo;</p></li>
</ol>


<p> NAME=&ldquo;eth1&rdquo; 修改为:NAME=&ldquo;eth2&rdquo; 或 NAME=&ldquo;eth0&#8221;，只要不和已存在的冲突即可，例如此示例中，本身已经存在一块叫： eth1的网卡，那另外一块就改成eth2。修改之后需要重启服务器。
所有节点配置如下（需要修改每个节点对应的IP）：</p>

<pre><code>    cat /etc/network/interfaces
    # This file describes the network interfaces available on your system
    # and how to activate them. For more information, see interfaces(5).
    # The loopback network interface
    auto lo
    iface lo inet loopback

    # The primary network interface
    auto eth1
    iface eth1 inet static
    address 192.168.30.75
    netmask 255.255.255.0
    network 192.168.30.0
    broadcast 192.168.30.255
    gateway 192.168.30.1
    # dns-* options are implemented by the resolvconf package, if installed
    dns-nameservers 218.201.4.3

    auto eth2
    iface eth2 inet static
    address 10.10.0.75
    netmask 255.255.0.0
</code></pre>

<p> 上面2个IP地址需要根据您的具体情况修改。
2. 重启网络</p>

<pre><code>     /etc/init.d/networking restart
</code></pre>

<ol>
<li><p>IP转发</p>

<pre><code> sudo su -
 sed -i -r 's/^s*#(net.ipv4.ip_forward=1.*)/1/' /etc/sysctl.conf
 echo 1 &gt; /proc/sys/net/ipv4/ip_forward
 sysctl -p
 net.ipv4.ip_forward = 1
</code></pre></li>
<li>更新源</li>
</ol>


<p> 在所有节点的/etc/apt/source.list 加入以下信息：</p>

<pre><code>    deb http://ubuntu-cloud.archive.canonical.com/ubuntu precise-proposed/folsom main
    deb http://ubuntu-cloud.archive.canonical.com/ubuntu precise-updates/folsom main
</code></pre>

<p> 然后执行：</p>

<pre><code>    gpg --keyserver keyserver.ubuntu.com --recv EC4926EA
    gpg --export --armor EC4926EA | sudo apt-key add -
    sudo apt-get update
</code></pre>

<p> 如果报错，请参考<a href="http://blog.csdn.net/wche1990/article/details/6759422">这里</a>.</p>

<!-- more -->


<h3>主机名设置</h3>

<p>在所有节点的/etc/hosts加入以下信息（需要修改每个节点对应的IP）：</p>

<pre><code>    192.168.30.73  control-01
    192.168.30.74  compute-01
    192.168.30.75  compute-02
</code></pre>

<h3>Mysql和rabbitmq安装</h3>

<p>在所有节点执行，密码统一设置为”123456”(你也可以设置为其他较安全的密码)：</p>

<pre><code>    sudo apt-get install -y mysql-server python-mysqldb
    sudo sed -i 's/127.0.0.1/0.0.0.0/g' /etc/mysql/my.cnf
    sudo /etc/init.d/mysql restart
    sudo apt-get install -y rabbitmq-server
</code></pre>

<h3>时间同步</h3>

<p>在所有节点执行：</p>

<pre><code>    sudo apt-get install -y ntp
    sudo sed -i 's/server ntp.ubuntu.com/server ntp.ubuntu.comnserver 127.127.1.0nfudge 127.127.1.0 stratum 10/g' /etc/ntp.conf
    sudo /etc/init.d/ntp restart
</code></pre>

<hr />

<h2>控制节点安装</h2>

<h3>安装OpenStack组件</h3>

<ol>
<li><p>在控制节点执行：</p>

<pre><code> os_keystone="keystone python-keystone python-keystoneclient"
 os_glance="glance glance-api python-glanceclient glance-common"
 os_nova="nova-api nova-cert nova-common  nova-scheduler python-nova python-novaclient nova-consoleauth novnc   nova-novncproxy "
 os_horizon="apache2 libapache2-mod-wsgi openstack-dashboard memcached python-memcache"
 os_cinder="cinder-api cinder-scheduler cinder-volume iscsitarget  open-iscsi iscsitarget-dkms python-cinderclient"
 os_swift="python-swift swift swift-proxy swift-account swift-container swift-object python-memcache"
 sudo apt-get install -y $os_keystone $os_glance $os_nova $os_horizon $os_cinder $os_swift

 大概要下载241M的文件。
</code></pre></li>
</ol>


<h3>初始化数据库</h3>

<ol>
<li><p>在控制节点执行，创建keystone, nova,cinder,glance数据库：</p>

<pre><code> mysql -uroot –p
 mysql&gt; CREATE DATABASE keystone;
 mysql&gt; CREATE DATABASE nova;
 mysql&gt; CREATE DATABASE cinder;
 mysql&gt; CREATE DATABASE glance;
 mysql&gt; GRANT ALL ON keystone.* TO openstack@'%' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON nova.* TO openstack@'%' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON cinder.* TO openstack@'%' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON glance.* TO openstack@'%' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON keystone.* TO openstack@'192.168.30.73' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON nova.* TO openstack@'192.168.30.73' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON nova.* TO openstack@'192.168.30.74' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON nova.* TO openstack@'192.168.30.75' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON cinder.* TO openstack@'192.168.30.73' IDENTIFIED BY 'openstack';
 mysql&gt; GRANT ALL ON glance.* TO openstack@'192.168.30.73' IDENTIFIED BY 'openstack';
 mysql&gt; flush privileges;
</code></pre></li>
</ol>


<h3>Keystone配置</h3>

<ul>
<li><p>在控制节点修改/etc/keystone/keystone.conf配置文件，注释第57行：</p>

<pre><code>  connection = sqlite:////var/lib/keystone/keystone.db
</code></pre>

<p>加入：</p>

<pre><code>   connection = mysql://openstack:openstack@192.168.30.73/keystone
</code></pre>

<p>重启keystone后，初始化数据库：</p>

<pre><code>   sudo /etc/init.d/keystone restart
   sudo keystone-manage db_sync
</code></pre></li>
<li><p>创建tenant、user、role，脚本keystone_basic.sh内容如下：</p>

<pre><code>     #!/bin/sh
     #
     # Keystone basic configuration

     # Mainly inspired by https://github.com/openstack/keystone/blob/master/tools/sample_data.sh

     # Modified by Bilel Msekni / Institut Telecom
     #
     # Support: openstack@lists.launchpad.net
     # License: Apache Software License (ASL) 2.0
     #
     #节点的IP地址
     HOST_IP=192.168.30.73
     ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin_pass}
     SERVICE_PASSWORD=${SERVICE_PASSWORD:-service_pass}
     export SERVICE_TOKEN="ADMIN"
     export SERVICE_ENDPOINT="http://${HOST_IP}:35357/v2.0"
     SERVICE_TENANT_NAME=${SERVICE_TENANT_NAME:-service}

     get_id () {
         echo `$@ | awk '/ id / { print $4 }'`
     }

     # Tenants
     ADMIN_TENANT=$(get_id keystone tenant-create --name=admin)
     SERVICE_TENANT=$(get_id keystone tenant-create --name=$SERVICE_TENANT_NAME)


     # Users
     ADMIN_USER=$(get_id keystone user-create --name=admin --pass="$ADMIN_PASSWORD" --email=admin@domain.com)


     # Roles
     ADMIN_ROLE=$(get_id keystone role-create --name=admin)
     KEYSTONEADMIN_ROLE=$(get_id keystone role-create --name=KeystoneAdmin)
     KEYSTONESERVICE_ROLE=$(get_id keystone role-create --name=KeystoneServiceAdmin)

     # Add Roles to Users in Tenants
     keystone user-role-add --user-id $ADMIN_USER --role-id $ADMIN_ROLE --tenant-id $ADMIN_TENANT
     keystone user-role-add --user-id $ADMIN_USER --role-id $KEYSTONEADMIN_ROLE --tenant-id $ADMIN_TENANT
     keystone user-role-add --user-id $ADMIN_USER --role-id $KEYSTONESERVICE_ROLE --tenant-id $ADMIN_TENANT

     # The Member role is used by Horizon and Swift
     MEMBER_ROLE=$(get_id keystone role-create --name=Member)

     # Configure service users/roles
     NOVA_USER=$(get_id keystone user-create --name=nova --pass="$SERVICE_PASSWORD" --tenant-id $SERVICE_TENANT --email=nova@domain.com)
     keystone user-role-add --tenant-id $SERVICE_TENANT --user-id $NOVA_USER --role-id $ADMIN_ROLE

     GLANCE_USER=$(get_id keystone user-create --name=glance --pass="$SERVICE_PASSWORD" --tenant-id $SERVICE_TENANT --email=glance@domain.com)
     keystone user-role-add --tenant-id $SERVICE_TENANT --user-id $GLANCE_USER --role-id $ADMIN_ROLE

     CINDER_USER=$(get_id keystone user-create --name=cinder --pass="$SERVICE_PASSWORD" --tenant-id $SERVICE_TENANT --email=cinder@domain.com)
     keystone user-role-add --tenant-id $SERVICE_TENANT --user-id $CINDER_USER --role-id $ADMIN_ROLE
</code></pre></li>
<li><p>创建endpoint，脚本keystone_endpoints_basic.sh内容如下:</p>

<pre><code>     #!/bin/sh
     #
     # Keystone basic Endpoints

     # Mainly inspired by https://github.com/openstack/keystone/blob/master/tools/sample_data.sh

     # Modified by Bilel Msekni / Institut Telecom
     #
     # Support: openstack@lists.launchpad.net
     # License: Apache Software License (ASL) 2.0
     #

     # Host address
     #节点的manage network的IP地址
     HOST_IP=192.168.30.73
     #节点的public network的IP地址
     EXT_HOST_IP=192.168.30.73

     # MySQL definitions
     MYSQL_USER=openstack
     MYSQL_DATABASE=keystone
     MYSQL_HOST=$HOST_IP
     MYSQL_PASSWORD=openstack

     # Keystone definitions
     KEYSTONE_REGION=RegionOne
     export SERVICE_TOKEN=ADMIN
     export SERVICE_ENDPOINT="http://${HOST_IP}:35357/v2.0"

     while getopts "u:D:p:m:K:R:E:T:vh" opt; do
     case $opt in
         u)
           MYSQL_USER=$OPTARG
           ;;
         D)
           MYSQL_DATABASE=$OPTARG
           ;;
         p)
           MYSQL_PASSWORD=$OPTARG
           ;;
         m)
           MYSQL_HOST=$OPTARG
           ;;
         K)
           MASTER=$OPTARG
           ;;
         R)
           KEYSTONE_REGION=$OPTARG
           ;;
         E)
           export SERVICE_ENDPOINT=$OPTARG
           ;;
         T)
           export SERVICE_TOKEN=$OPTARG
           ;;
         v)
           set -x
           ;;
         h)
           cat &lt;&lt;EOF
     Usage: $0 [-m mysql_hostname] [-u mysql_username] [-D mysql_database] [-p mysql_password]
     [-K keystone_master ] [ -R keystone_region ] [ -E keystone_endpoint_url ]
     [ -T keystone_token ]
     Add -v for verbose mode, -h to display this message.
     EOF
           exit 0
           ;;
         \?)
           echo "Unknown option -$OPTARG" &gt;&amp;2
           exit 1
           ;;
         :)
           echo "Option -$OPTARG requires an argument" &gt;&amp;2
           exit 1
           ;;
       esac
     done

     if [ -z "$KEYSTONE_REGION" ]; then
     echo "Keystone region not set. Please set with -R option or set KEYSTONE_REGION variable." &gt;&amp;2
       missing_args="true"
     fi

     if [ -z "$SERVICE_TOKEN" ]; then
     echo "Keystone service token not set. Please set with -T option or set SERVICE_TOKEN variable." &gt;&amp;2
       missing_args="true"
     fi

     if [ -z "$SERVICE_ENDPOINT" ]; then
     echo "Keystone service endpoint not set. Please set with -E option or set SERVICE_ENDPOINT variable." &gt;&amp;2
       missing_args="true"
     fi

     if [ -z "$MYSQL_PASSWORD" ]; then
     echo "MySQL password not set. Please set with -p option or set MYSQL_PASSWORD variable." &gt;&amp;2
       missing_args="true"
     fi

     if [ -n "$missing_args" ]; then
     exit 1
     fi
     keystone service-create --name nova --type compute --description 'OpenStack Compute Service'
     keystone service-create --name cinder --type volume --description 'OpenStack Volume Service'
     keystone service-create --name glance --type image --description 'OpenStack Image Service'
     keystone service-create --name keystone --type identity --description 'OpenStack Identity'
     keystone service-create --name ec2 --type ec2 --description 'OpenStack EC2 service'

     create_endpoint () {
       case $1 in
         compute)
         keystone endpoint-create --region $KEYSTONE_REGION --service-id $2 --publicurl 'http://'"$EXT_HOST_IP"':8774/v2/$(tenant_id)s' --adminurl 'http://'"$HOST_IP"':8774/v2/$(tenant_id)s' --internalurl 'http://'"$HOST_IP"':8774/v2/$(tenant_id)s'
         ;;
         volume)
         keystone endpoint-create --region $KEYSTONE_REGION --service-id $2 --publicurl 'http://'"$EXT_HOST_IP"':8776/v1/$(tenant_id)s' --adminurl 'http://'"$HOST_IP"':8776/v1/$(tenant_id)s' --internalurl 'http://'"$HOST_IP"':8776/v1/$(tenant_id)s'
         ;;
         image)
         keystone endpoint-create --region $KEYSTONE_REGION --service-id $2 --publicurl 'http://'"$EXT_HOST_IP"':9292/v2' --adminurl 'http://'"$HOST_IP"':9292/v2' --internalurl 'http://'"$HOST_IP"':9292/v2'
         ;;
         identity)
         keystone endpoint-create --region $KEYSTONE_REGION --service-id $2 --publicurl 'http://'"$EXT_HOST_IP"':5000/v2.0' --adminurl 'http://'"$HOST_IP"':35357/v2.0' --internalurl 'http://'"$HOST_IP"':5000/v2.0'
         ;;
         ec2)
         keystone endpoint-create --region $KEYSTONE_REGION --service-id $2 --publicurl 'http://'"$EXT_HOST_IP"':8773/services/Cloud' --adminurl 'http://'"$HOST_IP"':8773/services/Admin' --internalurl 'http://'"$HOST_IP"':8773/services/Cloud'
         ;;
       esac
     }

     for i in compute volume image object-store identity ec2; do
     id=`mysql -h "$MYSQL_HOST" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" -ss -e "SELECT id FROM service WHERE type='"$i"';"` || exit 1
       create_endpoint $i $id
     done
</code></pre></li>
<li><p>依次执行：</p>

<pre><code>  sudo chmod +x keystone_*.sh
  sudo ./keystone_basic.sh
  sudo ./keystone_endpoints_basic.sh
</code></pre></li>
<li><p>创建openrc文件（环境变量）</p>

<pre><code>  export OS_TENANT_NAME=admin
  export OS_USERNAME=admin
  export OS_PASSWORD=admin_password
  export OS_AUTH_URL=http://192.168.30.73:5000/v2.0/
  export EC2_URL=$(keystone catalog --service ec2 | awk '/ publicURL / { print $4 }')
  export CREDS=$(keystone ec2-credentials-create)
  export EC2_ACCESS_KEY=$(echo "$CREDS" | awk '/ access / { print $4 }')
  export EC2_SECRET_KEY=$(echo "$CREDS" | awk '/ secret / { print $4 }')
</code></pre></li>
<li><p>使环境变量生效：</p>

<pre><code>  source openrc
</code></pre></li>
<li><p>测试keystone</p>

<pre><code>  keystone user-list
</code></pre></li>
</ul>


<p>如果没问题，输出内容类似下图：</p>

<p><img src="http://agenge.github.io/images/2013/06/01.png" title="" ></p>

<hr />

<h3>Glance配置</h3>

<h4>更新配置文件</h4>

<ol>
<li><p>更新glance配置文件：</p>

<pre><code> sudo vi /etc/glance/glance-api-paste.in
</code></pre></li>
</ol>


<p> 将最后三行修改为：</p>

<pre><code>    [filter:authtoken]
    paste.filter_factory = keystone.middleware.auth_token:filter_factory
    auth_host = 192.168.30.73
    auth_port = 35357
    auth_protocol = http
    admin_tenant_name = service
    admin_user = glance
    admin_password = service_password
</code></pre>

<ol>
<li><p>更新glance配置文件：</p>

<pre><code> sudo vi /etc/glance/glance-registry-paste.ini
</code></pre></li>
</ol>


<p> 将最后三行修改为：</p>

<pre><code>    [filter:authtoken]
    paste.filter_factory = keystone.middleware.auth_token:filter_factory
    auth_host = 192.168.30.73
    auth_port = 35357
    auth_protocol = http
    admin_tenant_name = service
    admin_user = glance
    admin_password = service_password
</code></pre>

<ol>
<li><p>更新glance配置文件：</p>

<pre><code> sudo vim /etc/glance/glance-api.conf
</code></pre>

<p> 将49行注释，并加入：</p>

<pre><code> sql_connection = mysql://openstack:openstack@192.168.30.73/glance
</code></pre>

<p> 在[paste_deploy]（一般在最后几行）节点加入：</p>

<pre><code> flavor = keystone
</code></pre></li>
<li><p>更新glance配置文件：</p>

<pre><code> sudo vim /etc/glance/glance-registry.conf
</code></pre>

<p> 将28行注释，并加入：</p>

<pre><code> sql_connection = mysql://openstack:openstack@192.168.30.73/glance
 [paste_deploy]
 flavor = keystone
</code></pre></li>
<li><p>重启glance服务</p>

<pre><code> /etc/init.d/glance-api restart
 sudo /etc/init.d/glance-registry restart
</code></pre></li>
<li><p>同步数据库</p>

<pre><code> sudo glance-manage db_sync
</code></pre>

<p> 并再次重启glance服务：</p>

<pre><code> sudo /etc/init.d/glance-api restart
 sudo /etc/init.d/glance-registry restart
</code></pre></li>
</ol>


<h4>上传镜像文件</h4>

<pre><code>wget https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img
source openrc
glance image-create --name myFirstVM --is-public true --container-format bare --disk-format qcow2 &amp;lt; cirros-0.3.0-x86_64-disk.img
</code></pre>

<p>如果一切正常，会输出类似以下内容：</p>

<p><img src="http://agenge.github.io/images/2013/06/02.png" title="" ></p>

<hr />

<h3>Cinder配置</h3>

<h4>配置iscsi</h4>

<ol>
<li><p>配置iscsitarget：</p>

<pre><code> sudo sed -i 's/false/true/g' /etc/default/iscsitarget
 sudo /etc/init.d/iscsitarget restart
 sudo /etc/init.d/open-iscsi restart
</code></pre></li>
<li><p>更新配置文件/etc/cinder/api-paste.ini（47行）：</p>

<pre><code> [filter:authtoken]
 paste.filter_factory = keystone.middleware.auth_token:filter_factory
 service_protocol = http
 service_host = 192.168.30.73
 service_port = 5000
 auth_host = 192.168.30.73
 auth_port = 35357
 auth_protocol = http
 admin_tenant_name = service
 admin_user = cinder
 admin_password = service_password
</code></pre></li>
<li><p>更新配置文件/etc/cinder/cinder.conf：</p>

<pre><code> [DEFAULT]
 rootwrap_config = /etc/cinder/rootwrap.conf
 sql_connection = mysql://openstack:openstack@192.168.30.73/cinder
 api_paste_confg = /etc/cinder/api-paste.ini
 iscsi_helper = tgtadm
 volume_name_template = volume-%s
 volume_group = cinder-volumes
 verbose = True
 auth_strategy = keystone
 state_path = /var/lib/cinder
 volumes_dir = /var/lib/cinder/volumes
</code></pre></li>
<li><p>同步数据库：</p>

<pre><code> sudo cinder-manage db sync
</code></pre></li>
</ol>


<h4>创建VG</h4>

<ol>
<li><p>没有独立的硬盘或分区按以下操作：</p>

<p> sudo mkdir -p /opt/data/cinder
 cd /opt/data/cinder
 sudo truncate -s 2G vgfile
 sudo losetup -f &mdash;show vgfile</p></li>
</ol>


<p> 如果正常，会输出以下内容：</p>

<pre><code>    /dev/loop0
</code></pre>

<p> 接下来开始创建vg：</p>

<pre><code>    sudo vgcreate cinder-volumes /dev/loop0
</code></pre>

<p> 如果正常，会输出以下内容：</p>

<pre><code>    No physical volume label read from /dev/loop0
    Writing physical volume data to disk "/dev/loop0"
    Physical volume "/dev/loop0" successfully created
    Volume group "cinder-volumes" successfully created
</code></pre>

<ol>
<li><p>有独立的硬盘或分区按以下操作(<strong>以/dev/sda7</strong><strong>为例，以下操作有数据丢失风险，请谨慎操作</strong>)：</p>

<pre><code> pvcreate /dev/sda7
 vgcreate cinder-volumes /dev/sda7
 lvcreate -L 1T -n instance-lv data-vg
 mkfs.ext4 /dev/data-vg/instance-lv
 echo "/dev/data-vg/instance-lv        /var/lib/nova/instances ext4    defaults        0 0" &gt;&gt; /etc/fstab
 mount -a
</code></pre></li>
</ol>


<p> 重启cinder所有相关服务：</p>

<pre><code>    sudo /etc/init.d/cinder-api restart
    sudo /etc/init.d/cinder-scheduler restart
    sudo /etc/init.d/cinder-volume restart
</code></pre>

<hr />

<h3>Nova配置</h3>

<ol>
<li><p>更新配置文件/etc/nova/api-paste.ini（最后几行）：</p>

<pre><code> [filter:authtoken]
 paste.filter_factory = keystone.middleware.auth_token:filter_factory
 auth_host = 192.168.30.73
 auth_port = 35357
 auth_protocol = http
 admin_tenant_name = service
 admin_user = nova
 admin_password = service_password
 signing_dir = /tmp/keystone-signing-nova
</code></pre></li>
<li><p>更新配置文件/etc/nova/nova.conf</p>

<pre><code> [DEFAULT]
 dhcpbridge_flagfile=/etc/nova/nova.conf
 dhcpbridge=/usr/bin/nova-dhcpbridge
 logdir=/var/log/nova
 state_path=/var/lib/nova
 lock_path=/var/lock/nova
 force_dhcp_release=True
 iscsi_helper=tgtadm
 libvirt_use_virtio_for_bridges=True
 connection_type=libvirt
 root_helper=sudo nova-rootwrap /etc/nova/rootwrap.conf
 verbose=True
 ec2_private_dns_show_ip=True
 api_paste_config=/etc/nova/api-paste.ini
 volumes_path=/var/lib/nova/volumes

 # AUTHENTICATION
 auth_strategy=keystone

 # SCHEDULER
 scheduler_driver=nova.scheduler.multi.MultiScheduler
 compute_scheduler_driver=nova.scheduler.filter_scheduler.FilterScheduler

 # CINDER
 volume_api_class=nova.volume.cinder.API

 # DATABASE
 sql_connection=mysql://openstack:openstack@192.168.30.73/nova

 # COMPUTE
 # kvm or QUME
 libvirt_type=kvm  
 libvirt_use_virtio_for_bridges=True
 start_guests_on_host_boot=True
 resume_guests_state_on_host_boot=True
 api_paste_config=/etc/nova/api-paste.ini
 allow_admin_api=True
 use_deprecated_auth=False
 nova_url=http://192.168.30.73:8774/v1.1/
 root_helper=sudo nova-rootwrap /etc/nova/rootwrap.conf

 # APIS
 ec2_host=192.168.30.73
 ec2_url=http://192.168.30.73:8773/services/Cloud
 keystone_ec2_url=http://192.168.30.73:5000/v2.0/ec2tokens
 s3_host=192.168.30.73
 cc_host=192.168.30.73
 metadata_host=192.168.30.73
 enabled_apis=ec2,osapi_compute,metadata

 # RABBITMQ
 rabbit_host=192.168.30.73

 # GLANCE
 image_service=nova.image.glance.GlanceImageService
 glance_api_servers=192.168.30.73:9292

 # NETWORK
 network_manager=nova.network.manager.FlatDHCPManager
 force_dhcp_release=True
 dhcpbridge_flagfile=/etc/nova/nova.conf
 dhcpbridge=/usr/bin/nova-dhcpbridge
 firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver
 public_interface=eth0    
 flat_interface=eth1     
 flat_network_bridge=br100
 fixed_range=10.10.0.0/24   
 network_size=256
 flat_injected=False
 connection_type=libvirt
 multi_host=True

 # NOVNC CONSOLE
 novnc_enabled=True
 novncproxy_base_url=http://192.168.30.73:6080/vnc_auto.html
 vncserver_proxyclient_address=192.168.30.73
 vncserver_listen=192.168.30.73
</code></pre></li>
<li><p>修改配置文件/etc/sudoers，在最后一行追加：</p>

<pre><code> nova ALL=(ALL) NOPASSWD:ALL
</code></pre></li>
<li><p>同步数据库</p>

<pre><code> sudo nova-manage db sync
</code></pre></li>
<li><p>重启nova相关服务</p>

<pre><code> sudo /etc/init.d/nova-api restart
 sudo /etc/init.d/nova-cert restart
 sudo /etc/init.d/nova-consoleauth restart
 sudo /etc/init.d/nova-novncproxy restart
 sudo /etc/init.d/nova-scheduler restart
</code></pre></li>
<li><p>检查服务状态</p>

<pre><code> sudo nova-manage service list
</code></pre></li>
</ol>


<p> 如果正常，会输出类似以下信息：</p>

<p><img src="http://agenge.github.io/images/2013/06/03.png" title="" ></p>

<ol>
<li><p>创建fixed_ip（内网虚拟机IP）</p>

<pre><code> sudo nova-manage network create private --fixed_range_v4=10.10.0.0/24 --num_networks=1 --bridge=br100 --bridge_interface=eth2 --network_size=256 --multi_host=T
</code></pre></li>
<li><p>创建floating_ip（可以理解为floating_rang，并非一个具体的IP地址），它和公网一个段的IP:</p>

<pre><code> nova-manage floating create 192.168.30.1/24
</code></pre></li>
<li><p>设置安全策略</p>

<pre><code> nova secgroup-add-rule default tcp 1 65535 0.0.0.0/0
 nova secgroup-add-rule default udp 1 65535 0.0.0.0/0
 nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0
</code></pre></li>
</ol>


<hr />

<h2>计算节点安装</h2>

<h3>安装OpenStack组件</h3>

<pre><code>os_nova="nova-common python-nova python-novaclient nova-compute nova-network nova-api-metadata"
os_other="kvm libvirt-bin pm-utils bridge-utils"
sudo apt-get install -y $os_nova $os_other
</code></pre>

<p>大约71M左右。</p>

<h3>Nova配置</h3>

<ol>
<li><p>更新配置文件/etc/nova/nova.conf</p>

<pre><code> [DEFAULT]
 logdir=/var/log/nova
 state_path=/var/lib/nova
 lock_path=/run/lock/nova
 verbose=False
 api_paste_config=/etc/nova/api-paste.ini
 scheduler_driver=nova.scheduler.simple.SimpleScheduler
 s3_host=192.168.30.73
 ec2_host=192.168.30.73
 ec2_dmz_host=192.168.30.73
 rabbit_host=192.168.30.73
 cc_host=192.168.30.73
 metadata_host=10.0.0.7
 nova_url=http://192.168.30.73:8774/v1.1/
 sql_connection=mysql://openstack:openstack@192.168.30.73/nova
 ec2_url=http://192.168.30.73:8773/services/Cloud
 root_helper=sudo nova-rootwrap /etc/nova/rootwrap.conf

 # Auth
 use_deprecated_auth=false
 auth_strategy=keystone
 keystone_ec2_url=http://192.168.30.73:5000/v2.0/ec2tokens
 # Imaging service
 glance_api_servers=192.168.30.73:9292
 image_service=nova.image.glance.GlanceImageService

 # NOVNC CONSOLE
 novnc_enabled=True
 novncproxy_base_url=http://192.168.30.73:6080/vnc_auto.html
 vncserver_proxyclient_address=192.168.30.74
 vncserver_listen=192.168.30.74

 # Network settings
 network_manager=nova.network.manager.FlatDHCPManager
 dhcpbridge_flagfile=/etc/nova/nova.conf
 dhcpbridge=/usr/bin/nova-dhcpbridge
 firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver
 public_interface=eth0
 flat_interface=eth1
 flat_network_bridge=br100
 fixed_range=10.10.0.1/24
 floating_range=192.168.30.128/24
 network_size=250
 flat_network_dhcp_start=10.0.0.40
 flat_injected=false
 force_dhcp_release=true
 dhcp_lease_time=604800
 multi_host=true
 iscsi_helper=tgtadm
 connection_type=libvirt
 # Compute #
 compute_driver=libvirt.LibvirtDriver

 # Cinder #
 volume_api_class=nova.volume.cinder.API
 osapi_volume_listen_port=5900
</code></pre></li>
<li><p>修改配置文件/etc/nova/nova-compute.conf</p>

<pre><code> [DEFAULT]
 libvirt_type=kvm
</code></pre></li>
</ol>


<p> 除了KVM，你还可以修改成其他的，例如QEMU/XEN等。</p>

<ol>
<li><p>禁用默认的网桥</p>

<pre><code> virsh net-autostart default --disable
 virsh net-destroy default
</code></pre></li>
<li><p>重启nova相关服务</p>

<pre><code> sudo /etc/init.d/nova-api-metadata restart
 sudo /etc/init.d/nova-compute restart
 sudo /etc/init.d/nova-network restart
</code></pre></li>
</ol>


<hr />

<h2>访问OpenStack DashBoard</h2>

<p>在控制节点重启httpd和memcached：</p>

<pre><code>sudo /etc/init.d/apache2 restart
sudo /etc/init.d/memcached restart
</code></pre>

<p>访问 <a href="http://192.168.30.73/horizon">http://192.168.30.73/horizon</a>，用户名和密码分别是admin/admin_password</p>

<hr />

<h2>日常管理</h2>

<h3>控制节点管理</h3>

<h4>创建实例</h4>

<h5>创建虚拟机密钥对</h5>

<p>在控制节点执行以下语句：</p>

<pre><code>    root@control-01:~# ssh-keygen 
    Generating public/private rsa key pair.
    Enter file in which to save the key (/root/.ssh/id_rsa): 
    Created directory '/root/.ssh'.
    Enter passphrase (empty for no passphrase): 
    Enter same passphrase again: 
    Your identification has been saved in /root/.ssh/id_rsa.
    Your public key has been saved in /root/.ssh/id_rsa.pub.
    The key fingerprint is:
    6b:6e:2f:b5:b5:73:a6:8e:96:bf:c0:a5:84:7c:c5:92 root@control-01
    The key's randomart image is:
    +--[ RSA 2048]----+
    |                 |
    |           o     |
    |          E o    |
    |       . . o     |
    |        S o .    |
    |         =.o.    |
    |        o.++ .   |
    |       oo +oo o  |
    |       ..+oo=*   |
    +-----------------+
</code></pre>

<h5>导入密钥</h5>

<pre><code>    nova keypair-add --pub_key .ssh/id_rsa.pub key2
    nova keypair-list
    +------+-------------------------------------------------+
    | Name | Fingerprint                                     |
    +------+-------------------------------------------------+
    | key2 | 6b:6e:2f:b5:b5:73:a6:8e:96:bf:c0:a5:84:7c:c5:92 |
    +------+-------------------------------------------------+
</code></pre>

<h5>查看镜像</h5>

<pre><code>    nova image-list
    +--------------------------------------+--------------+--------+--------+
    | ID                                   | Name         | Status | Server |
    +--------------------------------------+--------------+--------+--------+
    | 533457ef-a1fe-41e0-a351-908975d3550b   | myFirstImage   | ACTIVE |        |
    +--------------------------------------+--------------+--------+--------+
</code></pre>

<p>镜像的创建方法请见上传镜像文件。</p>

<h5>查看虚拟机配置模板</h5>

<pre><code>    nova flavor-list
</code></pre>

<h5>创建实例(虚拟机)</h5>

<pre><code>    nova boot --flavor 1 --image 533457ef-a1fe-41e0-a351-908975d3550b --key_name key2 myFirstvm
</code></pre>

<p>创建一个名叫：myFirstvm的实例。</p>

<ul>
<li>&mdash;image             表示使用的哪个镜像文件</li>
<li>&mdash;flavor             使用哪个配置模板，具体见查看虚拟机配置模板</li>
<li>&mdash;key_name       指定密钥文件</li>
</ul>


<p>在创建之后会输出以下类似信息：</p>

<p><img src="http://agenge.github.io/images/2013/06/04.png" title="" ></p>

<p>从图中可看出正在创建一个实例。</p>

<h4>配置网络</h4>

<h5>创建与绑定公网</h5>

<ol>
<li><p>创建一个公网IP，在控制节点执行以下语句：</p>

<pre><code> nova  floating-ip-create
</code></pre></li>
<li><p>创建指定的公网IP</p></li>
</ol>


<p> floating-ip-create只是创建一个随机可用（IP池）的可用公网IP，那如何要创建一个指定的IP如何操作？没关系，nova可以做到，请看操作：</p>

<pre><code>    nova add-floating-ip test01 192.168.30.6
</code></pre>

<ol>
<li><p>绑定公网IP地址到虚拟机</p>

<pre><code> nova add-floating-ip vm01 192.168.30.1
</code></pre></li>
</ol>


<p> 表示绑定到vm01这个虚拟机。可通过查看虚拟机状态看到：</p>

<pre><code>    nova show vm01
</code></pre>

<h5>防火墙设置</h5>

<ol>
<li><p>允许SSH登录</p>

<pre><code> nova secgroup-add-rule default tcp 22 22 0.0.0.0/0
</code></pre></li>
<li><p>允许ICMP Ping</p>

<pre><code> nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0
</code></pre></li>
<li><p>查看防火墙设置</p>

<pre><code> nova secgroup-list-rules default
</code></pre></li>
</ol>


<h5>删除或解绑floating-ip</h5>

<p>如果某个公网IP不再需要，你可以通过删除或解绑它：</p>

<pre><code>    nova remove-floating-ip test01 192.168.30.6
</code></pre>

<p>或</p>

<pre><code>    nova floating-ip-delete test01 192.168.30.6
</code></pre>

<p>删除之后就会从IP池释放出来，以供其他Tenant使用。</p>

<hr />

<h3>Cinder管理</h3>

<ol>
<li><p>列出当前用户所有资源</p>

<pre><code> cinder absolute-limits
</code></pre></li>
<li><p>创建一个Volume</p>

<pre><code> cinder create --display_name cin01 10
</code></pre></li>
<li><p>&mdash;display_name为volume名称，后面的数字表示为10G。</p></li>
<li><p>查看Volume</p>

<pre><code> cinder list
</code></pre></li>
</ol>


<p> 或者</p>

<pre><code>    nova volume-list
</code></pre>

<hr />

<h3>计算节点管理</h3>

<h4>KVM驱动</h4>

<p>要启用KVM，只需要在/etc/nova/nova.conf加入：</p>

<pre><code>    libvirt_type=kvm
    compute_driver=libvirt.LibvirtDriver
</code></pre>

<p>KVM支持的虚拟机镜像格式：RAW、QCOW2、VMDK</p>

<h4>QEMU驱动</h4>

<p>要启用QEMU，只需要在/etc/nova/nova.conf加入：</p>

<pre><code>    libvirt_type=qemu
    compute_driver=libvirt.LibvirtDriver
</code></pre>

<p>QEMU支持的虚拟机镜像格式：RAW、QCOW2、VMDK</p>

<h4>Xen驱动</h4>

<p>要启用Xen，包括Xen, XenAPI, XenServer and XCP，只需要在/etc/nova/nova.conf加入：</p>

<pre><code>    compute_driver=xenapi.XenAPIDriver
    xenapi_connection_url=http://your_xenapi_management_ip_address
    xenapi_connection_username=root
    xenapi_connection_password=your_password
</code></pre>

<p>XenAPI支持的虚拟机镜像格式：RAW、VHD</p>

<p>如果您的Xen使用的libvirt管理，只需要在/etc/nova/nova.conf加入：</p>

<pre><code>    libvirt_type=xen
    compute_driver=libvirt.LibvirtDriver
</code></pre>

<hr />

<h3>Glance管理</h3>

<h4>磁盘格式</h4>

<ul>
<li><p>raw 此格式支持兼容转换其他格式文件，类似于中间格式，最大的缺点是<strong>不支持虚拟机的快照功能</strong>，使用空间类似于物理磁盘，使用多少空间实际上就是多少空间，可以通过du -h file.raw 来查看它真正的大小，而ls -lh看到的就是整个raw文件大小（包括剩余空间）</p></li>
<li><p>qcow2 更小的存储空间，du -h 和ls -h看到的大小一样。且支持虚拟机的快照功能，性能接近于 raw 格式的文件。支持AES加密、zlib压缩。</p></li>
<li><p>vhd 微软的虚拟磁盘文件，不过也兼容其他虚拟软件。</p></li>
<li><p>vmdk VMware的专有格式，其在自身的虚拟环境中，无论从性能还是功能，都是最强大、最稳定的，其他虚拟化软件较少用到。</p></li>
<li><p>iso 经典的ISO文件，不多介绍。</p></li>
<li><p>vdi VirtualBox的专有格式，一般服务器虚拟化也很少用到。</p></li>
<li><p>aki Amazon内核镜像文件。</p></li>
<li><p>ari Amazon 内存（ramdisk）镜像文件。</p></li>
<li><p>ami Amazon机器镜像文件。</p></li>
</ul>


<h4>容器格式</h4>

<p>Glance的container format主要包括以下格式：</p>

<ul>
<li><p>bare                  表示镜像没有包括container或元数据，如果不知道选哪个格式，就选bare吧。</p></li>
<li><p>ovf                   开放式虚拟磁盘文件，最初由VMware发起，支持多种虚拟化。</p></li>
<li><p>aki                    Amazon内核镜像文件，在 磁盘格式设置为 aki 时使用。</p></li>
<li><p>ari                    Amazon 内存（ramdisk）镜像文件，在 磁盘格式设置为 ari 时使用。</p></li>
<li><p>ami                   Amazon机器镜像文件，在 磁盘格式设置为 ami 时使用。</p></li>
</ul>


<p>关于安装与部署，偶暂时写到这里，这只是很简单的一个入门例子而已，下次偶会介绍
如何制作CentOS5.5、CentOS 6.3及Windows Server 2008的镜像，很多同学因镜像而烦恼。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Zabbix配置与报警设置]]></title>
    <link href="http://agenge.github.io/blog/2013/05/29/zabbix-config-emailalert/"/>
    <updated>2013-05-29T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/05/29/zabbix-config-emailalert</id>
    <content type="html"><![CDATA[<p>上次偶写了一篇<a href="http://agenge.com/blog/2013/05/02/zabbix-source-install-conf">Zabbix 源码安装与配置</a> ，安装之后默认是无法监控客户端主机滴，所以偶今天专门写篇文章来介绍Zabbix配置，主要涉及到：添加主机、邮件报警及一些常见的操作流程，希望对初学者有所帮助。</p>

<h2>监控机</h2>

<p>通在安装Zabbix之后，还需要在Web管理控制台添加需要监控的主机，下列是以添加一台监控主机为例进行演示。</p>

<ol>
<li>“Configuration” &ndash;> “Hosts”，点击添加一台主机“Host”:</li>
</ol>


<p> <img src="http://agenge.github.io/images/2013/05/01.jpg" title="" ></p>

<ol>
<li>需要填写的内容主要为：“主机(Host)”、“模板(Templates)”，详细操作请见下列图中所示：主机的设置如下：</li>
</ol>


<p> <img src="http://agenge.github.io/images/2013/05/02.jpg" title="" >
 模板的设置如下：</p>

<p> <img src="http://agenge.github.io/images/2013/05/03.jpg" title="" ></p>

<p> 点击“添加(Add)”之后，从弹出的子页面选择需要的模板，Zabbix默认已自带非常多的模板，</p>

<p> 例如Mysql、Zabbix Server、Zabbix Agentd、OS Linux等。</p>

<p>  <img src="http://agenge.github.io/images/2013/05/04.jpg" title="" ></p>

<p> 勾选所需要的监控模板后，点击最下边的“选择(Select)”，回到之前的模板标签页，最后一定要记得保存(Save)。</p>

<p>  <img src="http://agenge.github.io/images/2013/05/05.jpg" title="" ></p>

<ol>
<li>如果一切正常，默认在1分钟之后就会变成可用状态：
<img src="http://agenge.github.io/images/2013/05/06.jpg" title="" ></li>
</ol>


<!-- more -->


<h2>报警设置</h2>

<p>在添加监控主机之后，还需要邮件报警设置，否则监控人员无法及时掌握系统状态，报警一般是邮件报警与短信报警，甚至相两者结合。 其中邮件报警又可分为自定义脚本警报和自己搭建邮件服务器进行报警，短信报警暂时不涉及，后面会有专门章节进行介绍，本章只涉及到自定义邮件报警的设置，使用一个Msmtp（兼容SendMail接口的SMTP客户端. 工具，关于它的原理介绍，请自行搜索。下面是详细的安装步骤：</p>

<h3>邮件报警设置</h3>

<ol>
<li>安装</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar jxvf msmtp-1.4.31.tar.bz2
</span><span class='line'>cd msmtp-1.4.31
</span><span class='line'>./configure --prefix=/usr/local/msmtp
</span><span class='line'>make && make install
</span><span class='line'>mkdir /usr/local/msmtp/etc
</span><span class='line'>touch /usr/local/msmtp/etc/msmtprc</span></code></pre></td></tr></table></div></figure>


<ol>
<li>配置</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /usr/local/msmtp/etc/msmtprc
</span><span class='line'>########################################
</span><span class='line'>defaults
</span><span class='line'>account default
</span><span class='line'>host smtp.139.com
</span><span class='line'>port 25
</span><span class='line'>from taurus52@139.com
</span><span class='line'>auth login
</span><span class='line'>tls off
</span><span class='line'>user taurus52@139.com
</span><span class='line'>password 123456
</span><span class='line'>logfile /var/log/mmlog
</span><span class='line'>########################################</span></code></pre></td></tr></table></div></figure>


<p> host/from/user/password这三个字段，请根据具体情况修改。</p>

<p> 安装Mutt，Mutt是一个邮件用户代理工作，其本身不发送和接收邮件，需要调用邮件传输代码(例如Msmtp或sendmail) 来发送和接收邮件.</p>

<pre><code>```
yum -y install mutt
vim /etc/Muttrc
set sendmail="/usr/local/msmtp/bin/msmtp"
set use_from=yes
set realname="taurus52@163.com"
set editor="vi"
</code></pre>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  * /etc/Muttrc为全局设置，如果只是对某个用户设置，可以在~/muttrc中设置。
</span><span class='line'>  * sendmail设置为msmtp的绝对路径
</span><span class='line'>  * realname 设置你的email地址
</span><span class='line'>  * editor 设置为你的编辑器，如果你中emacs忠实用户，也是可以滴。
</span><span class='line'>
</span><span class='line'> 测试是否能够发送邮件：</span></code></pre></td></tr></table></div></figure>


<p>echo &ldquo;this is a test mail&rdquo; >> /tmp/files
echo &ldquo;testmail&rdquo; | mutt -s &ldquo;test&rdquo; -a /tmp/files  <a href="&#109;&#97;&#x69;&#108;&#116;&#x6f;&#58;&#x74;&#101;&#115;&#x74;&#x5f;&#122;&#97;&#x62;&#98;&#x69;&#120;&#64;&#x67;&#x6d;&#97;&#105;&#x6c;&#46;&#99;&#x6f;&#x6d;">&#x74;&#x65;&#x73;&#x74;&#x5f;&#122;&#97;&#98;&#98;&#105;&#x78;&#64;&#103;&#109;&#97;&#x69;&#108;&#x2e;&#x63;&#x6f;&#109;</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  * -a 代表添加附件
</span><span class='line'>  * “testmail” 邮件正文
</span><span class='line'>  * -s “test” 邮件标题
</span><span class='line'>  * test_zabbix@gmail.com 为接收的邮件人。
</span><span class='line'>
</span><span class='line'> 登录邮件客户端察看确认收到邮件：
</span><span class='line'>
</span><span class='line'> <img src="http://agenge.github.io/images/2013/05/07.jpg" title="" >
</span><span class='line'>
</span><span class='line'> 修改zabbix_server.conf以下内容：</span></code></pre></td></tr></table></div></figure>


<p> mkdir -p /data/zabbix/alertscripts
 vim zabbix_server.conf
 AlertScriptsPath=${datadir}/alertscripts</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 创建一个监控脚本：</span></code></pre></td></tr></table></div></figure>


<p> vim /data/zabbix/alertscripts/zabbix_monitor
 #!/bin/bash
 $1 to mail address
 $2 mail subject
 $3 mail content
 echo &ldquo;$3&rdquo; | mutt -s &ldquo;$2&rdquo; $1</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 修改权限：</span></code></pre></td></tr></table></div></figure>


<p> chown zabbix:zabbix /data/zabbix/alertscripts
&#8220;`
 到目前为止，已经手动测试通过邮件报警的功能，接下来需要将它集成到zabbix监控系统中。</p>

<ol>
<li><p>点击“管理(Administration)”->“媒体类型(Media types)”，点击页面最右边的“添加媒体类型(Cretae media type)”:
<img src="http://agenge.github.io/images/2013/05/08.jpg" title="" ></p></li>
<li><p>Description： 此为描述，可随意填写。</p></li>
<li>Type： 选择 “Script’。</li>
<li>Script name：填写刚才创建的shell脚本(当然，也可以是其他脚本)名称，例如zabbix_monitor。</li>
<li>Enabled： 启用此脚本。</li>
</ol>


<p> 最后记得“Save”哦。</p>

<h4>添加用户和组</h4>

<ol>
<li>添加用户组</li>
</ol>


<p> 点击“管理(Administration)”->“用户(Users)”，点击最右边的“创建用户组(Create user group)”:</p>

<p> <img src="http://agenge.github.io/images/2013/05/09.jpg" title="" ></p>

<p> 用户组(User group)只需要填写“Group name”，其他默认即可。</p>

<p> <img src="http://agenge.github.io/images/2013/05/10.jpg" title="" ></p>

<p> 权限(Permissions)需要添加之前新增的主机，点击“Read-write”下的“添加(Add)”，并在的子页面选择对应的主机组，例如选择“Puppet”：</p>

<p> <img src="http://agenge.github.io/images/2013/05/11.jpg" title="" ></p>

<p> 点击“Select”确认。最后“保存(Save)”，即添加一个用户组(puppet)。</p>

<ol>
<li>添加用户</li>
</ol>


<p> 添加一个用户组之后，此用户组中并没有任何一个用户，必须在此用户组中增加用户才行，在用户组列表页面，点击用户组“Puppet”之后的“Users(0)”：</p>

<p>  <img src="http://agenge.github.io/images/2013/05/12.jpg" title="" ></p>

<p>  在跳转后的“Users”页面最右边，点击“创建用户(Create user)”：</p>

<p>  <img src="http://agenge.github.io/images/2013/05/13.jpg" title="" ></p>

<p>  之后有三个标签需要设置</p>

<ul>
<li>用户标签：</li>
</ul>


<p>  <img src="http://agenge.github.io/images/2013/05/14.jpg" title="" ></p>

<ul>
<li>媒体标签：</li>
</ul>


<p>  <img src="http://agenge.github.io/images/2013/05/15.jpg" title="" ></p>

<ul>
<li>权限标签(Permissions)：</li>
</ul>


<p>  <img src="http://agenge.github.io/images/2013/05/16.jpg" title="" ></p>

<p>  此处就能看到之前在创建用户组时看到的权限，最后点击“保存(Save)”。</p>

<h4>触发器设置</h4>

<p>添加邮件报警设置和用户设置之后，还需要配置触发器，表示当某个触发器达到设置的值后，就会报警。</p>

<p>Action标签：</p>

<p><img src="http://agenge.github.io/images/2013/05/17.jpg" title="" ></p>

<p>条件(Conditions)标签：</p>

<p><img src="http://agenge.github.io/images/2013/05/18.jpg" title="" ></p>

<p><img src="http://agenge.github.io/images/2013/05/19.jpg" title="" ></p>

<p>操作(Operations)标签：</p>

<p><img src="http://agenge.github.io/images/2013/05/20.jpg" title="" ></p>

<p><img src="http://agenge.github.io/images/2013/05/21.jpg" title="" ></p>

<p>以上就是Zabbix的基本操作流程，如果你还有疑问，可回复讨论。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[批量装机---Linux无人值守之Kickstart]]></title>
    <link href="http://agenge.github.io/blog/2013/05/23/linux-kickstart/"/>
    <updated>2013-05-23T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/05/23/linux-kickstart</id>
    <content type="html"><![CDATA[<p>前段时间总是忙于安装系统，对于偶这种懒人来说，一天安装两遍都无法承受，别说更多，基本上有两个原因造出：</p>

<ul>
<li>时间很宝贵。</li>
<li>偶比较懒惰。</li>
</ul>


<p>一直习惯于 RedHat 家族产品，从最开始接触的RHEL，到后来同时使用的Fedora，及目前使用最多的CentOS，这无疑是偶最为熟悉的Linux，为啥偶要提这些捏？因为以下操作是基于这些Linux操作的啦，费话在此打住，以下为详细操作步骤.</p>

<h2>安装基础包</h2>

<p>_注：以下Yum操作是基于偶本地的ftp 仓库源，&mdash;enablerepo是告诉yum使用这个指定的安装源，
默认情况下，CentOS自带的仓库源也是可以用滴，优先推荐各位使用哦，有个前提条件：连网！
What？服务器不能上网？公司不许随意连公网？能说脏话吗？Fuck! _</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum -y install dhcp-* --enablerepo=centos5.5
</span><span class='line'>yum -y install tftp-* --enablerepo=centos5.5
</span><span class='line'>yum -y install vsftpd-* --enablerepo=centos5.5
</span><span class='line'>cp /usr/share/doc/dhcp-3.0.5/dhcpd.conf.sample /etc/dhcpd.conf</span></code></pre></td></tr></table></div></figure>


<h2>配置dhcp</h2>

<!-- more -->


<pre><code>vi /etc/dhcpd.conf
</code></pre>

<p>添加以下信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>filename "pxelinux.0";     # 指定bootloader文件
</span><span class='line'>next-server 192.168.0.20;  # 指定索取pxelinux.0的tftp服务器IP</span></code></pre></td></tr></table></div></figure>


<p>添加的这两行可在大括号外面，也可在里面，next-server选项可写可不写，但建议各位写上啦。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service dhcpd start   # 启动服务
</span><span class='line'>cd /tftpboot
</span><span class='line'>cp /mnt/isolinux/* ./</span></code></pre></td></tr></table></div></figure>


<p>实际需要的是vmlinuz，initrd.img  *.msg 这几个文件，但为了操作方便，偶直接把isolinux目录下的文件全cp过来（偶在文章开头就说过偶比较懒惰，换成生产环境千万别这样玩）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir pxelinux.cfg
</span><span class='line'>mv isolinux.cfg pxelinux.cfg/default
</span><span class='line'>cp /usr/lib/syslinux/pxelinux.0 /tftpboot</span></code></pre></td></tr></table></div></figure>


<p>default配置文件的作用是告诉主机从哪里去加载操作系统内核，并将启动加载文件拷到/tftpboot下。修改tftp参数并启动tftp服务</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vi /etc/xinetd.d/tftp
</span><span class='line'># *********************************
</span><span class='line'>service tftp
</span><span class='line'>{
</span><span class='line'>    socket_type = dgram
</span><span class='line'>    protocol = udp
</span><span class='line'>    wait = yes
</span><span class='line'>    user = root
</span><span class='line'>    server = /usr/sbin/in.tftpd
</span><span class='line'>    server_args = -s /tftpboot
</span><span class='line'>    disable = &lt;span style="color: #ff0000;"&gt;&lt;strong&gt;no&lt;/strong&gt;&lt;/span&gt;
</span><span class='line'>    per_source = 11
</span><span class='line'>    cps = 100 2
</span><span class='line'>    flags = IPv4
</span><span class='line'>}
</span><span class='line'># *********************************</span></code></pre></td></tr></table></div></figure>


<p>tftpboot 这个参数主要是指定tftp client 客户端从服务器的哪个目录去加载bootloader的pxelinux.0文件。启动服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service xinetd restart
</span><span class='line'>chkconfig tftp on
</span><span class='line'>vi /tftpboot/pxelinux.cfg/default</span></code></pre></td></tr></table></div></figure>


<p>修改第3行，第12行.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>default linux
</span><span class='line'>prompt 1
</span><span class='line'>timeout 10 //时间调小点
</span><span class='line'>display boot.msg
</span><span class='line'>F1 boot.msg
</span><span class='line'>F2 options.msg
</span><span class='line'>F3 general.msg
</span><span class='line'>F4 param.msg
</span><span class='line'>F5 rescue.msg
</span><span class='line'>label linux
</span><span class='line'>kernel vmlinuz
</span><span class='line'>append ks=ftp://192.168.0.20/pub/ks.cfg initrd=initrd.img
</span><span class='line'>label text</span></code></pre></td></tr></table></div></figure>


<h2>安装Kickstart</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install -y *kickstart* --enablerepo=centos5.5
</span><span class='line'>system-config-kickstart</span></code></pre></td></tr></table></div></figure>


<p>_提示：所有以system-config开头的命令，都需要图形界面的支持。这不是必须的，前提是对ks的配置文件语法很熟悉啦。 _</p>

<h3>配置ks.cfg</h3>

<p>首先将 ks.cfg 保存到 /var/ftp/pub 目录下，将修改相应权限：</p>

<pre><code>chmod 707 /var/ftp/pub/ks.cfg
</code></pre>

<p>以下是偶使用的ks.cfg全文 ，请各位根据自己情况修改：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#platform=x86, AMD64, or Intel EM64T
</span><span class='line'># System authorization information
</span><span class='line'>auth --useshadow --enablemd5
</span><span class='line'># System bootloader configuration
</span><span class='line'>bootloader --location=mbr
</span><span class='line'># Partition clearing information
</span><span class='line'>clearpart --all --initlabel
</span><span class='line'># Use graphical install
</span><span class='line'>#graphical
</span><span class='line'>text
</span><span class='line'># Firewall configuration
</span><span class='line'>firewall --disabled
</span><span class='line'># Run the Setup Agent on first boot
</span><span class='line'>firstboot --disable
</span><span class='line'># System keyboard
</span><span class='line'>keyboard us
</span><span class='line'># System language
</span><span class='line'>lang en_US
</span><span class='line'># Installation logging level
</span><span class='line'>logging --level=info
</span><span class='line'># Use network installation
</span><span class='line'>url --url=&lt;strong&gt;ftp://192.168.30.210/pub/x86_64/centos5.5&lt;/strong&gt;
</span><span class='line'># Network information
</span><span class='line'>network --bootproto=dhcp --device=eth0 --onboot=on
</span><span class='line'># Reboot after installation
</span><span class='line'>reboot
</span><span class='line'>#Root password
</span><span class='line'>rootpw --iscrypted $1$R79JLo34$.Yi4OUmL5PhpsxzSTL1hX1
</span><span class='line'>
</span><span class='line'># SELinux configuration
</span><span class='line'>selinux --disabled
</span><span class='line'># System timezone
</span><span class='line'>timezone Asia/Chongqing
</span><span class='line'># Install OS instead of upgrade
</span><span class='line'>install
</span><span class='line'># X Window System configuration information
</span><span class='line'>xconfig --defaultdesktop=GNOME --depth=8 --resolution=1026x768 --startxonboot
</span><span class='line'># Disk partitioning information
</span><span class='line'>part /boot --bytes-per-inode=4096 --fstype="ext3" --size=256
</span><span class='line'>part swap --bytes-per-inode=4096 --fstype="swap" --size=2048
</span><span class='line'>#part / --bytes-per-inode=4096 --fstype="ext3" --grow --size=1
</span><span class='line'>part / --bytes-per-inode=4096 --fstype="ext3" --grow --size=102400
</span><span class='line'>
</span><span class='line'>%packages --resolvedeps
</span><span class='line'>#@system-tools
</span><span class='line'>#@gnome-desktop
</span><span class='line'>
</span><span class='line'>@base-x
</span><span class='line'>
</span><span class='line'>#@sound-and-video
</span><span class='line'>#@chinese-support
</span><span class='line'>#@graphical-internet
</span><span class='line'>#@admin-tools
</span><span class='line'>#@editors
</span><span class='line'>#key --skip
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<p>所有以井号(#)开头的为注释行.</p>

<ul>
<li>url是操作系统的镜像地址</li>
<li>part / (未注释行)是指根分区分100G, 如果你的磁盘很大，剩余的空间可在安装系统后根据您的具体需求而设。</li>
<li>@bash-x  安装最基础的系统包</li>
<li>resolvedeps 将自动解决包之间的依赖关系。</li>
</ul>


<h3>启动所有服务</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service dhcpd restart
</span><span class='line'>service xinetd restart
</span><span class='line'>service vsftpd restart</span></code></pre></td></tr></table></div></figure>


<h2>PXE安装系统</h2>

<p>当服务器一切工作准备就绪，就开始大规模安装Linux系统吧，由于各个主板对应的BIOS设置不同，此处无法满足所有的需求，通常做法是：</p>

<p>进入BIOS &ndash;> PXE boot &ndash;> enable &ndash;> save and reboot</p>

<p>如果各位有任何疑问，请留言回复。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Zabbix 源码安装与配置]]></title>
    <link href="http://agenge.github.io/blog/2013/05/02/zabbix-source-install-conf/"/>
    <updated>2013-05-02T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/05/02/zabbix-source-install-conf</id>
    <content type="html"><![CDATA[<h2>1、安装环境</h2>

<ul>
<li>操作系统：:CentOS 5.5 64位</li>
<li>Mysql：5.5.27</li>
<li>Apache httpd：2.4.4</li>
<li>Zabbix：2.0.6</li>
</ul>


<h2>2、源码安装</h2>

<h3>安装Zabbix</h3>

<h4>创建用户</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>groupadd zabbix
</span><span class='line'>useradd -g zabbix -M -s /sbin/nologin zabbix</span></code></pre></td></tr></table></div></figure>


<h3>源码安装Zabbix</h3>

<p>下载页面请点击 <a href="http://www.zabbix.com/download.php">这里</a>。下载之后按照以下步骤执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install wget curl-devel net-snmp-devel php-bcmath
</span><span class='line'>tar zxvf zabbix-2.0.6.tar.gz
</span><span class='line'>cd zabbix-2.0.6
</span><span class='line'>./configure --prefix=/data/zabbix \
</span><span class='line'>  --enable-server --enable-agent \
</span><span class='line'>  --with-mysql --with-net-snmp \
</span><span class='line'>  --with-libcurl --enable-proxy
</span><span class='line'>
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<p>如果一切顺利，安装完成。</p>

<h3>创建Zabbix 数据库</h3>

<p>这里假设你已经安装好Mysql数据库，具体的安装方法请自己到网上搜索解决。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql -uroot -p
</span><span class='line'>Enter password:
</span><span class='line'>
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with ; or \g.
</span><span class='line'>Your MySQL connection id is 63
</span><span class='line'>Server version: 5.0.95 Source distribution
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2011, Oracle and/or its affiliates. All rights reserved.
</span><span class='line'>
</span><span class='line'>Oracle is a registered trademark of Oracle Corporation and/or its
</span><span class='line'>affiliates. Other names may be trademarks of their respective owners.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>mysql&gt; create database zabbix character set utf8;
</span><span class='line'>mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by 'zabbix';
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; quit
</span><span class='line'>mysql -uzabbix -p zabbix &lt; database/mysql/schema.sql
</span><span class='line'>mysql -uzabbix -p zabbix &lt; database/mysql/images.sql
</span><span class='line'>mysql -uzabbix -p zabbix &lt; database/mysql/data.sql</span></code></pre></td></tr></table></div></figure>


<h3>配置Zabbix</h3>

<p>设置服务自启动：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp misc/init.d/fedora/core/zabbix_server /etc/init.d/
</span><span class='line'>chmod +x /etc/init.d/zabbix_server</span></code></pre></td></tr></table></div></figure>


<p>修改zabbix_server中的BASEDIR=/data/zabbix</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chkconfig --add zabbix_server
</span><span class='line'>chkconfig zabbix_server on</span></code></pre></td></tr></table></div></figure>


<p>设置zabbix 配置文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /data/zabbix/etc/zabbix/zabbix_server.conf
</span><span class='line'>DBName=zabbix
</span><span class='line'>DBPassword=zabbix</span></code></pre></td></tr></table></div></figure>


<p>只需要修改密码即可，其他都保持默认值。当然如果你的Mysql不是安装在本地，肯定也要修改相应的IP啦。</p>

<h4>启动Zabbix Server</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/init.d/zabbix_server start</span></code></pre></td></tr></table></div></figure>


<p>确认zabbix server是否已经启动：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netstat -antulp | grep zabbix
</span><span class='line'>
</span><span class='line'>tcp        0      0 0.0.0.0:10051               0.0.0.0:*                   LISTEN      19087/zabbix_server</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<h2>3、安装Zabbix Web接口</h2>

<p>Zabbix前端使用PHP编写，故Web Server必须支持PHP。</p>

<h4>安装Apr</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://mirrors.cnnic.cn/apache//apr/apr-1.4.6.tar.gz
</span><span class='line'>tar zxvf apr-1.4.6.tar.gz
</span><span class='line'>cd apr-1.4.6
</span><span class='line'>./configure --prefix=/usr/local/apr
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<h4>安装Apr-utils</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://mirrors.cnnic.cn/apache//apr/apr-util-1.5.2.tar.gz
</span><span class='line'>tar zxvf apr-util-1.5.2.tar.gz
</span><span class='line'>cd apr-util-1.5.2
</span><span class='line'>./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<h4>安装pcre</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar zxvf pcre-8.32.tar.gz
</span><span class='line'>cd pcre-8.32
</span><span class='line'>./configure
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<h3>安装Apache httpd</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://labs.mop.com/apache-mirror//httpd/httpd-2.4.4.tar.bz2
</span><span class='line'>tar jxvf httpd-2.4.4.tar.bz2
</span><span class='line'>cp -rf apr-1.4.6 /data/software/httpd-2.4.4/srclib/apr
</span><span class='line'>cp -rf apr-util-1.5.2 /data/software/httpd-2.4.4/srclib/apr-util
</span><span class='line'>cd httpd-2.4.4
</span><span class='line'>./configure --prefix=/usr/local/httpd \
</span><span class='line'>  --enable-modules --enable-ssl --enable-module=so \
</span><span class='line'>  --with-apr=/usr/local/apr \
</span><span class='line'>  --with-apr-util=/usr/local/apr-util --with-included-apr \
</span><span class='line'>  --enable-mods-shared=most --with-included-apr
</span><span class='line'>
</span><span class='line'>make && make install
</span><span class='line'>/usr/local/httpd/bin/apachectl start</span></code></pre></td></tr></table></div></figure>


<h4>安装 PHP</h4>

<p>安装gettext（国际化支持）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://ftp.gnu.org/pub/gnu/gettext/gettext-0.18.2.tar.gz
</span><span class='line'>tar zxvf gettext-0.18.2.tar.gz
</span><span class='line'>cd gettext-0.18.2
</span><span class='line'>./configure
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<p>安装libpng：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar zxvf libpng-1.6.1.tar.gz
</span><span class='line'>cd libpng-1.6.1
</span><span class='line'>./configure --prefix=/usr/local/libpng --enable-shared
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<p>安装freetype：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar jxvf freetype-2.4.11.tar.bz2
</span><span class='line'>cd freetype-2.4.11
</span><span class='line'>./configure --prefix=/usr/local/freetype&lt;b&gt;&lt;/b&gt;
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<p>安装JPEG：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://www.ijg.org/files/jpegsrc.v9.tar.gz
</span><span class='line'>tar zxvf jpegsrc.v9.tar.gz
</span><span class='line'>cd jpeg-9/
</span><span class='line'>./configure --prefix=/usr/local/jpeg9 --enable-shared --enable-static
</span><span class='line'>make && make install</span></code></pre></td></tr></table></div></figure>


<p>安装GD库：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget https://bitbucket.org/libgd/gd-libgd/get/GD_2_0_33.tar.gz
</span><span class='line'>tar zxvf GD_2_0_33.tar.gz
</span><span class='line'>cd libgd-gd-libgd-486e81dea984/src
</span><span class='line'>./configure --with-png  --with-freetype  --with-jpeg
</span><span class='line'>make install</span></code></pre></td></tr></table></div></figure>


<p>安装PHP：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget ftp://192.168.30.211:/pub/Tools/php-5.3.19.tar.bz2
</span><span class='line'>tar jxvf php-5.3.19.tar.bz2
</span><span class='line'>
</span><span class='line'>./configure --prefix=/usr/local/php  \
</span><span class='line'>  --with-config-file-path=/usr/local/php/etc \
</span><span class='line'>  --disable-debug --disable-rpath --with-gettext  \
</span><span class='line'>  --with-mcrypt --with-mysql=/usr/local/mysql \
</span><span class='line'>  --with-mysql-sock=/data/mysqldata/3306/mysql.sock \
</span><span class='line'>  --with-mysqli=/usr/local/mysql/bin/mysql_config \
</span><span class='line'>  --enable-mbstring --enable-pdo --with-curl \
</span><span class='line'>  --enable-inline-optimization --with-bz2 \
</span><span class='line'>  --with-zlib --enable-sockets --enable-bcmath \
</span><span class='line'>  --enable-sysvsem --enable-sysvshm --enable-pcntl \
</span><span class='line'>  --enable-mbregex --with-mhash --enable-xml \
</span><span class='line'>  --enable-zip --with-pcre-regex --with-gettext \
</span><span class='line'>  --with-apxs2=/usr/local/httpd/bin/apxs \
</span><span class='line'>  --with-gd --enable-gd-native-ttf --with-jpeg-dir=/usr/local/include \
</span><span class='line'>  --with-png-dir=/usr/local/include --with-freetype-dir=/usr/include/freetype2
</span><span class='line'>  
</span><span class='line'>make ZEND_EXTRA_LIBS='-liconv'
</span><span class='line'>make install
</span><span class='line'>cp php.ini-production /usr/local/php/etc/php.ini
</span><span class='line'>cp sapi/fpm/init.d.php-fpm.in /etc/init.d/php-fpm
</span><span class='line'>chmod +x /etc/init.d/php-fpm
</span><span class='line'>chkconfig php-fpm on
</span><span class='line'>cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf</span></code></pre></td></tr></table></div></figure>


<p>修改时区：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /usr/local/php/etc/php.ini</span></code></pre></td></tr></table></div></figure>


<p>在 [Date] 之后增加一行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>date.timezone =  Asia/Chongqing</span></code></pre></td></tr></table></div></figure>


<p>将 max_execution_time 的值修改为 300或更大值，将max_input_time的值修改为300或更大值。</p>

<p>修改httpd.conf：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /usr/local/httpd/conf/httpd.conf</span></code></pre></td></tr></table></div></figure>


<p>在最后增加：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>AddType application/x-httpd-php  .php
</span><span class='line'>AddType application/x-httpd-php-source  .phps</span></code></pre></td></tr></table></div></figure>


<p>并将：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DirectoryIndex index.html</span></code></pre></td></tr></table></div></figure>


<p>修改为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DirectoryIndex index.php index.html</span></code></pre></td></tr></table></div></figure>


<h4>配置Zabbix Web接口</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir /usr/local/httpd/htdocs/zabbix
</span><span class='line'>cd frontends/php/
</span><span class='line'>cp -a . /usr/local/httpd/htdocs/zabbix/
</span><span class='line'>cd /usr/local/httpd/htdocs/zabbix/
</span><span class='line'>cp conf/zabbix.conf.php.example conf/zabbix.conf.php
</span><span class='line'>vim conf/zabbix.conf.php</span></code></pre></td></tr></table></div></figure>


<p>修改好连接Myql数据库的相关信息。</p>

<h4>安装Zabbix前台</h4>

<p>使用浏览器打开Zabbix URL: <a href="http://server_ip/zabbix">http://server_ip/zabbix</a></p>

<p>用户名：admin</p>

<p>密码：  zabbix</p>

<h2>安装Zabbix Agent</h2>

<h3>Zabbix Agent For Linux</h3>

<p>添加用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>groupadd zabbix
</span><span class='line'>useradd -g zabbix -M -s /sbin/nologin zabbix</span></code></pre></td></tr></table></div></figure>


<p>下载 Zabbix Agent</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://www.zabbix.com/downloads/2.0.6/zabbix_agents_2.0.6.linux2_6.amd64.tar.gz
</span><span class='line'>tar zxvf zabbix_agents_2.0.6.linux2_6.amd64.tar.gz
</span><span class='line'>mv sbin/zabbix_agent* /usr/sbin/
</span><span class='line'>mv bin/zabbix_* /usr/bin/
</span><span class='line'>mkdir -p /etc/zabbix
</span><span class='line'>mv conf/* /etc/zabbix
</span><span class='line'>echo "zabbix_agent    10050/tcp" &gt;&gt; /etc/services
</span><span class='line'>echo "zabbix_agent    10050/udp" &gt;&gt; /etc/services
</span><span class='line'>sed -i 's/Server=127.0.0.1/Server=192.168.30.226/' /etc/zabbix/zabbix_agentd.conf
</span><span class='line'>sed -i 's/Hostname=Zabbix server/Hostname=192.168.30.226/' /etc/zabbix/zabbix_agentd.conf</span></code></pre></td></tr></table></div></figure>


<p>启动 Zabbix Agent</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf
</span><span class='line'>ps aux | grep zabbix
</span><span class='line'>echo "zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf" &gt;&gt; /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>测试是否正确</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zabbix_get -s 192.168.30.226 -p 10050 -k agent.ping
</span><span class='line'>1</span></code></pre></td></tr></table></div></figure>


<p>如果返回1表示正常。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[要体现在行动上之Blog恢复]]></title>
    <link href="http://agenge.github.io/blog/2013/04/14/blog-recovery/"/>
    <updated>2013-04-14T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/04/14/blog-recovery</id>
    <content type="html"><![CDATA[<p>前几天偶打开自己<a title="agenge" href="http://agenge.com">blog</a>时，突然发现无法打开，具体点说是显示数据库连接错误，第一反应是“被黑”，故而排查的第一步就是查看系统log，然而并没有看到相关错误信息，为尽快恢复，偶先尝试重启mysql，提示没有剩余空间，难道数据库数据文件太多导致？通过du后，发现果然如此，通过将过旧的数据文件（即Mysql bin log）删除即可。以下是整个恢复过程，仅供参考。</p>

<p><strong> 1. 查看磁盘空间： </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos var]# df -h
</span><span class='line'>Filesystem Size Used Avail Use% Mounted on
</span><span class='line'>/dev/sda1 7.9G 7.9G 0M 100% /</span></code></pre></td></tr></table></div></figure>


<p><strong> 2. 查看Mysql binlog 大小 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos var]# pwd
</span><span class='line'>/usr/local/mysql/var
</span><span class='line'>[root@centos var]# ll | wc -l
</span><span class='line'>1582
</span><span class='line'>[root@centos var]# du -sh .
</span><span class='line'>4.1G .</span></code></pre></td></tr></table></div></figure>


<p>VPS的磁盘大小总共才8G，还包括操作系统所占空间，bin log占用足足4.1G。删除吧！</p>

<p><strong> 3. 删除旧数据 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos var]# mysql -uroot -p
</span><span class='line'>Enter password:
</span><span class='line'>Welcome to the MySQL monitor. Commands end with ; or \g.
</span><span class='line'>Your MySQL connection id is 45959
</span><span class='line'>Server version: 5.1.54-log Source distribution
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2011, Oracle and/or its affiliates. All rights reserved.
</span><span class='line'>
</span><span class='line'>Oracle is a registered trademark of Oracle Corporation and/or its
</span><span class='line'>affiliates. Other names may be trademarks of their respective
</span><span class='line'>owners.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>mysql&gt; purge binary logs before '2013-01-01 00:00:00';
</span><span class='line'>Query OK, 0 rows affected (10.39 sec)
</span><span class='line'>mysql&gt; quit
</span><span class='line'>Bye
</span><span class='line'>[root@centos var]# df -h
</span><span class='line'>Filesystem Size Used Avail Use% Mounted on
</span><span class='line'>/dev/sda1 7.9G 4.3G 3.3G 57% /</span></code></pre></td></tr></table></div></figure>


<p>删除2013年1月1日之前的所有数据，剩余可用空间还有3.3G。</p>

<p><strong> 4. 后记 </strong>
如果以上操作就算完结，那无疑是在等待下一次磁盘被爆，为防止问题再次发生，必须主动监控来达到提前预防，所以偶部署了个小脚本，一旦磁盘达到90%，会mail通知偶。也许是对blog的不重视，之前一直未采取行动，或许惰性控制了我，最后问大家一个问题：如果某个东西对你非常重要，在危机来之前，各位都准备好迎接了吗？理想或想法体现到行动上了吗？</p>

<p>2013/09/27 Update:</p>

<p>如果只想写文章，而不想关心Mysql 及Http Server，甚至担心VPS被黑，偶强烈推荐使用 Octopress + Github，具体介绍及安装请见这里<a href="http://agenge.com/blog/2013/09/12/write-blog-octopress-with-github/">利用GitHub搭建免费的个人blog</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Puppet Dashboard配置及apache和Nginx整合]]></title>
    <link href="http://agenge.github.io/blog/2013/04/12/puppet-dashboard-conf-with-web-server/"/>
    <updated>2013-04-12T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/04/12/puppet-dashboard-conf-with-web-server</id>
    <content type="html"><![CDATA[<p>Dashboard一个基于Ruby on Rails设计的Web控制台，便于管理Puppet Master和Agent，整个安装过程比较简单，以下是具体的安装步骤。</p>

<h2>安装前提条件</h2>

<ol>
<li>ruby版本>1.8.6，如果你是CentOS 5或是RHEL 5，可能你需要升级Ruby，官方下载地址请</li>
</ol>


<p> 点击<a href="ftp://ftp.ruby-lang.org/pub/ruby">这里</a>。具体的升级步骤由于下载的安装包已经包含，故不再介绍，本文示例基于Ruby 1.8.7。</p>

<p> <code>
 # ruby -v
 ruby 1.8.7 (2011-06-30 patchlevel 352) [x86_64-linux]
</code></p>

<ol>
<li>安装相关依赖包</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> # yum install -y mysql mysql-devel mysql-server \
</span><span class='line'>     ruby ruby-devel ruby-irb ruby-mysql \
</span><span class='line'>     ruby-rdoc ruby-ri</span></code></pre></td></tr></table></div></figure>


<p> 如果你已经有Mysql，此处不需要安装mysql-server包。安装后加入开机自启动并启动mysql 。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chkconfig mysqld on
</span><span class='line'># /etc/init.d/mysqld start
</span><span class='line'>Starting mysqld:                                           [  OK  ]</span></code></pre></td></tr></table></div></figure>


<ol>
<li>升级GEM软件包安装器</li>
</ol>


<p> 首先检查gem版本，如果已经是1.3.5，就不需要升级：
 &#8220;`</p>

<pre><code># gem -v
1.3.5
</code></pre>

<p> &#8220;`
如果是1.3.1，意味着你要升级gem：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget http://production.cf.rubygems.org/rubygems/rubygems-1.3.5.tgz
</span><span class='line'># tar zxvf rubygems-1.3.5.tgz
</span><span class='line'># cd rubygems-1.3.5
</span><span class='line'># ruby setup.rb</span></code></pre></td></tr></table></div></figure>


<ol>
<li>安装rake</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># gem install rake</span></code></pre></td></tr></table></div></figure>


<!--more-->


<h2>数据库配置</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mysql -uroot -p
</span><span class='line'>Enter password:
</span><span class='line'>
</span><span class='line'>mysql&gt; use dashboard
</span><span class='line'>Database changed
</span><span class='line'>mysql&gt; grant all on dashboard.* to dashboard@localhost identified by 'dashboard';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>mysql&gt; flush privileges;
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<h2>安装Puppet Dashboard</h2>

<ul>
<li>下载Dashboard</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /usr/local/
</span><span class='line'># wget http://downloads.puppetlabs.com/dashboard/puppet-dashboard-1.2.20.tar.gz
</span><span class='line'># tar -zxvf puppet-dashboard-1.2.20.tar.gz
</span><span class='line'># cd puppet-dashboard-1.2.20</span></code></pre></td></tr></table></div></figure>


<p>创建数据库用户,此处我们使用源码方式进行安装,你可以通过yum或apt-get安装。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cp config/database.yml.example config/database.yml</span></code></pre></td></tr></table></div></figure>


<ul>
<li>修改数据库配置：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim config/database.yml
</span><span class='line'>production:
</span><span class='line'>database: dashboard
</span><span class='line'>username: dashboard
</span><span class='line'>password: dashboard
</span><span class='line'>encoding: utf8
</span><span class='line'>adapter: mysql</span></code></pre></td></tr></table></div></figure>


<p>production代表生产环境，如果你是开发环境(development)或测试环境(test)，请修改相应的配置。</p>

<ul>
<li>初始化数据库</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rake RAILS_ENV=production db:create
</span><span class='line'># gem install mysql
</span><span class='line'># rake RAILS_ENV=production db:migrate</span></code></pre></td></tr></table></div></figure>


<ul>
<li>修改时区
默认是UTC时间，如果你在控制台看到的时区不对，那需要修改时区：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim config/environment.rb</span></code></pre></td></tr></table></div></figure>


<p>将config.time_zone = &lsquo;UTC&#8217;  修改为 config.time_zone = &#8216;Chongqing&rsquo;</p>

<ul>
<li>启动Webrick Web服务器</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /usr/local/puppet-dashboard-1.2.20
</span><span class='line'># script/server -p 3000 -e production  -d</span></code></pre></td></tr></table></div></figure>


<p>上面即代表启动dashboard，端口3000，以及后台(-d)运行,通过浏览器输入： <a href="http://dashboard_server:3000%C2%A0%C2%A0">http://dashboard_server:3000%C2%A0%C2%A0</a> 即可访问。</p>

<h3>Puppet Dashboard配置</h3>

<h4>服务器配置</h4>

<p>在Puppet 服务器端/etc/puppet/puppet.conf中的[main]节加入：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>reports = http, store
</span><span class='line'>reporturl = http://192.168.30.226:3000/reports/upload</span></code></pre></td></tr></table></div></figure>


<p>部署lib文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cp /usr/local/puppet-dashboard/ext/puppet/puppet_dashboard.rb /usr/lib/ruby/site_ruby/1.8/puppet/reports/</span></code></pre></td></tr></table></div></figure>


<p>保存之后，重启puppetmaster即可。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/init.d/puppetmaster restart</span></code></pre></td></tr></table></div></figure>


<h4>客户端配置</h4>

<p>在Puppet Agent（客户端）/etc/puppet/puppet.conf中的[main]节加入：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>report = true</span></code></pre></td></tr></table></div></figure>


<p>保存之后，重启puppet即可。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/init.d/puppet restart</span></code></pre></td></tr></table></div></figure>


<h4>控制台配置</h4>

<p>登录Dashboard后，需要自己添加： group和node</p>

<h2>Puppet Dashboard常用操作</h2>

<p><strong> 导入日志 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /usr/local/puppet-dashboard
</span><span class='line'># rake RAILS_ENV=production reports:import</span></code></pre></td></tr></table></div></figure>


<p><strong> 优化数据库 </strong>
当数据量过大时，需要优化mysql数据库：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /usr/local/puppet-dashboard
</span><span class='line'># rake RAILS_ENV=production db:raw:optimize</span></code></pre></td></tr></table></div></figure>


<p><strong> 删除日志 </strong>
删除1个月之前的数据：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /usr/local/puppet-dashboard
</span><span class='line'># rake RAILS_ENV=production reports:prune upto=1 unit=mon</span></code></pre></td></tr></table></div></figure>


<p>删除15天前的日志：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rake RAILS_ENV=production reports:prune upto=15 unit=day</span></code></pre></td></tr></table></div></figure>


<p><strong> 备份数据库 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rake RAILS_ENV=production db:raw:dump
</span><span class='line'>mysqldump --add-locks --create-options --disable-keys --extended-insert --quick --set-charset --user=dashboard --password=dashboard dashboard &gt; production.sql.tmp
</span><span class='line'>mv production.sql.tmp production.sql
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<p><strong>恢复数据库 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rake RAILS_ENV=production FILE=production.sql db:raw:restore</span></code></pre></td></tr></table></div></figure>


<p><strong> Dashboard 启停脚本 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'># Description: Puppet Dashboard init.d script
</span><span class='line'>
</span><span class='line'># Get function from functions library
</span><span class='line'>. /etc/init.d/functions
</span><span class='line'>
</span><span class='line'># Start the service Puppet Dashboard
</span><span class='line'>start() {
</span><span class='line'>    echo -n "Starting Puppet Dashboard: "
</span><span class='line'>    /usr/bin/ruby /usr/local/puppet-dashboard/script/server -e production -b 192.168.30.226 -d
</span><span class='line'>    ### Create the lock file ###
</span><span class='line'>    touch /var/lock/subsys/puppetdb
</span><span class='line'>    success $"Puppet Dashboard startup"
</span><span class='line'>    echo
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'># Restart the service Puppet Dashboard
</span><span class='line'>stop() {
</span><span class='line'>    echo -n "Stopping Puppet Dashboard: "
</span><span class='line'>    kill -9 `ps ax | grep "/usr/bin/ruby /usr/local/puppet-dashboard/script/server" | grep -v grep | awk '{ print $1 }' `
</span><span class='line'>    ### Now, delete the lock file ###
</span><span class='line'>    rm -f /var/lock/subsys/puppetdb
</span><span class='line'>    success $"Puppet Dashboard shutdown"
</span><span class='line'>    echo
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>### main logic ###
</span><span class='line'>case "$1" in
</span><span class='line'>    start)
</span><span class='line'>        start
</span><span class='line'>    ;;
</span><span class='line'>    stop)
</span><span class='line'>        stop
</span><span class='line'>    ;;
</span><span class='line'>    status)
</span><span class='line'>        status Puppet DB
</span><span class='line'>    ;;
</span><span class='line'>    restart|reload|condrestart)
</span><span class='line'>        stop
</span><span class='line'>        start
</span><span class='line'>    ;;
</span><span class='line'>    *)
</span><span class='line'>    echo $"Usage: $0 {start|stop|restart|reload|status}"
</span><span class='line'>    exit 1
</span><span class='line'>esac
</span><span class='line'>
</span><span class='line'>exit 0
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<h2>使用Passenger运行Puppet Dashboard</h2>

<p>相信用过Dashboard的人都知道在访问时控制台时比较缓慢，这正是由于内置的Webrick服务器导致，不过Puppet支持与其他第三方Web Server整合，以下分别介绍整合过程。</p>

<h3>Apache整合Puppet Dashboard</h3>

<ol>
<li>安装依赖包</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install ruby ruby-libs ruby-devel  http httpd</span></code></pre></td></tr></table></div></figure>


<ol>
<li>安装Passenger</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># gem install passenger</span></code></pre></td></tr></table></div></figure>


<ol>
<li>安装Apache的passenger模块</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># passenger-install-apache2-module</span></code></pre></td></tr></table></div></figure>


<p>如果安装没问题的话，就会有以下类似信息输出：</p>

<p> &#8220;`
 The Apache 2 module was successfully installed.</p>

<p> Please edit your Apache configuration file, and add these lines:</p>

<pre><code>LoadModule passenger_module /usr/lib64/ruby/gems/1.8/gems/passenger-3.0.19/ext/apache2/mod_passenger.so
PassengerRoot /usr/lib64/ruby/gems/1.8/gems/passenger-3.0.19
PassengerRuby /usr/bin/ruby
</code></pre>

<p> After you restart Apache, you are ready to deploy any number of Ruby on Rails
 applications on Apache, without any further Ruby on Rails-specific
 configuration!</p>

<p> Press ENTER to continue.</p>

<p> &#8220;`
直接输入回车即可。</p>

<ol>
<li>配置Apache虚拟主机</li>
</ol>


<p> &#8220;`
 # cd /usr/local/puppet-dashboard
 # cp ext/passenger/dashboard-vhost.conf /etc/httpd/conf.d/
 # vi /etc/httpd/conf.d/dashboard-vhost.conf
 # UPDATE THESE PATHS TO SUIT YOUR ENVIRONMENT
 LoadModule passenger_module /usr/lib64/ruby/gems/1.8/gems/passenger-3.0.19/ext/apache2/mod_passenger.so
 PassengerRoot /usr/lib64/ruby/gems/1.8/gems/passenger-3.0.19
 PassengerRuby /usr/bin/ruby</p>

<p> # you may want to tune these settings
 PassengerHighPerformance on
 PassengerMaxPoolSize 12
 PassengerPoolIdleTime 1500
 # PassengerMaxRequests 1000
 PassengerStatThrottleRate 120
 RailsAutoDetect On</p>

<p> <VirtualHost *:80></p>

<pre><code>     ServerName pmaster.i.12582.com
     DocumentRoot /usr/local/puppet-dashboard/public/
     &lt;Directory /usr/local/puppet-dashboard/public/&gt;
             Options None
             Order allow,deny
             allow from all
     &lt;/Directory&gt;
</code></pre>

<p>   ErrorLog /var/log/httpd/dashboard.example.com_error.log
   LogLevel warn
   CustomLog /var/log/httpd/dashboard.example.com_access.log combined
   ServerSignature On
 </VirtualHost></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>5. 重启httpd</span></code></pre></td></tr></table></div></figure>


<h1>/etc/init.d/httpd restart</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 此时再访问 http://pmaster.i.12582.com 发现速度较之前快太多。
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>###Nginx整合Puppet Dashboard
</span><span class='line'>1. 安装依赖包</span></code></pre></td></tr></table></div></figure>


<h1>yum install ruby ruby-libs ruby-devel  http httpd</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2. 安装Passenger</span></code></pre></td></tr></table></div></figure>


<h1>gem install passenger</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>3. 安装Nginx及passenger模块</span></code></pre></td></tr></table></div></figure>


<h1>passenger-install-nginx-module</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>回车后，会有两个选择：
</span><span class='line'> * 表示下载nginx，编译且安装，推荐这种方式安装.
</span><span class='line'> * 表示自定义安装Nginx,安装之后，nginx默认存放在/opt目录.
</span><span class='line'>
</span><span class='line'> 修改/opt/nginx/conf/nginx.conf，在最后一个}之前添加以下内容：
</span><span class='line'>
</span><span class='line'> ```
</span><span class='line'>    server {
</span><span class='line'>      listen 80;
</span><span class='line'>      server_name pmaster.i.12582.com;
</span><span class='line'>      root /usr/local/puppet-dashboard/public;
</span><span class='line'>      passenger_enabled on;
</span><span class='line'>    }
</span><span class='line'> ```
</span><span class='line'>
</span><span class='line'>4. 重启Nginx</span></code></pre></td></tr></table></div></figure>


<h1>killall nginx</h1>

<h1>/opt/nginx/sbin/nginx</h1>

<p>&#8220;`</p>

<p>最后，你要是有任何疑问，请留言。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[基于KVM和Hyper-V的Windows系统测试报告]]></title>
    <link href="http://agenge.github.io/blog/2013/03/13/kvm-hyper-v-base-win-test/"/>
    <updated>2013-03-13T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/03/13/kvm-hyper-v-base-win-test</id>
    <content type="html"><![CDATA[<p>最近由于工作原因，要做一个KVM和Hyper-V的测试报告，
由于我们的新系统是采用的C#开发，故部署在Windows，从而</p>

<p>引发这个测试，具体介绍如下：</p>

<h2>测试环境</h2>

<ul>
<li>硬件资源</li>
</ul>


<table width="609" border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td nowrap="nowrap" width="129">
<p align="center">IP
</td>
<td nowrap="nowrap" width="81">
<p align="center">功能
</td>
<td nowrap="nowrap" width="140">
<p align="center">OS
</td>
<td nowrap="nowrap" width="115">
<p align="center">CPU
</td>
<td nowrap="nowrap" width="72">
<p align="center">内存
</td>
<td nowrap="nowrap" width="72">
<p align="center">备注
</td>
</tr>
<tr>
<td nowrap="nowrap" width="129">
<p align="center">192.168.30.61
</td>
<td nowrap="nowrap" width="81">
<p align="center">宿主机
</td>
<td nowrap="nowrap" width="140">
<p align="center">CentOS 6.3 64位
</td>
<td nowrap="nowrap" width="115">
<p align="center">忽略
</td>
<td nowrap="nowrap" width="72">
<p align="center">忽略
</td>
<td rowspan="2" nowrap="nowrap" width="72">
<p align="center">KVM
</td>
</tr>
<tr>
<td nowrap="nowrap" width="129">
<p align="center">192.168.30.120
</td>
<td nowrap="nowrap" width="81">
<p align="center">Guest OS
</td>
<td nowrap="nowrap" width="140">
<p align="center">Windows 2008 64位
</td>
<td nowrap="nowrap" width="115">
<p align="center">4*VCPU
</td>
<td nowrap="nowrap" width="72">
<p align="center">8G
</td>
</tr>
<tr>
<td nowrap="nowrap" width="129">
<p align="center">192.168.30.63
</td>
<td nowrap="nowrap" width="81">
<p align="center">宿主机
</td>
<td nowrap="nowrap" width="140">
<p align="center">Windows 2008 64位
</td>
<td nowrap="nowrap" width="115">
<p align="center">忽略
</td>
<td nowrap="nowrap" width="72">
<p align="center">忽略
</td>
<td rowspan="2" nowrap="nowrap" width="72">Hyper-v</td>
</tr>
<tr>
<td nowrap="nowrap" width="129">
<p align="center">192.168.30.136
</td>
<td nowrap="nowrap" width="81">
<p align="center">Guest OS
</td>
<td nowrap="nowrap" width="140">
<p align="center">Windows 2008 64位
</td>
<td nowrap="nowrap" width="115">
<p align="center">4*VCPU
</td>
<td nowrap="nowrap" width="72">
<p align="center">4G
</td>
</tr>
</tbody>
</table>


<ul>
<li><p>版本信息</p>

<ul>
<li>Libvirtd: 0.9.10</span></li></li>
<li>Hyper-V：6.1（基于Windows Server 2008的组件）</li>
</ul>
</li>
<li><p>测试工具</p>

<ul>
<li>HD Tune Pro 5.0</li>
</ul>
</li>
</ul>


<h2>性能测试结果</h2>

<p>为了尽量保持客观及测试的准确性，本次主要测试：随机访问读、文件基准
* 随机访问读
基于KVM的Windows 2008，192.168.30.120测试结果如下：</p>

<p><img src="http://agenge.github.io/images/2013/03/k-h-test_01.png"></p>

<p>基于Hyper-V的Windows 2008，192.168.30.136测试结果如下：</p>

<p><img src="http://agenge.github.io/images/2013/03/k-h-test_02.png"></p>

<p>从以上两个结果集中的IOPS和平均读取速率两个参数可看出，基于Hyper-V随机读的明显要优于基于KVM随机读。</p>

<ul>
<li>文件基准
基于KVM的Windows 2008，192.168.30.120，文件大小：10G，数据随机读写，测试结果如下：</li>
</ul>


<p><img src="http://agenge.github.io/images/2013/03/k-h-test_03.png"></p>

<p>基于Hyper-V的Windows 2008，192.168.30.136，文件大小：10G，数据随机读写，测试结果如下：</p>

<p><img src="http://agenge.github.io/images/2013/03/k-h-test_04.png"></p>

<p>通过文件基准得出以下几个结论：</p>

<ol>
<li><p>基于KVM的小文件写要优于基于Hyper-V小文件写，而基于Hyper-V小文件读明显要好很多；</p></li>
<li><p>从整体来看，基于Hyper-V连续的小文件传输速度的IOPS要明显优于基于KVM；</p></li>
<li><p>通过块大小为64M的文件可看出，基于Hyper-V的读写都要强于基于KVM很多；</p></li>
</ol>


<p>以上的2个测试点几乎可判断出，基于Hyper-V的Windows客户机整体上来讲要占优势，如果客户机是Windows，强烈建议使用基于Hyper-V的虚拟化。最后欢迎各位吐槽。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Kindle PaperWhite开箱]]></title>
    <link href="http://agenge.github.io/blog/2013/03/10/kindle-paperwhite-open/"/>
    <updated>2013-03-10T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/03/10/kindle-paperwhite-open</id>
    <content type="html"><![CDATA[<p>自从Amazon发布PaperWhite之后，一直想拥有它，119刀，确实不贵。由于身在天朝，无法直接在Amazon网上邮购，海掏捏，偶觉得麻烦(主要是没经验)，且周期太长，淘宝的代购价普遍1100左右，最后通过朋友推荐，</p>

<p>淘宝有日版PaperWhite才780元(人民币)，还包邮。于是就下定决心购买，下面是不同阶段的过程。</p>

<ol>
<li>购买
下单之后，整体来讲快递的速度相当快，先来看整个交易时间周期：</li>
</ol>


<p><img src="http://agenge.github.io/images/2013/03/jy-01.jpg"></p>

<p>注：货是2013年02月08日下午收到的，由于刚好过春节，偶直到02月13日才上网确认收货。</p>

<p>下面是整个物流传递信息，可以看到在2013年01月25日下单，2013年02月05日才发货(估计卖家订单量太多，无法及时处理)，不过整个传递速度还是非常快滴。</p>

<p><img src="http://agenge.github.io/images/2013/03/wl-01.jpg"></p>

<p>2.开箱
包装正面图：</p>

<p><img src="http://agenge.github.io/images/2013/03/pw-01.jpg"></p>

<p>包装内部图1：</p>

<p><img src="http://agenge.github.io/images/2013/03/pw-03.jpg"></p>

<p>机身正面图：</p>

<p><img src="http://agenge.github.io/images/2013/03/pw-06.jpg"></p>

<p>细心的同学可能已经发现这是多看系统的屏保。 :)</p>

<p>皮套正面图：</p>

<p><img src="http://agenge.github.io/images/2013/03/pw-05.jpg"></p>

<p>我的阅历：</p>

<p><img src="http://agenge.github.io/images/2013/03/pw-07.jpg"></p>

<p>介个时间分布的统计方式有严重Bug，偶每天6:50起床，00:00&mdash;6:50之间的数据何来？现在看来此问题只有多看团队能够解答。</p>

<p>最后，希望多看团队再接再厉吧，尽管Kindle原生系统已经非常优秀，但偶更喜欢对中文支持最好的多看系统。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hyper-V使用手册之部署与安装]]></title>
    <link href="http://agenge.github.io/blog/2013/03/08/hyper-v-01/"/>
    <updated>2013-03-08T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/03/08/hyper-v-01</id>
    <content type="html"><![CDATA[<h2>安装Hyper-V前提条件</h2>

<ul>
<li>先决条件一：基于Windows Server 2008 64bit的标准版、企业版、数据中心版.</li>
<li>先决条件二：硬件辅助虚拟化，即只有特定的CPU虚拟化选项，通常Intel 的技术叫：Intel-VT(Vanderpool Technology)，而AMD称为：AMD-V。 通常，绝大部分主板的BIOS在默认情况下未开启VT技术，需要自行进入BIOS修改。</li>
<li>先决条件三：硬件数据执行保护（DEP. 需要开启，如果CPU支持Windwos Server 2008，默认即开启。</li>
<li>快速检测系统是否支持虚拟化：</li>
<li>使用工具securable可轻松检测，三个选项必须全部支持，即全部是绿色的。</li>
<li>使用工具EVEREST（需要安装. 也可检测CPU是否支持VT，即Menu->Motherboard->CPUID->Virtual Machine Extensions(Vanderpool)，例如下图：</li>
</ul>


<p><img src="http://agenge.github.io/images/2013/03/vtdisabled.png"></p>

<p>表示此计算机不支持VT。</p>

<h2>2、安装Hyper-V及虚拟机</h2>

<h3>2.1 安装Hyper-V</h3>

<p>默认情况下，Windows Server 2008 R2 没有安装Hyper-V相关包，需要手动安装才可使用，过程如下：</p>

<p>点击系统任务栏的“服务器管理器”，在左侧的菜单栏点击角色，这里右侧会相应的显示角色相关信息，在角色摘要下的右边，点击”添加角色”，如：</p>

<p><img src="http://agenge.github.io/images/2013/03/c2-01.png"></p>

<p>点击”添加角色”之后，将会进入“添加角色向导”，点击下一步，在”选择服务器角色”页，勾选Hyper-V，如下图所示：</p>

<p><img src="http://agenge.github.io/images/2013/03/c2-02.png"></p>

<p>默认一直点“下一步”->“安装”，完成后需要重启服务器，如图所示：</p>

<p><img src="http://agenge.github.io/images/2013/03/c2-03.png"></p>

<p>点击“关闭”再确定“重启服务器”就已经完成Hyper-V的安装。如果服务器不支持Hyper-V，则会提示无法安装，如下图所示：</p>

<p><img src="http://agenge.github.io/images/2013/03/c2-04.png"></p>

<h3>2.2 安装虚拟机</h3>

<h4>2.1.1 连接Hyper-V管理器</h4>

<p>安装Hyper-V之后，必然要进行安装虚拟操作系统，即虚拟机，首先打开”服务器管器”(Windows7、8可直接打开Hyper-V管理器,依次展开：角色=>Hyper-V=>Hyper-V管理器，
在最右边的“操作”面板点击“连接到服务器”，在随即出来的“选择计算机”对话框点击“确定”，如下图所示：</p>

<p><img src="http://agenge.github.io/images/2013/03/c2-05.png"></p>

<ul>
<li>第一步、新建虚拟机（以下为Win8英文环境. ：
点击最右侧“Action”栏下面的“New”：</li>
</ul>


<p> <img src="http://agenge.github.io/images/2013/03/c2-06.png"></p>

<p> 点击后将会有3个选择：虚拟机(Virtual Machine)、磁盘(Hard Disk)、软盘(Floppy Disk)，选择“Virtual Machine”进入第二步。</p>

<ul>
<li>第二步、虚拟机命名：</li>
</ul>


<p> 在”New Virtual Machine Wizard”页的”Name”处键入虚拟机的名称，如MS2008：</p>

<p> <img src="http://agenge.github.io/images/2013/03/c2-07.png"></p>

<p> 点击“Next”。</p>

<ul>
<li>第三步、内存分配：</li>
</ul>


<p> 在“分配内存”页键入需要的内存，例如输入“1024”：</p>

<p> <img src="http://agenge.github.io/images/2013/03/c2-08.png"></p>

<p> 点击“Next”。</p>

<ul>
<li>第四步、网络配置：</li>
</ul>


<p> 在“网络配置”页暂时不选择,如下图：</p>

<p> <img src="http://agenge.github.io/images/2013/03/c2-09.png"></p>

<p> 点击“Next”。</p>

<ul>
<li>第五步、创建虚拟磁盘：</li>
</ul>


<p> <img src="http://agenge.github.io/images/2013/03/c2-10.png"></p>

<p> 创建一个虚拟磁盘</li>
  * Name:：虚拟磁盘的名字，一个虚拟机可配置多个硬盘，在同一个目录下，虚拟磁盘名字必须唯一；
  * Location：虚拟磁盘存储位置，默认存放在C盘，点击右侧的“Browser”可自定义虚拟磁盘存储位置；</p>

<p> <strong><em>建议：如果在有条件的环境下，建议将每个虚拟机对应的虚拟磁盘单独放在一个磁盘分区，甚至将每个虚拟磁盘单独存放在单独的磁盘分区。如果条件有限，建议将虚拟磁盘文件尽量放在空闲的系统分区。</em></strong></p>

<ul>
<li>Size：默认情况下是 127GB，单个虚拟磁盘最大值为64T；</li>
</ul>


<p> 注：此处127GB并不会马上扩展，而是动态扩展，也可自定义大小，最小值依所安装的操作系统而定。
 * 选择一个已存在的虚拟磁盘</li></p>

<p>  <img src="http://agenge.github.io/images/2013/03/c2-11.png"></p>

<p>  <!-- more -->
  选择已存在的虚拟磁盘，所下图：</p>

<p>  <img src="http://agenge.github.io/images/2013/03/c2-12.png"></p>

<p>  点击“下一步”=>“完成”，开始创建虚拟机。</p>

<ul>
<li>稍后添加一个虚拟磁盘</li>
</ul>


<p>  选择此选项的原因可能有多方面：</p>

<ul>
<li> 第一，可能已经存在需要的虚拟磁盘；</li>
<li><p> 第二，可能计划在此后通过”新建虚拟磁盘向导”自定义创建磁盘，例如创建固定大小的磁盘，而非创建动态虚拟磁盘。</p></li>
<li><p>第六步、安装虚拟机选项：</p></li>
</ul>


<p> 此处共3个选项：</p>

<ul>
<li>稍后安装操作系统：在完成创建虚拟机后选择引导方式.</li>
<li>从CD/DVD-ROM引导并安装操作系统，可分两种方式引导.</li>
<li>Media：通过物理CD/DVD引导.</li>
<li>Image file(.iso)：通过镜像文件引导操作系统，即.ISO文件.</li>
</ul>


<p> <img src="http://agenge.github.io/images/2013/03/c2-131.png"></p>

<ul>
<li><p>从软盘引导并安装操作系统: 不过多介绍，现在几乎不用此方式，也不推荐使用.</p></li>
<li><p>第七步、完成创建虚拟机向导，即摘要：</p></li>
</ul>


<p> <img src="http://agenge.github.io/images/2013/03/c2-14.png"></p>

<p> 点击“Finish”开始创建，此时可看到整个过程的执行进度，创建完成后可在Hyper-V管理器中看到刚才创建的虚拟机“MS2008”：</p>

<p> <img src="http://agenge.github.io/images/2013/03/c2-15.png"></p>

<h4>2.1.2 连接并创建虚拟机</h4>

<p>连接刚才所创建的虚拟机，并启动及引导安装操作系统，连接虚拟机方式：</p>

<ul>
<li><p>双击要启动的虚拟机；</p></li>
<li><p>点击Hyper-V管理器右下方的Connect；</p></li>
</ul>


<p><img src="http://agenge.github.io/images/2013/03/c2-16.png"></p>

<p>点击
<img src="http://agenge.github.io/images/2013/03/c2-17.png">
即可启动引导安装操作系统，之后的操作系统安装步骤本文不做介绍同，如有需要，请自行到网络上查找。</p>

<h2>3. Hyper-V网络管理</h2>

<p>在默认情况下，新建的虚拟机无法连接网络，那要如何配置才能上网？ 在介绍之前先说下Hyper-V的三种网络类型：</p>

<p>在Hyper-V中，有3种不同的网络配置方式(本例主要介绍 External 类型，其他类型请读者自行测试)：</p>

<ol>
<li><p>External：让虚拟机与外部的网络连通，即使用单独的IP地址；</p></li>
<li><p>Internal：让多台虚拟机之间内部连通，也可通过VLan将多个网络隔开；</p></li>
<li><p>Private：独立的网络，不与任何外部网络连接；</p></li>
</ol>


<p><em><em>_注意：由于在创建虚拟网络过程中，会导致服务器的网络暂时中断不到1分钟，故在创建虚拟网络之前，一定要确保是在服务器本地操作，远程桌面连接的同学一定要注意。</em>)</em></p>

<p>创建External 网络类型示例如下：</p>

<ol>
<li>在Hyper-V管理器主界面的右边的”Virtual Switch Manager”之后，出现如下图：</li>
</ol>


<p> <img src="http://agenge.github.io/images/2013/03/c3-01.png"></p>

<ol>
<li>选中(默认)“External”后，点击“Create Virtual Switch”，如下所示：</li>
</ol>


<p> <img src="http://agenge.github.io/images/2013/03/c3-02.png"></p>

<p> 这里有两个地方需要注意：</p>

<ul>
<li><p>“Name”可以自定义，示例中叫：MyExternal。</p></li>
<li><p>在外部网络(External network)选项下面点击图中第二个红色框的下拉菜单选择具体的网卡，</p></li>
</ul>


<p> 点击“Apply”，再点击“Yes”(点击Yes之前，请仔细阅读本章开始处的提醒)，开始创建虚拟网络，
在创建完之后，点击“Ok”即完成创建虚拟网络的整个过程。</p>

<h2>3、Hyper-V 存储设置</h2>

<p>对于虚拟机来说，存储的设计及设置无疑成为了Hyper-V管理员最为头疼的问题，存储的设置好与坏直接决定着虚拟机的性能，甚至整个虚拟化项目的性能。本节主要从两方面介绍磁盘创建和管理相关设置。</p>

<h3>3.1 磁盘管理</h3>

<p>在Hyper-V管理器主界面点击“编辑磁盘”，在弹出的“编辑虚拟磁盘向导”点击浏览，并选择要进行</p>

<p>编辑的虚拟磁盘，如下图所示：</p>

<p><img src="http://agenge.github.io/images/2013/03/c4-01.png"></p>

<p>点击“下一步”后将会有3个选择：</p>

<p><img src="http://agenge.github.io/images/2013/03/c4-02.png"></p>

<p>三个选项的详细介绍如下：</p>

<ol>
<li>压缩：该选项通过删除从磁盘中删除数据时留下的空白空间来减小虚拟硬盘文件的大小。</li>
</ol>


<p> 这里再通过一个例子来解释一下：假如原来的虚拟磁盘因为种种原因，已经从最开始的20G占用空间增加到60G占用空间，而现在为了节省虚拟机的磁盘空间，要删除约20G的垃圾数据以便留出空间（还有40G数据. ，但删除后，对应的虚拟磁盘文件在宿主机看来并不会因为虚拟机的数据删除而减少空间（还有60G. ，此时就需要通过压缩来减小虚拟磁盘的文件大小，压缩后的大小约为40G。直接点“下一步”=&gt;”完成”，就完成虚拟磁盘的压缩操作。</p>

<ol>
<li><p>转换：该选项主要是将动态扩展的虚拟磁盘文件转换为固定大小的磁盘文件，该操作是无损的，即转换时不会对虚拟磁盘文件造成任何损坏。点击“下一步”，选择要存储虚拟磁盘文件的名称和具体位置，再点击“完成”。</p></li>
<li><p>扩展：该选项可扩展虚拟磁盘的容量。这个比较好理解，即在原有的基础上增加虚拟磁盘的大小，例如原来有50G的虚拟磁盘空间不够使用，通过扩展增加到80G或者更多，最大为2T。点击“下一步”，并输入虚拟磁盘空间的大小，最大值为2T。</p></li>
</ol>


<p> 另，为了数据的安全性及虚拟机的稳定性，建议选择在业务空闲时关闭虚拟机操作。如果只是测试，那可随意操作。</p>

<h3>3.2 磁盘创建</h3>

<p>Hyper-V支持两种磁盘类型：虚拟磁盘和物理磁盘，两种磁盘类型的性能不用多说，物理磁盘肯定强过虚拟磁盘N倍，但并不是说虚拟磁盘并无任何优势，虚拟磁盘的优势主要有以下几点：</p>

<ul>
<li><p>VHD文件类型较多: 固定虚拟磁盘、动态虚拟磁盘及差异虚拟磁盘，可灵活选择。固定和动态
虚拟磁盘不过多介绍，而差异虚拟磁盘主要存储所关联的父盘修改后的数据。</p></li>
<li><p>管理简单、维护成本低：随时备份VHD文件、随时迁移VHD文件、可很方便调整VHD文件的大小 ，从而也使得维护成本较低。</p></li>
</ul>


<p>创建虚拟磁盘可通过两种方式：</p>

<ol>
<li><p>在Hyper-V管理器左面板的服务器节点右击，“新建”=&gt;“硬盘”。</p></li>
<li><p>点击右面板的“新建”=&gt;“硬盘”，连续单击“下一步”，选择虚拟磁盘类型，”下一步”再选择虚拟磁盘名称和文件存储位置，再次单击“下一步”转到“配置磁盘”，所下图所示：</p></li>
</ol>


<p><img src="http://agenge.github.io/images/2013/03/c4-03.png"></p>

<p>本次先讲到这里，下次将介绍Hyper-V的高级知识，例如动态内存管理、动态迁移等；</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[awstats 安装与配置分析IIS日志]]></title>
    <link href="http://agenge.github.io/blog/2013/02/04/awstats-install-conf/"/>
    <updated>2013-02-04T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/02/04/awstats-install-conf</id>
    <content type="html"><![CDATA[<h2>1、准备环境：</h2>

<ul>
<li>Windows Server 2003</li>
<li>IIS 6</li>
<li>ActivePerl-5.16</li>
<li>awstats-7.0</li>
</ul>


<h2>2、安装ActivePerl</h2>

<p>安装Perl for Windows，我们只需要安装ActivePerl 就行了，下载地址为：</p>

<p>32位：<a href="http://downloads.activestate.com/ActivePerl/releases/5.16.2.1602/ActivePerl-5.16.2.1602-MSWin32-x86-296513.msi">ActivePerl-5.16.2</a>                    64位：<a href="http://downloads.activestate.com/ActivePerl/releases/5.16.2.1602/ActivePerl-5.16.2.1602-MSWin32-x64-296513.msi">ActivePerl-5.16.2</a></p>

<p>ActivePerl 的具体安装步骤就不再写出，只管点击“下一步”，安装完之后确认是否已经安装Perl，例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\Documents and Settings\Administrator&gt;perl -v
</span><span class='line'>
</span><span class='line'>This is perl 5, version 16, subversion 2 (v5.16.2) built for MSWin32-x86-multi-t
</span><span class='line'>hread
</span><span class='line'>(with 1 registered patch, see perl -V for more detail)
</span><span class='line'>
</span><span class='line'>Copyright 1987-2012, Larry Wall
</span><span class='line'>
</span><span class='line'>Binary build 1602 [296513] provided by ActiveState http://www.ActiveState.com
</span><span class='line'>Built Dec 19 2012 12:35:59
</span><span class='line'>
</span><span class='line'>Perl may be copied only under the terms of either the Artistic License or the
</span><span class='line'>GNU General Public License, which may be found in the Perl 5 source kit.
</span><span class='line'>
</span><span class='line'>Complete documentation for Perl, including FAQ lists, should be found on
</span><span class='line'>this system using "man perl" or "perldoc perl". If you have access to the
</span><span class='line'>Internet, point your browser at http://www.perl.org/, the Perl Home Page.</span></code></pre></td></tr></table></div></figure>


<p>如何没有以上类似信息输出，请确认环境变量是否正确。</p>

<!-- more -->


<h2>3、安装awstats</h2>

<p>安装之后就会弹出一个DOS窗口，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>----- AWStats awstats_configure 1.0 (build 1.9) (c) Laurent Destailleur -----
</span><span class='line'>This tool will help you to configure AWStats to analyze statistics for
</span><span class='line'>one web server. You can try to use it to let it do all that is possible
</span><span class='line'>in AWStats setup, however following the step by step manual setup
</span><span class='line'>documentation (docs/index.html) is often a better idea. Above all if:
</span><span class='line'>- You are not an administrator user,
</span><span class='line'>- You want to analyze downloaded log files without web server,
</span><span class='line'>- You want to analyze mail or ftp log files instead of web log files,
</span><span class='line'>- You need to analyze load balanced servers log files,
</span><span class='line'>- You want to 'understand' all possible ways to use AWStats...
</span><span class='line'>Read the AWStats documentation (docs/index.html).
</span><span class='line'>
</span><span class='line'>-----&gt; Running OS detected: Windows
</span><span class='line'>
</span><span class='line'>-----&gt; Check for web server install
</span><span class='line'>awstats_configure did not find your Apache web main runtime.
</span><span class='line'>
</span><span class='line'>Please, enter full directory path of your Apache web server or
</span><span class='line'>'none' to skip this step if you don't have local web server or
</span><span class='line'>don't have permission to change its setup.
</span><span class='line'>Example: c:\Program files\apache group\apache
</span><span class='line'>Apache Web server path ('none' to skip):
</span><span class='line'>&gt; none
</span><span class='line'>
</span><span class='line'>Your web server config file(s) could not be found.
</span><span class='line'>You will need to setup your web server manually to declare AWStats
</span><span class='line'>script as a CGI, if you want to build reports dynamically.
</span><span class='line'>See AWStats setup documentation (file docs/index.html)
</span><span class='line'>
</span><span class='line'>-----&gt; Update model config file 'C:/Program Files/AWStats\wwwroot\cgi-bin\awstat
</span><span class='line'>s.model.conf'
</span><span class='line'>File awstats.model.conf updated.
</span><span class='line'>
</span><span class='line'>-----&gt; Need to create a new config file ?
</span><span class='line'>Do you want me to build a new AWStats config/profile
</span><span class='line'>file (required if first install) [y/N] ? y
</span><span class='line'>
</span><span class='line'>-----&gt; Define config file name to create
</span><span class='line'>What is the name of your web site or profile analysis ?
</span><span class='line'>Example: www.mysite.com
</span><span class='line'>Example: demo
</span><span class='line'>Your web site, virtual server or profile name:
</span><span class='line'>&gt; yfb.10086.cn
</span><span class='line'>
</span><span class='line'>-----&gt; Create config file 'C:/Program Files/AWStats\wwwroot\cgi-bin\awstats.yfb.
</span><span class='line'>10086.cn.conf'
</span><span class='line'>Config file C:/Program Files/AWStats\wwwroot\cgi-bin\awstats.yfb.10086.cn.conf
</span><span class='line'>created.
</span><span class='line'>
</span><span class='line'>-----&gt; Add update process inside a scheduler
</span><span class='line'>Sorry, for Windows users, if you want to have statistics to be
</span><span class='line'>updated on a regular basis, you have to add the update process
</span><span class='line'>in a scheduler task manually (See AWStats docs/index.html).
</span><span class='line'>Press ENTER to continue...      # 按回车
</span><span class='line'>A SIMPLE config file has been created: C:/Program Files/AWStats\wwwroot\cgi-bin\
</span><span class='line'>awstats.yfb.10086.cn.conf
</span><span class='line'>You should have a look inside to check and change manually main parameters.
</span><span class='line'>You can then manually update your statistics for 'yfb.10086.cn' with command:
</span><span class='line'>&gt; perl awstats.pl -update -config=yfb.10086.cn
</span><span class='line'>You can also build static report pages for 'yfb.10086.cn' with command:
</span><span class='line'>&gt; perl awstats.pl -output=pagetype -config=yfb.10086.cn
</span><span class='line'>
</span><span class='line'>Press ENTER to finish...       # 按回车</span></code></pre></td></tr></table></div></figure>


<h2>4、awstats 配置</h2>

<h3>4.1 配置日志格式</h3>

<p>右击“yfb.10086.cn”->“属性”，在“网站”选项卡选择“W3C 扩展日志文件格式”，点击“属性”->“高级”，确保以下字段勾选，其他全部取消：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>date
</span><span class='line'>time
</span><span class='line'>c-ip
</span><span class='line'>cs-username
</span><span class='line'>cs-method
</span><span class='line'>cs-uri-stem
</span><span class='line'>cs-uri-query
</span><span class='line'>sc-status
</span><span class='line'>sc-bytes
</span><span class='line'>cs-version
</span><span class='line'>cs(User-Agent)
</span><span class='line'>cs(Referer)</span></code></pre></td></tr></table></div></figure>


<h3>4.2 建立虚拟目录</h3>

<ul>
<li><p>建立虚拟目录cgi-bin,在网站节点下点击“yfb.10086.cn”->“新建”->“虚拟目录”，下一步，别名填写：cgi-bin，路径为C:\Program Files\AWStats\wwwroot\cgi-bin，权限设置为：读取、运行脚本、执行；</p></li>
<li><p>建立虚拟目录icon,在网站节点下点击“yfb.10086.cn”->“新建”->“虚拟目录”，下一步，别名填写：icon，路径为C:\Program Files\AWStats\wwwroot\icon，权限设置为：读取、运行脚本、执行；</p></li>
</ul>


<h3>4.3 修改awstats.domain_name.conf</h3>

<p>例如：awstats.yfb.10086.cn.conf，路径为网站根目录下的cgi-bin，打开awstats.yfb.10086.cn.conf并修改以下几个变量值：</p>

<ul>
<li>LogFile修改为：LogFile=&ldquo;C:/WINDOWS/system32/LogFiles/W3SVC1237985490/ex%YY-24%MM-24%DD-24.log&#8221;，修改之前确保C:/WINDOWS/system32/LogFiles/W3SVC1237985490 这个路径已经存在。</li>
<li>LogType 默认值（W）即可，W表示 web log ，S 为流日志，M为邮件日志，F为FTP日志。</li>
<li>LogFormat 修改为LogFormat=2，表示IIS日志，1表示Apache日志。</li>
</ul>


<p>更新：根据IIS在实际情况下来看，此处设置2仍然无法按照我们之前设置的日志格式打印日志，所以设置成：</span></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LogFormat="date time cs-method cs-uri-stem cs-username c-ip cs-version cs(User-Agent) cs(Referer) sc-status sc-bytes"</span></code></pre></td></tr></table></div></figure>


<ul>
<li>AllowToUpdateStatsFromBrowser 设置为1，表示允许从浏览器手动更新，但需要修改日志目录的权限为&#8221;IUSR_XXX&#8221; 读写，设置为0表示只允许从命令行更新；</li>
<li>将LoadPlugin=&ldquo;timezone +2&#8221;修改为LoadPlugin=&#8221;timezone +8&#8221;，并将最前面的“#”号删除。</li>
</ul>


<h3>4.4 重启IIS</h3>

<p>重启IIS后，并删除C:/WINDOWS/system32/LogFiles/W3SVC1237985490目录下所有的日志。</p>

<h2>5、生成awstats数据</h2>

<h3>5.1 手动生成awstats 数据</h3>

<p>打开一个DOS窗口，并切换到网站根目录/cgi-bin，执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;perl awstats.pl -config=yfb.10086.cn -update
</span><span class='line'>
</span><span class='line'>Create/Update database for config "./awstats.yfb.10086.cn.conf" by AWStats versi
</span><span class='line'>on 7.0 (build 1.971)
</span><span class='line'>From data in log file "C:/WINDOWS/system32/LogFiles/W3SVC1237985490/ex130130.log
</span><span class='line'>"...
</span><span class='line'>Phase 1 : First bypass old records, searching new record...
</span><span class='line'>Searching new records from beginning of log file...
</span><span class='line'>Phase 2 : Now process new records (Flush history on disk after 20000 hosts)...
</span><span class='line'>Jumped lines in file: 0
</span><span class='line'>Parsed lines in file: 84
</span><span class='line'>Found 0 dropped records,
</span><span class='line'>Found 4 comments,
</span><span class='line'>Found 0 blank records,
</span><span class='line'>Found 0 corrupted records,
</span><span class='line'>Found 0 old records,
</span><span class='line'>Found 80 new qualified records.</span></code></pre></td></tr></table></div></figure>


<p>如果报以下错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Create/Update database for config "./awstats.yfb.10086.cn.conf" by AWStats versi
</span><span class='line'>on 7.0 (build 1.971)
</span><span class='line'>From data in log file "C:/WINNT/system32/LogFiles/W3SVC1237985490/ex130130.log".
</span><span class='line'>..
</span><span class='line'>Error: Couldn't open server log file "C:/WINNT/system32/LogFiles/W3SVC1237985490
</span><span class='line'>/ex130130.log" : No such file or directory
</span><span class='line'>Setup ('./awstats.yfb.10086.cn.conf' file, web server or permissions) may be wrong.
</span><span class='line'>Check config file, permissions and AWStats documentation (in 'docs' directory).</span></code></pre></td></tr></table></div></figure>


<p>请确保你的日志文件路径是否写正确，日志目录是否有权限等；</p>

<p>由于每次都需要手动生成数据，对于我们这种懒人来讲是不可接受的，那怎么自动生成数据呢？</p>

<p>5.2 自动生成awstats数据</p>

<p>首先，您得在C:\Program Files\AWStats\wwwroot\cgi-bin目录创建一个批处理：awstatsUpdate.bat，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd C:/
</span><span class='line'>cd C:\Program Files \AWStats\wwwroot\cgi-bin
</span><span class='line'>perl awstats.pl -config=yfb.10086.cn -update</span></code></pre></td></tr></table></div></figure>


<p>注意：以上部分需要根据您的实际情况修改，yfb.10086.cn是需要偶自己的内网域名，千万不可盲目复制。</p>

<p>创建之后，您最好在DOS窗口单独测试下是否能正常运行，如无问题再添加计划任务。</p>

<p>如何增加一个计划任务的具体步骤由于过于简单此不再写出，相信您肯定会添加计划任务，至于任务的调度时间要根据您的需求来定，5分钟也好、5小时也罢，适合您的需求就好，例如本人就是设置的5分钟。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Win8通过PLSQL连接Oracle]]></title>
    <link href="http://agenge.github.io/blog/2013/01/26/win8_plsql_conn_oracle/"/>
    <updated>2013-01-26T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2013/01/26/win8_plsql_conn_oracle</id>
    <content type="html"><![CDATA[<p>偶一直比较喜欢新产品并很愿意去尝试，虽说特喜欢Linux，但Win8正式版发布后，立即将公司的笔记本第一时间从Ubuntu 10.04迁移到Win8 64位企业版，本文不介绍Win8、不介绍安装Oracle11g，而是记录偶在Win8系统通过PL/SQL连接Oracle的经过，以便于各位看客少走弯路，此问题折腾偶整整一天，费话就此打住，开始：</p>

<ol>
<li><p>首先您得安装一个Oracle 11g 64位，建议只安装数据库软件，不创建数据库实例，偶安装后的路径：E:\app\agen\product\11.2.0\dbhome_1Oracle database 11g For Windows 共有2安装包，下载地址：<a href="http://download.oracle.com/otn/nt/oracle11g/112010/win64_11gR2_database_1of2.zip" title="iso1">iso1</a>  | <a href="http://download.oracle.com/otn/nt/oracle11g/112010/win64_11gR2_database_2of2.zip" title="iso2">iso2</a></p></li>
<li><p>必须再安装一个Oracle 11g 32位的客户端，下载地址：<a href="http://download.oracle.com/otn/nt/instantclient/112010/instantclient-basic-win32-11.2.0.1.0.zip" title="instantclient-basic">instantclient-basic-win32-11.2.0.1.0</a>将 instantclient_11_2 解压到：E:\app\agen\product，并把 tnsnames.ora 复制到instantclient_11_2下；</p></li>
<li><p>安装PL/SQL DEV，安装包、注册码及汉化包，请见：<a href="http://www.oracle.com.cn/viewthread.php?tid=158668" title="PLSQL DEV +注册机 + 汉">PL/SQL Dev + 注册机 + 官方简体中文</a>，安装后，在登录时选择取消，弹出PLSQL DEV的界面，选择：“工具”-&gt;“首选项”，分别设置如下：</p></li>
<li><p>Oracle 主目录名：E:\app\agen\product\instantclient_11_2</p></li>
<li><p>OCI库：E:\app\agen\product\instantclient_11_2\oci.dll</p></li>
</ol>


<p> 点击“应用”->“确定”，并关闭PL/SQL。</p>

<ol>
<li>设置环境变量：</li>
<li>在系统环境变量，选择“Path”，点击“编辑”，在最前面加入以下路径：E:\app\agen\product\instantclient_11_2，并确认。</li>
<li>新建变量名称：TNS_ADMIN， 变量值：E:\app\agen\product\instantclient_11_2(因为我们的tnsnames.ora在这里啦)。</li>
<li>新建变量名称：NLS_LANG， 变量值：SIMPLIFIED CHINESE_CHINA.ZHS16GBK</li>
</ol>


<p> 请注意,此变量值通过以下SQL语句在数据库服务器得到：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT userenv(‘language’) nls_lang FROM dual;</span></code></pre></td></tr></table></div></figure>


<p>最后启动PLSQL，如果您所有步骤顺利通过，就可连接到数据库。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Puppet用户手册--安装与配置]]></title>
    <link href="http://agenge.github.io/blog/2012/12/21/puppet_install_conf/"/>
    <updated>2012-12-21T00:00:00+08:00</updated>
    <id>http://agenge.github.io/blog/2012/12/21/puppet_install_conf</id>
    <content type="html"><![CDATA[<h2>1. 安装Puppet依赖环境</h2>

<p>在安装Puppet之前需要保证服务器已经安装以下软件：</p>

<ol>
<li>Ruby: 挂载ISO后，切换到/mnt/Server, 输入： yum  -y install ruby-*</li>
<li>Facter</li>
<li>Ruby所依赖的OpenSSL 库，运行以下命令来测试是否已经安装所依赖的库文件：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> ruby -ropenssl -e "puts :yep"</span></code></pre></td></tr></table></div></figure>


<p>
 如果输出“yep”表示无问题。</p>

<p><strong><em>注意：在安装Puppet之前，如果需要，必须将服务器主机名修改好，否则将会出现很多问题哟！</em></strong></p>

<h2>2. 安装Puppet服务器端</h2>

<p>由于本文基于源码安装，使用二进制包的安装方式本文不打算介绍，如有需要请自行到网上搜索。好了，首先将facter-2.0.0rc4.tar.gz、puppet-2.7.19.tar.gz上传到 Puppet服务端(192.168.56.2)，具体步骤如下</p>

<ul>
<li>安装facter：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget http://downloads.puppetlabs.com/facter/facter-2.0.0rc4.tar.gz
</span><span class='line'># tar zxvf facter-2.0.0rc4.tar.gz
</span><span class='line'># cd facter-2.0.0rc4
</span><span class='line'># ruby install.rb</span></code></pre></td></tr></table></div></figure>


<p> 安装后会提示是否有无问题，如下图所示，无任何错误：
 <img src="http://agenge.github.io/images/2012/12/1.png"></p>

<ul>
<li>安装Puppet:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget http://puppetlabs.com/downloads/puppet/puppet-2.7.20.tar.gz
</span><span class='line'># tar zxvf puppet-2.7.19.tar.gz
</span><span class='line'># cd puppet-2.7.19
</span><span class='line'># ruby install.rb</span></code></pre></td></tr></table></div></figure>


<p> 安装后会提示是否有无问题，如下图所示，无任何错误：
 <img src="http://agenge.github.io/images/2012/12/2.png"></p>

<p> 到此，Puppet服务端安装已经结束。</p>

<!-- more -->


<h2>3. 安装Puppet客户端 For Linux</h2>

<p>Puppet客户端的安装方式与服务端一样，故不再详细介绍，详细请见第二章。</p>

<h2>4. 安装Puppet客户端 For Windows</h2>

<p>暂时不打算写！</p>

<h2>5. 配置Puppet服务端和客户端</h2>

<p>在配置之前，要确保Puppet服务端和所有Puppet客户端的本地时间一致，关于时间同步，推荐使用NTP(请参考网上的NTP详细介绍或MAN)。</p>

<h3>5.1 配置Puppet服务端：</h3>

<p>创建puppet组和用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># groupadd puppet
</span><span class='line'># useradd -g puppet -s /sbin/nologin puppet</span></code></pre></td></tr></table></div></figure>


<p>设置/etc/hosts：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># echo "192.168.56.2 puppetmaster.test.com puppetmaster" &gt;&gt; /etc/hosts
</span><span class='line'># echo "192.168.56.10 client1.test.com client1" &gt;&gt; /etc/hosts
</span><span class='line'># cp conf/namespaceauth.conf /etc/puppet/
</span><span class='line'># cp conf/redhat/puppet.conf /etc/puppet/
</span><span class='line'># cp conf/redhat/server.init /etc/init.d/puppetmaster
</span><span class='line'># chmod +x /etc/init.d/puppetmaster</span></code></pre></td></tr></table></div></figure>


<p>启动puppetmaster ，若无问题，显示如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/init.d/puppetmaster start
</span><span class='line'>Starting puppetmaster:                    [ OK ]
</span><span class='line'># chkconfig puppetmaster on</span></code></pre></td></tr></table></div></figure>


<h3>5.2  配置Puppet客户端：</h3>

<p>除了以下命令不一样，其他全部和服务端一样的配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cp conf/redhat/client.init /etc/init.d/puppet
</span><span class='line'># chmod +x /etc/init.d/puppet</span></code></pre></td></tr></table></div></figure>


<p>服务端对应命令如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cp conf/redhat/server.init /etc/init.d/puppetmaster</span></code></pre></td></tr></table></div></figure>


<p>启动puppet，若无问题，显示如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/init.d/puppet start
</span><span class='line'>Starting puppet:               [ OK ]
</span><span class='line'># chkconfig puppet on</span></code></pre></td></tr></table></div></figure>


<h3>5.3 Puppet服务端和客户端测试：</h3>

<p>Puppet客户端与服务器端是通过SSL隧道通信的，客户端安装完成后，需要向服务器端申请证书：</p>

<ul>
<li>首次连接服务器端会发起证书申请，在客户端执行命令如下</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> puppetd --server puppetmaster --test</span></code></pre></td></tr></table></div></figure>


<p> <img src="http://agenge.github.io/images/2012/12/3.png"></p>

<p> 执行以上命令代表客户端已经成功生成证书，并把证书签名请求发送到Puppet服务端.</p>

<ul>
<li>登录到Puppet服务端，查看所有客户端的证书签名请求：</li>
</ul>


<p> <img src="http://agenge.github.io/images/2012/12/4.png"></p>

<p> 从结果可看出，已经看到client1.test.com客户端的证书签名请求，最后对所有的证书请求进行签名：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppetca -s -a</span></code></pre></td></tr></table></div></figure>


<p> <img src="http://agenge.github.io/images/2012/12/5.png"></p>

<h3>5.4 示例：同步hosts文件(modules实现)</h3>

<ul>
<li>同步之前，先看下未使用module实现的简单示例：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 默认的节点配置
</span><span class='line'>node default {
</span><span class='line'>     file {
</span><span class='line'>             "/tmp/temp1.txt":
</span><span class='line'>             content =&gt; "Hello,Puppet!"; }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'># 同步/root/temp01.txt文件
</span><span class='line'>node "client1.test.com" {
</span><span class='line'>     host { "host1":
</span><span class='line'>     ip =&gt; "192.168.1.1",
</span><span class='line'>     target =&gt; "/root/temp01.txt",
</span><span class='line'>     ensure =&gt; present; }
</span><span class='line'>}
</span><span class='line'>node "feinno-hgg" {
</span><span class='line'>     host { "host2":
</span><span class='line'>     ip =&gt; "192.168.1.1",
</span><span class='line'>     target =&gt; "/root/temp01.txt",
</span><span class='line'>     ensure =&gt; present; }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>以上示例表示配置两个客户端，分别是“client1.test.com”和“feinno-hgg”，同时还有一个默认的node节点，后期如果有新客户端加入，在文件末尾加入一个新的node即可。但请再深入的思考一下，从后期的维护或管理角度来看，必须考虑下面两个重点的问题：</p>

<ul>
<li>问题1：假设您管理的不是10台，而是100台或者1000台，甚至更多，此种配置方式是否最优？</li>
<li>问题2：假设您管理的客户端是多架构平台的，例如Debian、CentOS、Solaris、AIX或</li>
</ul>


<p> Windows，如何解决跨平台的文件同步？</p>

<p> 使用示例1的配置方式，显示无法解决上面这两个问题，所以这就是我们下面要介绍的模块化实现。</p>

<ul>
<li>创建所须目录：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#/bin/mkdir -p /etc/puppet/modules/hosts/{files,lib,manifests,templates}
</span><span class='line'>#/bin/mkdir -p /etc/puppet/modules/hosts/files/hosts/etc</span></code></pre></td></tr></table></div></figure>


<ol>
<li>创建所须文件：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ll /etc/puppet/manifests/
</span><span class='line'>total 8
</span><span class='line'>-rw-r--r-- 1 root root 103 Oct 15 17:08 nodes.pp
</span><span class='line'>-rw-r--r-- 1 root root 52 Oct 15 17:04 site.pp</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat site.pp
</span><span class='line'># 导入nodes.pp
</span><span class='line'>import 'nodes.pp'
</span><span class='line'>$puppetserver="master.test.com"</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat nodes.pp
</span><span class='line'># 匹配所有以字母开头、.test.com结尾的客户端，并包含一个 hosts 的类文件
</span><span class='line'>node /^\w+\.test\.com$/  {    
</span><span class='line'>     include hosts
</span><span class='line'>}
</span><span class='line'>node 'feinno-hgg'  {
</span><span class='line'>     include hosts
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>nodes.pp中使用了正则表达式，这使得一个非常 简单的node可以匹配多个客户端，而对于特殊主机来讲，可单独在文件结尾添加node即可，从而解决我们刚才提到的第一个问题。再来看看modules下的2类文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ls -l /etc/puppet/modules/hosts/manifests
</span><span class='line'>-rw-r--r-- 1 root root 654 Oct 15 17:16 config.pp
</span><span class='line'>-rw-r--r-- 1 root root 47 Oct 12 11:20 init.pp</span></code></pre></td></tr></table></div></figure>


<p>查看init.pp</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> #cat init.pp
</span><span class='line'> # 定义一个hosts的类，并包括它的一个子类：hosts::config
</span><span class='line'> class hosts {
</span><span class='line'>     include hosts::config
</span><span class='line'> }</span></code></pre></td></tr></table></div></figure>


<p>查看config.pp</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat config.pp
</span><span class='line'># 定义一个hosts::config的子类，父类为 hosts
</span><span class='line'>class hosts::config inherits hosts {
</span><span class='line'>    if $operatingsystem in [ "RedHat","CentOS","Ubuntu","Fedora" ] {
</span><span class='line'>
</span><span class='line'>            file { "/etc/hosts":
</span><span class='line'>                owner =&gt; "root",
</span><span class='line'>                group =&gt; "root",
</span><span class='line'>                mode =&gt; 644,
</span><span class='line'>                source =&gt; "puppet://$puppetserver/hosts/etc/hosts",
</span><span class='line'>            }
</span><span class='line'>    }  elsif $operatingsystem == "Windows" {
</span><span class='line'>            file { "C:/Windows/System32/drivers/etc/hosts":
</span><span class='line'>                owner =&gt; "xm_Administrator",
</span><span class='line'>                group =&gt; "Administrators",
</span><span class='line'>                source =&gt; "puppet://$puppetserver/hosts/etc/win_hosts";
</span><span class='line'>            }
</span><span class='line'>    } else {
</span><span class='line'>        fail("Doesn't support this OS: $operatingsystem")
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>从config.pp中可看出，通过一个if/elsif决断语句，结合Puppet内置变量$operatingsystem可同步任何跨平台的操作系统的hosts文件，从而解决我们刚才提到的第二个问题。</p>

<ul>
<li>配置modules</li>
</ul>


<p> 细心的读者可能会问：Puppet如何识别的module？ 问的相当好，Puppet默认是无法识别自定义modules的，需要我们在puppet.conf的 [main]中配置一个参数：modulepath，例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat puppet.conf | grep module
</span><span class='line'>modulepath = /etc/puppet/modules</span></code></pre></td></tr></table></div></figure>


<p> 通过简单的参加配置，Puppet就可识别自定义模块。</p>

<ul>
<li>配置 Fileserver：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/puppet/fileserver.conf
</span><span class='line'>[hosts]
</span><span class='line'>        path /etc/puppet/modules/hosts/files
</span><span class='line'>        allow *</span></code></pre></td></tr></table></div></figure>


<p>此处配置一个hosts的文件服务，及指定文件存放位置，同时允许所有客户端同步，生产环境不建议直接对所有客户端开放。而我们之前在config.pp中的source后面的路径格式为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet://$puppetserver/mount_point/path</span></code></pre></td></tr></table></div></figure>


<p>例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet://$puppetserver/hosts/etc/hosts</span></code></pre></td></tr></table></div></figure>


<p>对应的绝对路径为：/etc/puppet/modules/hosts/files/etc/hosts</p>

<ol>
<li>Puppet客户端 for Windows 8客户端测试：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>D:\Program Files (x86)\Puppet Labs\Puppet\bin&gt;puppet.bat agent --test --server master.test.com
</span><span class='line'>info: Retrieving plugin
</span><span class='line'>info: Caching catalog for feinno-hgg
</span><span class='line'>info: Applying configuration version '1350292129'
</span><span class='line'>notice: /Stage[main]/Hosts::Config/File[C:/Windows/System32/drivers/etc/hosts]/content:
</span><span class='line'> 
</span><span class='line'>info: FileBucket got a duplicate file {md5}2c0dd3682bc4dbab317365a88af6177a
</span><span class='line'>info: /Stage[main]/Hosts::Config/File[C:/Windows/System32/drivers/etc/hosts]: Filebucketed C:/Windows/System32/drivers/etc/hosts to puppet with sum 2c0dd3682bc4dbab317365a88af6177a
</span><span class='line'>notice: /Stage[main]/Hosts::Config/File[C:/Windows/System32/drivers/etc/hosts]/content: content changed '{md5}2c0dd3682bc4dbab317365a88af6177a' to '{md5}09636a06eea3999e8b02ca831923f3d6'
</span><span class='line'>notice: this OS: windows.  Sync complete.
</span><span class='line'>notice: /Stage[main]/Hosts::Config/Notify[this OS: windows.  Sync complete.]/message: defined 'message' as 'this OS: windows.  Sync complete.'
</span><span class='line'>notice: Finished catalog run in 0.85 seconds</span></code></pre></td></tr></table></div></figure>


<p>通过日志可看出，已经成功同步win_host到C:/Windows/System32/drivers/etc/hosts 。</p>

<p><strong><em>提示：在MS 2008或Win 7、Win 8客户端同步时，注意C:/Windows/System32/drivers/etc的目录需要有写权限。</em></strong></p>

<h2>6. 管理Puppet服务</h2>

<h3>6.1 Puppet服务端启动、停止、重启过程如下：</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/init.d/puppetmaster start # 启动
</span><span class='line'># /etc/init.d/puppetmaster stop # 停止
</span><span class='line'># /etc/init.d/puppetmaster restart # 重启</span></code></pre></td></tr></table></div></figure>


<h3>6.2 Puppet客户端启动、停止、重启过程如下：</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/init.d/puppet start
</span><span class='line'># /etc/init.d/puppet stop
</span><span class='line'># /etc/init.d/puppet restart</span></code></pre></td></tr></table></div></figure>


<h3>6.3 Puppet For Windows客户端设置：</h3>

<p>在Windows下安装Puppet客户端后，会自动在系统服务中添加一个Puppet Agent服务，并已经设置为开机自启动，如果不是，请自行修改。</p>

<h3>6.4 设置Puppet服务端开机自启动：</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chkconfig puppetmaster on
</span><span class='line'># chkconfig --list puppetmaster</span></code></pre></td></tr></table></div></figure>


<h2>7. 常见错误</h2>

<h3>7.1 语法错误 puppetd -s puppetmaster.test.com –t</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/lib/ruby/site_ruby/1.8/puppet/application/agent.rb:54:in `handle_serve': uninitialized constant Puppet::Network::Handler (NameError)
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:363:in `send'
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:363:in `parse_options'
</span><span class='line'>    from /usr/lib/ruby/1.8/optparse.rb:1247:in `call'
</span><span class='line'>    from /usr/lib/ruby/1.8/optparse.rb:1247:in `order!'
</span><span class='line'>    from /usr/lib/ruby/1.8/optparse.rb:1205:in `catch'
</span><span class='line'>    from /usr/lib/ruby/1.8/optparse.rb:1205:in `order!'
</span><span class='line'>    from /usr/lib/ruby/1.8/optparse.rb:1279:in `permute!'
</span><span class='line'>    from /usr/lib/ruby/1.8/optparse.rb:1300:in `parse!'
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:370:in `parse_options'
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:305:in `run'
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:416:in `hook'
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:305:in `run'
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:407:in `exit_on_fail'
</span><span class='line'>    from /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:305:in `run'
</span><span class='line'>    from /usr/sbin/puppetd:4</span></code></pre></td></tr></table></div></figure>


<p>答：此问题由于版本太低导致，或修改参数形式，例如将-t  -s 修改成 &mdash;test &mdash;server。</p>

<h3>7.2  Could not load openssl Ruby library; cannot install</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># tar xvf openssl-0.9.8p.tar.gz
</span><span class='line'># cd openssl-0.9.8p
</span><span class='line'># cp ssl/ssl.h /root/ruby-1.8.7/ext/openssl/
</span><span class='line'># ./config -fPIC --prefix=/usr/local --openssldir=/usr/local/openssl enable-shared
</span><span class='line'># make && make install</span></code></pre></td></tr></table></div></figure>


<p>进入到ruby源码目录下的ext/openssl/：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /root/ruby-1.8.7/ext/openssl/
</span><span class='line'># ruby extconf.rb --with-openssl-include=/usr/local/openssl/include --with-openssl-lib=/usr/local/openssl/lib 
</span><span class='line'># make && make install</span></code></pre></td></tr></table></div></figure>


<h3>7.3   Error 400 on SERVER: Cannot find file: Invalid mount</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@client1 puppet]# puppetd --test
</span><span class='line'>info: Caching catalog for client1.test.com
</span><span class='line'>info: Applying configuration version '1349933729'
</span><span class='line'>err: /Stage[main]//Node[client1.test.com]/File[/etc/puppet/files/temp01.txt]: Could not evaluate: Error 400 on SERVER: Cannot find file: Invalid mount 'temp01.txt' Could not retrieve file metadata for puppet:///temp01.txt: Error 400 on SERVER: Cannot find file: Invalid mount 'temp01.txt' at /etc/puppet/manifests/site.pp:20
</span><span class='line'>notice: Finished catalog run in 0.45 seconds</span></code></pre></td></tr></table></div></figure>


<h3>7.4 err: Could not retrieve catalog from remote server: Connection refused</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@client1 puppet]# puppetd --test --server master.test.com
</span><span class='line'>err: Could not retrieve catalog from remote server: Connection refused - connect(2)
</span><span class='line'>warning: Not using cache on failed catalog
</span><span class='line'>err: Could not retrieve catalog; skipping run
</span><span class='line'>err: Could not send report: Connection refused - connect(2)</span></code></pre></td></tr></table></div></figure>


<p>该错误表示无法连接到Master，即Puppet服务端，由以下两个原因造成：</p>

<ol>
<li><p>Puppet服务端拒绝连接，通常是由于防火墙或selinux造成；</p></li>
<li><p>Puppet客户端本地防火墙导致</p></li>
</ol>


<p>本人在测试时遇到此问题，但经检查上述原因后，仍然报拒绝连接错误，经过约2小时的仔细排查，终于找到问题，原因却让我差点吐血， 以下是排查过程：</p>

<ul>
<li>第一步：查看Puppet服务端防火墙，发现是开启的，但无任何规则，关闭防火墙后，到客户端尝试，无果! 再查看Linux，问题仍在。</li>
<li>第二步：查看Puppet客户端防火墙，已是关闭状态，SELinux同样关闭状态。</li>
<li>第三步：尝试修改Puppet服务端的auth.conf文件，并重启puppetmaster后，问题仍在。</li>
<li>第四步：查看Puppet客户端所连接的服务端是否正确：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppet agent --configprint server</span></code></pre></td></tr></table></div></figure>


<p>打印的域名和hosts文件一致。</p>

<ul>
<li>第五步：查看Puppet服务端和Puppet客户端的hosts文件是否正确</li>
</ul>


<p> 在第一次查看这两个文件的时候，发现没问题，后来再从其他地方折腾回来看hosts文件的时候，</p>

<p> 发现Puppet客户端的hosts文件存在一个让本人都不好意思写出来的错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> # Do not remove the following line, or various programs
</span><span class='line'> # that require network functionality will fail.
</span><span class='line'> 127.0.0.1 master.test.com master localhost.localdomain localhost
</span><span class='line'> #::1 localhost6.localdomain6 localhost6
</span><span class='line'>  
</span><span class='line'> 192.168.56.2 master.test.com
</span><span class='line'> 192.168.56.10 client1.test.com
</span><span class='line'> 192.168.10.188 feinno-hgg</span></code></pre></td></tr></table></div></figure>


<p>终于发现问题所在，客户端的hosts写成这样，也确实不易，保存退出后，经测试问题已解决。这种低级错误都是平常不够严谨才造成的，且还花大量时间，所以当出现问题后，一定要非常仔细检查每个操作或步骤，只有这样，才能更高效的找到根源并解决。</p>

<h3>7.5 Could not evaluate: Error 400 on SERVER: Not authorized to call find</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>info: Caching catalog for client1.test.com
</span><span class='line'>info: Applying configuration version '1350282880'
</span><span class='line'>notice: this OS: RedHat.  Sync complete.
</span><span class='line'>notice: /Stage[main]/Hosts::Config/Notify[this OS: RedHat.  Sync complete.]/message: defined 'message' as 'this OS: RedHat.  Sync complete.'
</span><span class='line'>err: /Stage[main]/Hosts::Config/File[/etc/hosts]: Could not evaluate: Error 400 on SERVER: Not authorized to call find on /file_metadata/hosts/etc/hosts Could not retrieve file metadata for puppet://master.test.com/hosts/etc/hosts: Error 400 on SERVER: Not authorized to call find on /file_metadata/hosts/etc/hosts at /etc/puppet/modules/hosts/manifests/config.pp:10</span></code></pre></td></tr></table></div></figure>


<p>该问题由于没有通过Puppet服务端fileserver的认证造成，由于要同步文件资源，故需要在Puppet服务端Fileserver对应的mount point加上认证，例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/puppet/fileserver.conf
</span><span class='line'>[hosts]
</span><span class='line'>        path /etc/puppet/modules/hosts/files
</span><span class='line'>        allow client1.test.com</span></code></pre></td></tr></table></div></figure>


<h3>7.6 Failed to generate additional resources using &lsquo;eval_generate: SSL_connect</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>D:\Program Files (x86)\Puppet Labs\Puppet\bin&gt;puppet.bat agent --test --server master.test.com
</span><span class='line'>info: Retrieving plugin
</span><span class='line'>err: /File[C:/ProgramData/PuppetLabs/puppet/var/lib]: Failed to generate additional resources using 'eval_generate: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=master.test.com]
</span><span class='line'>err: /File[C:/ProgramData/PuppetLabs/puppet/var/lib]: Could not evaluate: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=master.test.com] Could not retrieve file metadata for puppet://master.test.com/plugins: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=master.test.com]
</span><span class='line'>
</span><span class='line'>err: Could not retrieve catalog from remote server: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=master.test.com]
</span><span class='line'>warning: Not using cache on failed catalog
</span><span class='line'>err: Could not retrieve catalog; skipping run
</span><span class='line'>err: Could not send report: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=master.test.com]</span></code></pre></td></tr></table></div></figure>


<p>此问题由于Puppet服务端和Puppet客户端的时间不一致导致，将服务端和客户端的时间修改成一致即可解决，如果确保时间一致，问题仍在，请重新生成证书，重新生成证书过程如下：</p>

<ol>
<li>在Puppet服务端清除证书：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppetca -c feinno-hgg</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在Puppet客户端删除证书：</li>
</ol>


<p> Linux客户端证书路径：</p>

<ul>
<li><p>MS2003：%ALLUSERSPROFILE%\Application Data\PuppetLabs\puppet\etc\ssl</p></li>
<li><p>MS2008：%PROGRAMDATA%\PuppetLabs\puppet\etc\ssl\</p></li>
</ul>


<p> 例如删除Linux客户端下的证书：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rm -fr /var/lib/puppet/ssl/*</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在Puppet客户端执行：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppetca --test --server master.test.com</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在Puppet客户端执行：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppetca –l</span></code></pre></td></tr></table></div></figure>


<p>如果有显示客户端的认证请求签名，则输入：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppetca -s feinno-hgg    #意思为客户端feinno-hgg的证书请求进行签名</span></code></pre></td></tr></table></div></figure>


<p>或：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppetca -s -a # 对所有的客户端进行证书签名</span></code></pre></td></tr></table></div></figure>


<h3>7.7 Could not retrieve information from environment production source(s)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>D:\Program Files (x8 6)\Puppet Labs\Puppet\bin&gt;puppet.bat agent --test --server master.test.com
</span><span class='line'>info: Caching certificate for feinno-hgg
</span><span class='line'>info: Retrieving plugin
</span><span class='line'>info: Caching certificate_revocation_list for ca
</span><span class='line'>err: /File[C:/ProgramData/PuppetLabs/puppet/var/lib]: Could not evaluate: Could
</span><span class='line'>not retrieve information from environment production source(s) puppet://master.t
</span><span class='line'>est.com/plugins
</span><span class='line'>info: Caching catalog for feinno-hgg
</span><span class='line'>info: Applying configuration version '1350284808'
</span><span class='line'>info: Creating state file C:/ProgramData/PuppetLabs/puppet/var/state/state.yaml
</span><span class='line'>notice: Finished catalog run in 0.18 seconds</span></code></pre></td></tr></table></div></figure>


<p>此问题是属于2.7.x 的一个Bug导致，即在Windows平台下Puppet客户端向Puppet服务端同步文件时，默认情况下会同步Puppet服务端的plug，那要怎么解决呢？操作如下：</p>

<p>在modules_name的目录下创建一个 lib的空目录即可。例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mkdir /etc/puppet/modules/mymodule/lib</span></code></pre></td></tr></table></div></figure>


<p>也可参考以下官方地址：<a href="https://projects.puppetlabs.com/issues/2244">https://projects.puppetlabs.com/issues/2244</a></p>

<h3>7.8 notice: Run of Puppet configuration client already in progress; skipping</h3>

<p>解决方法： 部分情况下puppet服务会无法启动，且会提示puppet已经启动，这个时候需要删除一个文件puppetdlock：</p>

<ul>
<li>Linux客户端绝对路径： /var/lib/puppet/state/puppetdlock</li>
<li>Windows 2003客户端绝对路径：C:\Documents and Settings\All Users\Application Data\PuppetLabs\puppet\var\state\ puppetdlock</li>
<li>Windows 2008客户端绝对路径：C:\ ProgramData\PuppetLabs\puppet\var\state\ puppetdlock</li>
</ul>


<h3>7.9 certificate verify failed: [CRL is not yet valid for /CN</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>err: /File[C:/ProgramData/PuppetLabs/puppet/var/lib]: Failed to generate additional resources using 'eval_generate: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=pmaster.i.12582.com]
</span><span class='line'>err: /File[C:/ProgramData/PuppetLabs/puppet/var/lib]: Could not evaluate: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=pmaster.i.12582.com] Could not retrieve file metadata for puppet://pmaster.i.12582.com/plugins: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=pmaster.i.12582.com]
</span><span class='line'>err: Could not retrieve catalog from remote server: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=pmaster.i.12582.com]
</span><span class='line'>warning: Not using cache on failed catalog
</span><span class='line'>err: Could not retrieve catalog; skipping run
</span><span class='line'>err: Could not send report: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed: [CRL is not yet valid for /CN=pmaster.i.12582.com]</span></code></pre></td></tr></table></div></figure>


<p>原因：</p>

<p>在配置证书时可能由于CA证书不匹配或被删除导致。</p>

<p>解决办法：</p>

<p>Master执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># puppet cert clean c02.i.12582.com</span></code></pre></td></tr></table></div></figure>


<p>客户端执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rm -f C:/ProgramData/PuppetLabs/puppet/etc/ssl/certs/c02.i.12582.com.pem
</span><span class='line'># puppetca –test</span></code></pre></td></tr></table></div></figure>


<p>此处需要注意一定别删除整个SSL目录，只需要删除指定的pem文件即可，另上面请根据实际情况修改。</p>

<h3>7.10 charset: utf8, collation: utf8_unicode_ci</h3>

<p>详细错误信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Couldn't create database for {"encoding"=&gt;"utf8", "adapter"=&gt;"mysql", "username"=&gt;"dashboard", "database"=&gt;"dashboard", "password"=&gt;"dashboard"}, charset: utf8, collation: utf8_unicode_ci (if you set the charset manually, make sure you have a matching collation)</span></code></pre></td></tr></table></div></figure>


<p>解决方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@pmaster puppet-dashboard-1.2.20]# ln -s /var/lib/mysql/mysql.sock /tmp/mysql.sock</span></code></pre></td></tr></table></div></figure>


<h3>7.11 undefined method `more_results&#8217; for #<Mysql></h3>

<p>解决方法：注释mysql_adapter.rb中的318和       642</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@connection.more_results && @connection.next_result    # invoking stored procedures with CLIENT_MULTI_RESULTS requires this
</span><span class='line'> to tidy up else connection will be dropped</span></code></pre></td></tr></table></div></figure>


<h3>7.12 undefined method `requirement&#8217; for #&lt;Rails:</h3>

<p>解决方法：修改gem_dependency.rb
注释掉81行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#gem self.name, self.requirement # &lt;  1.8 unhappy way </span></code></pre></td></tr></table></div></figure>


<p>修改为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem self.name, :version =&gt; (self.respond_to?(:requirement) ? self.requirement : self.version_requirements)</span></code></pre></td></tr></table></div></figure>


<h2>8. 排错思路</h2>

<ul>
<li><p>服务器端、客户端之间和本身的防火墙确认无问题；</p></li>
<li><p>服务器端的SELinux确认禁用；</p></li>
<li><p>证书确认是否正确配置正确，重新配置的过程如下：</p></li>
</ul>


<p> Puppet服务端：
 <code>
 # puppetd -r -c client01.domain.com
</code></p>

<p>Puppet客户端：</p>

<ul>
<li>Windows 2003：C:\Documents and Settings\All Users\Application Data\PuppetLabs\puppet\etc\ssl</li>
<li>Windows 2008：C:\ProgramData\PuppetLabs\puppet\etc\ssl</li>
<li>Linux 客户端: /var/lib/puppet/ssl</li>
</ul>

]]></content>
  </entry>
  
</feed>
